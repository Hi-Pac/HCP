<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام ERP - شركة الحرمين للدهانات الحديثة</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#6366F1',
                        accent: '#4F46E5',
                        background: {
                            light: '#FFFFFF',
                            dark: '#181818',
                        },
                        text: {
                            light: '#1F2937',
                            dark: '#F9FAFB',
                        }
                    },
                },
            },
            darkMode: 'class',
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap');
        
        * {
            font-family: 'Tajawal', sans-serif;
        }
        
        /* تحسينات لداتا تيبلز */
        .dataTables_wrapper .dataTables_length, 
        .dataTables_wrapper .dataTables_filter, 
        .dataTables_wrapper .dataTables_info, 
        .dataTables_wrapper .dataTables_processing, 
        .dataTables_wrapper .dataTables_paginate {
            margin-bottom: 1rem;
            direction: rtl;
        }
        
        .dataTables_wrapper .dataTables_filter input {
            margin-right: 0.5rem;
            margin-left: 0;
            min-height: 40px;
            font-size: 16px;
        }
        
        /* تخصيص المظهر للوضع الداكن */
        .dark .dataTables_wrapper .dataTables_length, 
        .dark .dataTables_wrapper .dataTables_filter, 
        .dark .dataTables_wrapper .dataTables_info, 
        .dark .dataTables_wrapper .dataTables_processing, 
        .dark .dataTables_wrapper .dataTables_paginate,
        .dark .dataTables_wrapper .dataTables_filter input {
            color: #F9FAFB;
        }
        
        .dark .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #4F46E5;
            color: white !important;
            border: none;
        }
        
        .dark table.dataTable tbody tr {
            background-color: #1F2937;
            color: #F9FAFB;
        }
        
        .dark table.dataTable.stripe tbody tr.odd {
            background-color: #111827;
        }
        
        .transition-all {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark min-h-screen transition-all">
    <!-- Firebase Config -->
    <script>
        // تكوين Firebase (سيتم تحديثه بمعلوماتك الخاصة)
       const firebaseConfig = {
          apiKey: "AIzaSyCpTjPsfaWTuNjpUupteqALjmb0qLUAzg8",
          authDomain: "delta-hcp.firebaseapp.com",
          projectId: "delta-hcp",
          storageBucket: "delta-hcp.firebasestorage.app",
          messagingSenderId: "956838180358",
          appId: "1:956838180358:web:af6abd7a430a8e17c83587",
          measurementId: "G-NJT5FCNJK3"
        };
        
        // تهيئة Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // متغيرات للتتبع
        let lastActivity = Date.now();
        let logoutTimer;
        const INACTIVE_TIMEOUT = 10 * 60 * 1000; // 10 دقائق بالميللي ثانية
        let currentUserRole = null;
        let currentUserPermissions = {};
        let currentUser = null;
        
        // تهيئة وضع الألوان
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        // استماع لتغييرات وضع الألوان
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
    
    <!-- قسم تسجيل الدخول -->
    <div id="login-container" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-primary">شركة الحرمين للدهانات الحديثة</h1>
                <p class="text-gray-600 dark:text-gray-300 mt-2">نظام إدارة موارد المؤسسة</p>
            </div>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">البريد الإلكتروني</label>
                    <input type="email" id="email" class="w-full px-4 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" required>
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">كلمة المرور</label>
                    <input type="password" id="password" class="w-full px-4 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" required>
                </div>
                
                <div id="login-error" class="text-red-500 text-sm hidden"></div>
                
                <button type="submit" class="w-full px-4 py-2 text-base font-medium text-white bg-primary rounded-md hover:bg-accent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent transition-all">
                    تسجيل الدخول
                </button>
            </form>
        </div>
    </div>
    
    <!-- القالب الرئيسي للتطبيق - مخفي حتى تسجيل الدخول -->
    <div id="app-container" class="hidden min-h-screen flex flex-col">
        <!-- الشريط العلوي -->
        <header class="bg-white dark:bg-gray-800 shadow-md">
            <div class="px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex justify-between items-center">
                    <h1 class="text-xl sm:text-2xl font-bold text-primary">شركة الحرمين للدهانات الحديثة</h1>
                    
                    <div class="flex items-center space-x-4 space-x-reverse">
                        <span id="user-name" class="hidden sm:block text-sm font-medium text-gray-700 dark:text-gray-200"></span>
                        
                        <button id="logout-button" class="px-3 py-1 text-sm text-white bg-red-500 rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all">
                            تسجيل الخروج
                        </button>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- القسم الرئيسي -->
        <div class="flex flex-col md:flex-row flex-grow">
            <!-- القائمة الجانبية -->
            <aside class="w-full md:w-64 bg-white dark:bg-gray-800 shadow-md flex flex-col">
                <nav class="flex flex-col p-4 space-y-2">
                    <button data-page="dashboard" class="nav-link px-4 py-3 rounded-md text-right hover:bg-gray-100 dark:hover:bg-gray-700 transition-all flex items-center space-x-2 space-x-reverse focus:outline-none active">
                        <i class="fas fa-tachometer-alt w-5 text-center"></i>
                        <span>لوحة التحكم</span>
                    </button>
                    
                    <button data-page="customers" class="nav-link px-4 py-3 rounded-md text-right hover:bg-gray-100 dark:hover:bg-gray-700 transition-all flex items-center space-x-2 space-x-reverse focus:outline-none">
                        <i class="fas fa-users w-5 text-center"></i>
                        <span>العملاء</span>
                    </button>
                    
                    <button data-page="products" class="nav-link px-4 py-3 rounded-md text-right hover:bg-gray-100 dark:hover:bg-gray-700 transition-all flex items-center space-x-2 space-x-reverse focus:outline-none">
                        <i class="fas fa-paint-roller w-5 text-center"></i>
                        <span>المنتجات</span>
                    </button>
                    
                    <button data-page="sales" class="nav-link px-4 py-3 rounded-md text-right hover:bg-gray-100 dark:hover:bg-gray-700 transition-all flex items-center space-x-2 space-x-reverse focus:outline-none">
                        <i class="fas fa-file-invoice-dollar w-5 text-center"></i>
                        <span>المبيعات</span>
                    </button>
                    
                    <button data-page="returns" class="nav-link px-4 py-3 rounded-md text-right hover:bg-gray-100 dark:hover:bg-gray-700 transition-all flex items-center space-x-2 space-x-reverse focus:outline-none">
                        <i class="fas fa-undo-alt w-5 text-center"></i>
                        <span>المرتجعات</span>
                    </button>
                    
                    <button data-page="accounts" class="nav-link px-4 py-3 rounded-md text-right hover:bg-gray-100 dark:hover:bg-gray-700 transition-all flex items-center space-x-2 space-x-reverse focus:outline-none">
                        <i class="fas fa-file-invoice w-5 text-center"></i>
                        <span>الحسابات</span>
                    </button>
                    
                    <button data-page="payments" class="nav-link px-4 py-3 rounded-md text-right hover:bg-gray-100 dark:hover:bg-gray-700 transition-all flex items-center space-x-2 space-x-reverse focus:outline-none">
                        <i class="fas fa-money-bill-wave w-5 text-center"></i>
                        <span>المدفوعات</span>
                    </button>
                    
                    <button data-page="users" class="nav-link px-4 py-3 rounded-md text-right hover:bg-gray-100 dark:hover:bg-gray-700 transition-all flex items-center space-x-2 space-x-reverse focus:outline-none admin-only hidden">
                        <i class="fas fa-user-shield w-5 text-center"></i>
                        <span>المستخدمين</span>
                    </button>
                </nav>
            </aside>
            
            <!-- المحتوى الرئيسي -->
            <main class="flex-grow p-4 sm:p-6 lg:p-8 bg-gray-50 dark:bg-gray-900 overflow-auto">
                <!-- وعاء لوحة التحكم -->
                <div id="dashboard-container" class="page-container">
                    <h2 class="text-2xl font-bold mb-6">لوحة التحكم</h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">إجمالي المبيعات</p>
                                    <h3 id="total-sales" class="text-2xl font-bold mt-1">0 ج.م</h3>
                                </div>
                                <div class="p-3 bg-blue-100 dark:bg-blue-900 rounded-full">
                                    <i class="fas fa-chart-line text-blue-500 dark:text-blue-300"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">العملاء النشطين</p>
                                    <h3 id="active-customers" class="text-2xl font-bold mt-1">0</h3>
                                </div>
                                <div class="p-3 bg-green-100 dark:bg-green-900 rounded-full">
                                    <i class="fas fa-users text-green-500 dark:text-green-300"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">إجمالي المرتجعات</p>
                                    <h3 id="total-returns" class="text-2xl font-bold mt-1">0 ج.م</h3>
                                </div>
                                <div class="p-3 bg-red-100 dark:bg-red-900 rounded-full">
                                    <i class="fas fa-undo-alt text-red-500 dark:text-red-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                            <h4 class="text-lg font-semibold mb-4">مبيعات آخر 7 أيام</h4>
                            <div class="h-80">
                                <canvas id="sales-chart"></canvas>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                            <h4 class="text-lg font-semibold mb-4">أكثر المنتجات مبيعاً</h4>
                            <div class="h-80">
                                <canvas id="products-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- وعاء العملاء -->
                <div id="customers-container" class="page-container hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                        <h2 class="text-2xl font-bold">العملاء</h2>
                        <button id="add-customer-btn" class="mt-4 sm:mt-0 px-4 py-2 bg-primary text-white rounded hover:bg-accent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent transition-all">
                            <i class="fas fa-plus me-2"></i> إضافة عميل جديد
                        </button>
                    </div>
                    
                    <div class="overflow-hidden bg-white dark:bg-gray-800 shadow-md rounded-lg">
                        <div class="p-4">
                            <table id="customers-table" class="w-full">
                                <thead>
                                    <tr>
                                        <th>الرقم</th>
                                        <th>الاسم</th>
                                        <th>رقم الهاتف</th>
                                        <th>العنوان</th>
                                        <th>التصنيف</th>
                                        <th>الخصم (%)</th>
                                        <th>الرصيد</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- وعاء المنتجات -->
                <div id="products-container" class="page-container hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                        <h2 class="text-2xl font-bold">المنتجات</h2>
                        <button id="add-product-btn" class="mt-4 sm:mt-0 px-4 py-2 bg-primary text-white rounded hover:bg-accent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent transition-all">
                            <i class="fas fa-plus me-2"></i> إضافة منتج جديد
                        </button>
                    </div>
                    
                    <div class="overflow-hidden bg-white dark:bg-gray-800 shadow-md rounded-lg">
                        <div class="p-4">
                            <table id="products-table" class="w-full">
                                <thead>
                                    <tr>
                                        <th>الرقم</th>
                                        <th>التصنيف</th>
                                        <th>اسم المنتج</th>
                                        <th>اللون/الباتش</th>
                                        <th>السعر</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- وعاء المبيعات -->
                <div id="sales-container" class="page-container hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                        <h2 class="text-2xl font-bold">المبيعات</h2>
                        <button id="add-sale-btn" class="mt-4 sm:mt-0 px-4 py-2 bg-primary text-white rounded hover:bg-accent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent transition-all">
                            <i class="fas fa-plus me-2"></i> إنشاء فاتورة جديدة
                        </button>
                    </div>
                    
                    <div class="overflow-hidden bg-white dark:bg-gray-800 shadow-md rounded-lg">
                        <div class="p-4">
                            <table id="sales-table" class="w-full">
                                <thead>
                                    <tr>
                                        <th>رقم الفاتورة</th>
                                        <th>التاريخ</th>
                                        <th>العميل</th>
                                        <th>المبلغ قبل الخصم</th>
                                        <th>الخصم</th>
                                        <th>المبلغ بعد الخصم</th>
                                        <th>العربون</th>
                                        <th>طريقة الدفع</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- وعاء المرتجعات -->
                <div id="returns-container" class="page-container hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                        <h2 class="text-2xl font-bold">المرتجعات</h2>
                        <button id="add-return-btn" class="mt-4 sm:mt-0 px-4 py-2 bg-primary text-white rounded hover:bg-accent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent transition-all">
                            <i class="fas fa-plus me-2"></i> إنشاء فاتورة مرتجع
                        </button>
                    </div>
                    
                    <div class="overflow-hidden bg-white dark:bg-gray-800 shadow-md rounded-lg">
                        <div class="p-4">
                            <table id="returns-table" class="w-full">
                                <thead>
                                    <tr>
                                        <th>رقم الفاتورة</th>
                                        <th>التاريخ</th>
                                        <th>رقم فاتورة المبيعات</th>
                                        <th>العميل</th>
                                        <th>المبلغ المسترد</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- وعاء الحسابات -->
                <div id="accounts-container" class="page-container hidden">
                    <h2 class="text-2xl font-bold mb-6">حسابات العملاء</h2>
                    
                    <div class="overflow-hidden bg-white dark:bg-gray-800 shadow-md rounded-lg">
                        <div class="p-4">
                            <table id="accounts-table" class="w-full">
                                <thead>
                                    <tr>
                                        <th>الرقم</th>
                                        <th>العميل</th>
                                        <th>الرصيد</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- وعاء المدفوعات -->
                <div id="payments-container" class="page-container hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                        <h2 class="text-2xl font-bold">المدفوعات</h2>
                        <button id="add-payment-btn" class="mt-4 sm:mt-0 px-4 py-2 bg-primary text-white rounded hover:bg-accent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent transition-all">
                            <i class="fas fa-plus me-2"></i> إضافة سداد جديد
                        </button>
                    </div>
                    
                    <div class="overflow-hidden bg-white dark:bg-gray-800 shadow-md rounded-lg">
                        <div class="p-4">
                            <table id="payments-table" class="w-full">
                                <thead>
                                    <tr>
                                        <th>الرقم</th>
                                        <th>التاريخ</th>
                                        <th>العميل</th>
                                        <th>المبلغ</th>
                                        <th>طريقة الدفع</th>
                                        <th>الملاحظات</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- وعاء المستخدمين (للمدير فقط) -->
                <div id="users-container" class="page-container hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                        <h2 class="text-2xl font-bold">المستخدمين</h2>
                        <button id="add-user-btn" class="mt-4 sm:mt-0 px-4 py-2 bg-primary text-white rounded hover:bg-accent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent transition-all">
                            <i class="fas fa-plus me-2"></i> إضافة مستخدم جديد
                        </button>
                    </div>
                    
                    <div class="overflow-hidden bg-white dark:bg-gray-800 shadow-md rounded-lg">
                        <div class="p-4">
                            <table id="users-table" class="w-full">
                                <thead>
                                    <tr>
                                        <th>الرقم</th>
                                        <th>الاسم</th>
                                        <th>البريد الإلكتروني</th>
                                        <th>الدور</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- نماذج الإضافة والتعديل -->
    
    <!-- نموذج العميل -->
    <div id="customer-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="bg-white dark:bg-gray-800 max-w-lg mx-auto mt-16 rounded-lg shadow-lg overflow-hidden w-11/12">
            <div class="p-6">
                <h3 id="customer-modal-title" class="text-xl font-bold mb-4">إضافة عميل جديد</h3>
                
                <form id="customer-form" class="space-y-4">
                    <input type="hidden" id="customer-id">
                    
                    <div>
                        <label for="customer-name" class="block text-sm font-medium mb-1">اسم العميل</label>
                        <input type="text" id="customer-name" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" required>
                    </div>
                    
                    <div>
                        <label for="customer-phone" class="block text-sm font-medium mb-1">رقم الهاتف</label>
                        <input type="tel" id="customer-phone" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" required>
                    </div>
                    
                    <div>
                        <label for="customer-address" class="block text-sm font-medium mb-1">العنوان</label>
                        <input type="text" id="customer-address" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" required>
                    </div>
                    
                    <div>
                        <label for="customer-type" class="block text-sm font-medium mb-1">التصنيف</label>
                        <select id="customer-type" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white">
                            <option value="هيئات/مشاريع">هيئات/مشاريع</option>
                            <option value="محلات">محلات</option>
                            <option value="اهالى">اهالى</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="customer-discount" class="block text-sm font-medium mb-1">نسبة الخصم (%)</label>
                        <input type="number" id="customer-discount" min="0" max="100" step="0.01" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" value="0">
                    </div>
                    
                    <div class="flex justify-end space-x-3 space-x-reverse pt-4">
                        <button type="button" id="customer-modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 focus:outline-none transition-all">
                            إلغاء
                        </button>
                        <button type="submit" class="px-4 py-2 bg-primary text-white rounded hover:bg-accent focus:outline-none transition-all">
                            حفظ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- نموذج المنتج -->
    <div id="product-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="bg-white dark:bg-gray-800 max-w-lg mx-auto mt-16 rounded-lg shadow-lg overflow-hidden w-11/12">
            <div class="p-6">
                <h3 id="product-modal-title" class="text-xl font-bold mb-4">إضافة منتج جديد</h3>
                
                <form id="product-form" class="space-y-4">
                    <input type="hidden" id="product-id">
                    
                    <div>
                        <label for="product-category" class="block text-sm font-medium mb-1">تصنيف المنتج</label>
                        <select id="product-category" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" required>
                            <option value="انشائى">انشائى</option>
                            <option value="واجهات خارجية">واجهات خارجية</option>
                            <option value="ديكورى">ديكورى</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="product-name" class="block text-sm font-medium mb-1">اسم المنتج</label>
                        <input type="text" id="product-name" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" required>
                    </div>
                    
                    <div>
                        <label for="product-batch" class="block text-sm font-medium mb-1">اللون/الباتش</label>
                        <input type="text" id="product-batch" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" required>
                    </div>
                    
                    <div>
                        <label for="product-price" class="block text-sm font-medium mb-1">السعر</label>
                        <input type="number" id="product-price" min="0" step="0.01" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" required>
                    </div>
                    
                    <div class="flex justify-end space-x-3 space-x-reverse pt-4">
                        <button type="button" id="product-modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 focus:outline-none transition-all">
                            إلغاء
                        </button>
                        <button type="submit" class="px-4 py-2 bg-primary text-white rounded hover:bg-accent focus:outline-none transition-all">
                            حفظ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- نموذج المبيعات -->
    <div id="sale-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="bg-white dark:bg-gray-800 max-w-3xl mx-auto mt-8 rounded-lg shadow-lg overflow-hidden w-11/12 max-h-5/6 overflow-y-auto">
            <div class="p-6">
                <h3 id="sale-modal-title" class="text-xl font-bold mb-4">إنشاء فاتورة جديدة</h3>
                
                <form id="sale-form" class="space-y-4">
                    <input type="hidden" id="sale-id">
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="sale-number" class="block text-sm font-medium mb-1">رقم الفاتورة</label>
                            <input type="text" id="sale-number" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                        
                        <div>
                            <label for="sale-date" class="block text-sm font-medium mb-1">التاريخ</label>
                            <input type="date" id="sale-date" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" required>
                        </div>
                    </div>
                    
                    <div>
                        <label for="sale-customer" class="block text-sm font-medium mb-1">العميل</label>
                        <select id="sale-customer" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" required>
                            <option value="">-- اختر العميل --</option>
                        </select>
                    </div>
                    
                    <div class="border dark:border-gray-600 rounded-lg p-4">
                        <h4 class="font-semibold mb-4">المنتجات</h4>
                        
                        <div id="sale-products-container">
                            <!-- نموذج للمنتجات -->
                            <div class="product-item grid grid-cols-12 gap-2 mb-4">
                                <div class="col-span-3">
                                    <select class="product-category w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white">
                                        <option value="">-- التصنيف --</option>
                                        <option value="انشائى">انشائى</option>
                                        <option value="واجهات خارجية">واجهات خارجية</option>
                                        <option value="ديكورى">ديكورى</option>
                                    </select>
                                </div>
                                
                                <div class="col-span-3">
                                    <select class="product-name w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" disabled>
                                        <option value="">-- المنتج --</option>
                                    </select>
                                </div>
                                
                                <div class="col-span-2">
                                    <select class="product-batch w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" disabled>
                                        <option value="">-- الباتش --</option>
                                    </select>
                                </div>
                                
                                <div class="col-span-1">
                                    <input type="number" min="1" class="product-quantity w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" placeholder="الكمية" disabled>
                                </div>
                                
                                <div class="col-span-1">
                                    <input type="number" min="0" step="0.01" class="product-price w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" placeholder="السعر" readonly>
                                </div>
                                
                                <div class="col-span-1">
                                    <input type="number" min="0" step="0.01" class="product-total w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" placeholder="الإجمالي" readonly>
                                </div>
                                
                                <div class="col-span-1 flex items-center justify-center">
                                    <button type="button" class="delete-product-btn text-red-500 hover:text-red-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button type="button" id="add-product-row-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 focus:outline-none transition-all">
                                <i class="fas fa-plus"></i> إضافة منتج
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="sale-subtotal" class="block text-sm font-medium mb-1">المبلغ قبل الخصم</label>
                            <input type="number" id="sale-subtotal" min="0" step="0.01" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                        
                        <div>
                            <label for="sale-discount" class="block text-sm font-medium mb-1">الخصم (%)</label>
                            <input type="number" id="sale-discount" min="0" max="100" step="0.01" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" value="0">
                        </div>
                    </div>
                    
                    <div>
                        <label for="sale-payment-method" class="block text-sm font-medium mb-1">طريقة الدفع</label>
                        <select id="sale-payment-method" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" required>
                            <option value="نقدى">نقدى</option>
                            <option value="فودافون كاش">فودافون كاش</option>
                            <option value="تحويل بنك">تحويل بنك</option>
                            <option value="شيك">شيك</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="sale-notes" class="block text-sm font-medium mb-1">ملاحظات</label>
                        <textarea id="sale-notes" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" rows="3"></textarea>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="has-deposit" class="w-5 h-5 text-primary focus:ring-accent">
                        <label for="has-deposit" class="mr-2 block text-sm">مبلغ عربون للحجز</label>
                    </div>
                    
                    <div id="deposit-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 hidden">
                        <div>
                            <label for="sale-deposit" class="block text-sm font-medium mb-1">قيمة العربون</label>
                            <input type="number" id="sale-deposit" min="0" step="0.01" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" value="0">
                        </div>
                        
                        <div>
                            <label for="deposit-payment-method" class="block text-sm font-medium mb-1">طريقة دفع العربون</label>
                            <select id="deposit-payment-method" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white">
                                <option value="نقدى">نقدى</option>
                                <option value="فودافون كاش">فودافون كاش</option>
                                <option value="تحويل بنك">تحويل بنك</option>
                                <option value="شيك">شيك</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label for="sale-total" class="block text-sm font-medium mb-1">المبلغ بعد الخصم</label>
                        <input type="number" id="sale-total" min="0" step="0.01" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                    
                    <div class="flex justify-end space-x-3 space-x-reverse pt-4">
                        <button type="button" id="sale-modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 focus:outline-none transition-all">
                            إلغاء
                        </button>
                        <button type="submit" class="px-4 py-2 bg-primary text-white rounded hover:bg-accent focus:outline-none transition-all">
                            حفظ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- نموذج المرتجعات -->
    <div id="return-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="bg-white dark:bg-gray-800 max-w-3xl mx-auto mt-16 rounded-lg shadow-lg overflow-hidden w-11/12">
            <div class="p-6">
                <h3 id="return-modal-title" class="text-xl font-bold mb-4">إنشاء فاتورة مرتجع</h3>
                
                <form id="return-form" class="space-y-4">
                    <input type="hidden" id="return-id">
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="return-number" class="block text-sm font-medium mb-1">رقم المرتجع</label>
                            <input type="text" id="return-number" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                        
                        <div>
                            <label for="return-date" class="block text-sm font-medium mb-1">التاريخ</label>
                            <input type="date" id="return-date" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" required>
                        </div>
                    </div>
                    
                    <div>
                        <label for="return-sale" class="block text-sm font-medium mb-1">فاتورة المبيعات</label>
                        <select id="return-sale" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" required>
                            <option value="">-- اختر فاتورة --</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="return-customer" class="block text-sm font-medium mb-1">العميل</label>
                        <input type="text" id="return-customer" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                    
                    <div class="border dark:border-gray-600 rounded-lg p-4">
                        <h4 class="font-semibold mb-4">المنتجات المرتجعة</h4>
                        
                        <div id="return-products-container">
                            <!-- سيتم ملء هذا بالمنتجات من فاتورة المبيعات المختارة -->
                        </div>
                    </div>
                    
                    <div>
                        <label for="return-amount" class="block text-sm font-medium mb-1">المبلغ المسترد</label>
                        <input type="number" id="return-amount" min="0" step="0.01" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                    
                    <div>
                        <label for="return-notes" class="block text-sm font-medium mb-1">ملاحظات</label>
                        <textarea id="return-notes" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" rows="3"></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3 space-x-reverse pt-4">
                        <button type="button" id="return-modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 focus:outline-none transition-all">
                            إلغاء
                        </button>
                        <button type="submit" class="px-4 py-2 bg-primary text-white rounded hover:bg-accent focus:outline-none transition-all">
                            حفظ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- نموذج المدفوعات -->
    <div id="payment-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="bg-white dark:bg-gray-800 max-w-lg mx-auto mt-16 rounded-lg shadow-lg overflow-hidden w-11/12">
            <div class="p-6">
                <h3 id="payment-modal-title" class="text-xl font-bold mb-4">إضافة سداد جديد</h3>
                
                <form id="payment-form" class="space-y-4">
                    <input type="hidden" id="payment-id">
                    
                    <div>
                        <label for="payment-number" class="block text-sm font-medium mb-1">رقم السداد</label>
                        <input type="text" id="payment-number" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" readonly>
                    </div>
                    
                    <div>
                        <label for="payment-date" class="block text-sm font-medium mb-1">التاريخ</label>
                        <input type="date" id="payment-date" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" required>
                    </div>
                    
                    <div>
                        <label for="payment-customer" class="block text-sm font-medium mb-1">العميل</label>
                        <select id="payment-customer" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" required>
                            <option value="">-- اختر العميل --</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="customer-balance" class="block text-sm font-medium mb-1">رصيد العميل</label>
                            <input type="number" id="customer-balance" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                        
                        <div>
                            <label for="payment-amount" class="block text-sm font-medium mb-1">مبلغ السداد</label>
                            <input type="number" id="payment-amount" min="0" step="0.01" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" required>
                        </div>
                    </div>
                    
                    <div>
                        <label for="payment-method" class="block text-sm font-medium mb-1">طريقة الدفع</label>
                        <select id="payment-method" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" required>
                            <option value="نقدى">نقدى</option>
                            <option value="فودافون كاش">فودافون كاش</option>
                            <option value="تحويل بنك">تحويل بنك</option>
                            <option value="شيك">شيك</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="payment-notes" class="block text-sm font-medium mb-1">ملاحظات</label>
                        <textarea id="payment-notes" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" rows="3"></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3 space-x-reverse pt-4">
                        <button type="button" id="payment-modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 focus:outline-none transition-all">
                            إلغاء
                        </button>
                        <button type="submit" class="px-4 py-2 bg-primary text-white rounded hover:bg-accent focus:outline-none transition-all">
                            حفظ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- نموذج المستخدم -->
    <div id="user-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="bg-white dark:bg-gray-800 max-w-lg mx-auto mt-16 rounded-lg shadow-lg overflow-hidden w-11/12">
            <div class="p-6">
                <h3 id="user-modal-title" class="text-xl font-bold mb-4">إضافة مستخدم جديد</h3>
                
                <form id="user-form" class="space-y-4">
                    <input type="hidden" id="user-id">
                    
                    <div>
                        <label for="user-name" class="block text-sm font-medium mb-1">اسم المستخدم</label>
                        <input type="text" id="user-name" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" required>
                    </div>
                    
                    <div>
                        <label for="user-email" class="block text-sm font-medium mb-1">البريد الإلكتروني</label>
                        <input type="email" id="user-email" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" required>
                    </div>
                    
                    <div id="password-container">
                        <label for="user-password" class="block text-sm font-medium mb-1">كلمة المرور</label>
                        <input type="password" id="user-password" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" minlength="6" required>
                    </div>
                    
                    <div>
                        <label for="user-role" class="block text-sm font-medium mb-1">الدور</label>
                        <select id="user-role" class="w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white">
                            <option value="admin">مدير</option>
                            <option value="user">مستخدم</option>
                        </select>
                    </div>
                    
                    <div id="permissions-container" class="border dark:border-gray-600 rounded-lg p-4 hidden">
                        <h4 class="font-semibold mb-4">الصلاحيات</h4>
                        
                        <div class="space-y-2">
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" class="permission-checkbox w-5 h-5 text-primary focus:ring-accent" data-module="customers" data-permission="view">
                                    <span class="mr-2 text-sm">عرض العملاء</span>
                                </label>
                            </div>
                            
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" class="permission-checkbox w-5 h-5 text-primary focus:ring-accent" data-module="customers" data-permission="add">
                                    <span class="mr-2 text-sm">إضافة العملاء</span>
                                </label>
                            </div>
                            
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" class="permission-checkbox w-5 h-5 text-primary focus:ring-accent" data-module="customers" data-permission="edit">
                                    <span class="mr-2 text-sm">تعديل العملاء</span>
                                </label>
                            </div>
                            
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" class="permission-checkbox w-5 h-5 text-primary focus:ring-accent" data-module="customers" data-permission="delete">
                                    <span class="mr-2 text-sm">حذف العملاء</span>
                                </label>
                            </div>
                            
                            <!-- المزيد من الصلاحيات لكل وحدة -->
                            <div class="border-t dark:border-gray-600 my-2 pt-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="permission-checkbox w-5 h-5 text-primary focus:ring-accent" data-module="products" data-permission="view">
                                    <span class="mr-2 text-sm">عرض المنتجات</span>
                                </label>
                            </div>
                            
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" class="permission-checkbox w-5 h-5 text-primary focus:ring-accent" data-module="products" data-permission="add">
                                    <span class="mr-2 text-sm">إضافة المنتجات</span>
                                </label>
                            </div>
                            
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" class="permission-checkbox w-5 h-5 text-primary focus:ring-accent" data-module="products" data-permission="edit">
                                    <span class="mr-2 text-sm">تعديل المنتجات</span>
                                </label>
                            </div>
                            
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" class="permission-checkbox w-5 h-5 text-primary focus:ring-accent" data-module="products" data-permission="delete">
                                    <span class="mr-2 text-sm">حذف المنتجات</span>
                                </label>
                            </div>
                            
                            <div class="border-t dark:border-gray-600 my-2 pt-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="permission-checkbox w-5 h-5 text-primary focus:ring-accent" data-module="sales" data-permission="view">
                                    <span class="mr-2 text-sm">عرض المبيعات</span>
                                </label>
                            </div>
                            
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" class="permission-checkbox w-5 h-5 text-primary focus:ring-accent" data-module="sales" data-permission="add">
                                    <span class="mr-2 text-sm">إضافة المبيعات</span>
                                </label>
                            </div>
                            
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" class="permission-checkbox w-5 h-5 text-primary focus:ring-accent" data-module="sales" data-permission="edit">
                                    <span class="mr-2 text-sm">تعديل المبيعات</span>
                                </label>
                            </div>
                            
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" class="permission-checkbox w-5 h-5 text-primary focus:ring-accent" data-module="sales" data-permission="delete">
                                    <span class="mr-2 text-sm">حذف المبيعات</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 space-x-reverse pt-4">
                        <button type="button" id="user-modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 focus:outline-none transition-all">
                            إلغاء
                        </button>
                        <button type="submit" class="px-4 py-2 bg-primary text-white rounded hover:bg-accent focus:outline-none transition-all">
                            حفظ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- نموذج عرض تفاصيل الحساب -->
    <div id="account-details-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="bg-white dark:bg-gray-800 max-w-4xl mx-auto mt-16 rounded-lg shadow-lg overflow-hidden w-11/12">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="account-details-title" class="text-xl font-bold">تفاصيل حساب: <span id="account-customer-name"></span></h3>
                    
                    <div class="flex space-x-2 space-x-reverse">
                        <button id="print-account-btn" class="px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 focus:outline-none transition-all flex items-center">
                            <i class="fas fa-print mr-1"></i> طباعة
                        </button>
                        
                        <button id="export-account-btn" class="px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 focus:outline-none transition-all flex items-center">
                            <i class="fas fa-file-pdf mr-1"></i> تصدير PDF
                        </button>
                        
                        <button id="account-details-close" class="px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 focus:outline-none transition-all">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded">
                        <p class="text-sm text-gray-500 dark:text-gray-400">إجمالي الرصيد</p>
                        <p id="account-balance" class="text-xl font-bold mt-1">0 ج.م</p>
                    </div>
                    
                    <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded">
                        <p class="text-sm text-gray-500 dark:text-gray-400">الفواتير المستحقة</p>
                        <p id="account-due-invoices" class="text-xl font-bold mt-1">0</p>
                    </div>
                </div>
                
                <div class="overflow-hidden bg-white dark:bg-gray-900 rounded-lg border dark:border-gray-700">
                    <div class="p-4">
                        <table id="account-transactions-table" class="w-full">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>رقم المستند</th>
                                    <th>نوع المعاملة</th>
                                    <th>مدين</th>
                                    <th>دائن</th>
                                    <th>الرصيد</th>
                                    <th>ملاحظات</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- نموذج عرض تفاصيل الفاتورة -->
    <div id="invoice-details-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="bg-white dark:bg-gray-800 max-w-4xl mx-auto mt-16 rounded-lg shadow-lg overflow-hidden w-11/12">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="invoice-details-title" class="text-xl font-bold">تفاصيل الفاتورة: <span id="invoice-number-display"></span></h3>
                    
                    <div class="flex space-x-2 space-x-reverse">
                        <button id="print-invoice-btn" class="px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 focus:outline-none transition-all flex items-center">
                            <i class="fas fa-print mr-1"></i> طباعة
                        </button>
                        
                        <button id="export-invoice-btn" class="px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 focus:outline-none transition-all flex items-center">
                            <i class="fas fa-file-pdf mr-1"></i> تصدير PDF
                        </button>
                        
                        <button id="invoice-details-close" class="px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 focus:outline-none transition-all">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <div class="mb-4">
                            <p class="text-sm text-gray-500 dark:text-gray-400">التاريخ</p>
                            <p id="invoice-date-display" class="font-medium"></p>
                        </div>
                        
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">العميل</p>
                            <p id="invoice-customer-display" class="font-medium"></p>
                        </div>
                    </div>
                    
                    <div>
                        <div class="mb-4">
                            <p class="text-sm text-gray-500 dark:text-gray-400">طريقة الدفع</p>
                            <p id="invoice-payment-method-display" class="font-medium"></p>
                        </div>
                        
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">ملاحظات</p>
                            <p id="invoice-notes-display" class="font-medium"></p>
                        </div>
                    </div>
                </div>
                
                <div class="border dark:border-gray-700 rounded-lg overflow-hidden mb-6">
                    <table class="w-full">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th class="px-4 py-2 text-right">المنتج</th>
                                <th class="px-4 py-2 text-right">الباتش/اللون</th>
                                <th class="px-4 py-2 text-right">الكمية</th>
                                <th class="px-4 py-2 text-right">السعر</th>
                                <th class="px-4 py-2 text-right">الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-items"></tbody>
                    </table>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div></div>
                    <div class="space-y-2">
                        <div class="flex justify-between border-b dark:border-gray-700 pb-2">
                            <span>المبلغ قبل الخصم:</span>
                            <span id="invoice-subtotal-display" class="font-medium"></span>
                        </div>
                        
                        <div class="flex justify-between border-b dark:border-gray-700 pb-2">
                            <span>الخصم:</span>
                            <span id="invoice-discount-display" class="font-medium"></span>
                        </div>
                        
                        <div id="invoice-deposit-container" class="flex justify-between border-b dark:border-gray-700 pb-2 hidden">
                            <span>العربون (<span id="invoice-deposit-method-display"></span>):</span>
                            <span id="invoice-deposit-display" class="font-medium"></span>
                        </div>
                        
                        <div class="flex justify-between text-lg font-bold">
                            <span>المبلغ النهائي:</span>
                            <span id="invoice-total-display"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- نموذج حذف العنصر -->
    <div id="delete-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="bg-white dark:bg-gray-800 max-w-md mx-auto mt-16 rounded-lg shadow-lg overflow-hidden w-11/12">
            <div class="p-6">
                <h3 class="text-xl font-bold mb-4">تأكيد الحذف</h3>
                
                <p id="delete-message" class="mb-6">هل أنت متأكد من أنك تريد حذف هذا العنصر؟</p>
                
                <div class="flex justify-end space-x-3 space-x-reverse">
                    <button id="delete-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 focus:outline-none transition-all">
                        إلغاء
                    </button>
                    <button id="delete-confirm" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 focus:outline-none transition-all">
                        حذف
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- النصوص البرمجية الرئيسية -->
    <script>
        // تتبع النشاط لتسجيل الخروج التلقائي
        function resetInactivityTimer() {
            lastActivity = Date.now();
            clearTimeout(logoutTimer);
            logoutTimer = setTimeout(autoLogout, INACTIVE_TIMEOUT);
        }
        
        function autoLogout() {
            auth.signOut().then(() => {
                showLoginForm();
                alert("تم تسجيل خروجك تلقائيًا بسبب عدم النشاط.");
            });
        }
        
        // إضافة مستمعي أحداث للنشاط
        ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, resetInactivityTimer, true);
        });
        
        // وظائف المصادقة
        function showLoginForm() {
            document.getElementById('login-container').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
        }
        
        function showAppContainer() {
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            resetInactivityTimer();
        }
        
        function setupAuth() {
            const loginForm = document.getElementById('login-form');
            
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const errorElement = document.getElementById('login-error');
                
                try {
                    errorElement.classList.add('hidden');
                    await auth.signInWithEmailAndPassword(email, password);
                    // سيتم التعامل مع تغيير حالة المستخدم في مستمع حالة المصادقة
                } catch (error) {
                    errorElement.textContent = getAuthErrorMessage(error.code);
                    errorElement.classList.remove('hidden');
                }
            });
            
            // مستمع تسجيل الخروج
            document.getElementById('logout-button').addEventListener('click', () => {
                auth.signOut();
            });
            
            // مراقبة حالة المصادقة
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('user-name').textContent = user.displayName || user.email;
                    
                    // التحقق من الصلاحيات
                    try {
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            currentUserRole = userData.role || 'user';
                            currentUserPermissions = userData.permissions || {};
                            
                            // إظهار/إخفاء عناصر القائمة بناءً على الصلاحيات
                            if (currentUserRole === 'admin') {
                                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
                            } else {
                                document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
                            }
                        }
                    } catch (error) {
                        console.error("Error fetching user permissions:", error);
                    }
                    
                    showAppContainer();
                    loadDashboardData();
                } else {
                    showLoginForm();
                    clearTimeout(logoutTimer);
                }
            });
        }
        
        function getAuthErrorMessage(errorCode) {
            switch(errorCode) {
                case 'auth/invalid-email':
                    return 'البريد الإلكتروني غير صحيح.';
                case 'auth/user-disabled':
                    return 'تم تعطيل حساب المستخدم هذا.';
                case 'auth/user-not-found':
                    return 'لا يوجد مستخدم بهذا البريد الإلكتروني.';
                case 'auth/wrong-password':
                    return 'كلمة المرور غير صحيحة.';
                default:
                    return 'حدث خطأ أثناء تسجيل الدخول.';
            }
        }
        
        // التنقل
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const pageContainers = document.querySelectorAll('.page-container');
            
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const targetPage = link.getAttribute('data-page');
                    
                    // تحديث الروابط النشطة
                    navLinks.forEach(l => l.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'active'));
                    link.classList.add('bg-gray-100', 'dark:bg-gray-700', 'active');
                    
                    // إخفاء جميع الصفحات
                    pageContainers.forEach(container => container.classList.add('hidden'));
                    
                    // إظهار الصفحة المستهدفة
                    const targetContainer = document.getElementById(`${targetPage}-container`);
                    if (targetContainer) {
                        targetContainer.classList.remove('hidden');
                        
                        // تحميل البيانات حسب الصفحة المختارة
                        switch(targetPage) {
                            case 'dashboard':
                                loadDashboardData();
                                break;
                            case 'customers':
                                loadCustomersData();
                                break;
                            case 'products':
                                loadProductsData();
                                break;
                            case 'sales':
                                loadSalesData();
                                break;
                            case 'returns':
                                loadReturnsData();
                                break;
                            case 'accounts':
                                loadAccountsData();
                                break;
                            case 'payments':
                                loadPaymentsData();
                                break;
                            case 'users':
                                loadUsersData();
                                break;
                        }
                    }
                });
            });
        }
        
        // تهيئة الجداول
        function initializeDataTables() {
            // تهيئة جدول العملاء
            $('#customers-table').DataTable({
                responsive: true,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json',
                },
                columns: [
                    { data: 'id' },
                    { data: 'name' },
                    { data: 'phone' },
                    { data: 'address' },
                    { data: 'type' },
                    { data: 'discount' },
                    { data: 'balance' },
                    { 
                        data: null,
                        render: function(data, type, row) {
                            return `
                                <div class="flex space-x-1 space-x-reverse">
                                    <button class="edit-customer text-blue-500 hover:text-blue-700" data-id="${row.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="delete-customer text-red-500 hover:text-red-700" data-id="${row.id}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            `;
                        }
                    }
                ]
            });
            
            // تهيئة جدول المنتجات
            $('#products-table').DataTable({
                responsive: true,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json',
                },
                columns: [
                    { data: 'id' },
                    { data: 'category' },
                    { data: 'name' },
                    { data: 'batch' },
                    { data: 'price' },
                    { 
                        data: null,
                        render: function(data, type, row) {
                            return `
                                <div class="flex space-x-1 space-x-reverse">
                                    <button class="edit-product text-blue-500 hover:text-blue-700" data-id="${row.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="delete-product text-red-500 hover:text-red-700" data-id="${row.id}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            `;
                        }
                    }
                ]
            });
            
            // تهيئة جدول المبيعات
            $('#sales-table').DataTable({
                responsive: true,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json',
                },
                columns: [
                    { data: 'number' },
                    { data: 'date' },
                    { data: 'customer' },
                    { data: 'subtotal' },
                    { data: 'discount' },
                    { data: 'total' },
                    { data: 'deposit' },
                    { data: 'paymentMethod' },
                    { 
                        data: null,
                        render: function(data, type, row) {
                            return `
                                <div class="flex space-x-1 space-x-reverse">
                                    <button class="view-sale text-green-500 hover:text-green-700" data-id="${row.id}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="edit-sale text-blue-500 hover:text-blue-700" data-id="${row.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="delete-sale text-red-500 hover:text-red-700" data-id="${row.id}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            `;
                        }
                    }
                ]
            });
            
            // تهيئة جدول المرتجعات
            $('#returns-table').DataTable({
                responsive: true,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json',
                },
                columns: [
                    { data: 'number' },
                    { data: 'date' },
                    { data: 'saleNumber' },
                    { data: 'customer' },
                    { data: 'amount' },
                    { 
                        data: null,
                        render: function(data, type, row) {
                            return `
                                <div class="flex space-x-1 space-x-reverse">
                                    <button class="view-return text-green-500 hover:text-green-700" data-id="${row.id}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="delete-return text-red-500 hover:text-red-700" data-id="${row.id}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            `;
                        }
                    }
                ]
            });
            
            // تهيئة جدول الحسابات
            $('#accounts-table').DataTable({
                responsive: true,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json',
                },
                columns: [
                    { data: 'id' },
                    { data: 'customer' },
                    { data: 'balance' },
                    { 
                        data: null,
                        render: function(data, type, row) {
                            return `
                                <div class="flex space-x-1 space-x-reverse">
                                    <button class="view-account text-green-500 hover:text-green-700" data-id="${row.id}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            `;
                        }
                    }
                ]
            });
            
            // تهيئة جدول المدفوعات
            $('#payments-table').DataTable({
                responsive: true,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json',
                },
                columns: [
                    { data: 'number' },
                    { data: 'date' },
                    { data: 'customer' },
                    { data: 'amount' },
                    { data: 'paymentMethod' },
                    { data: 'notes' },
                    { 
                        data: null,
                        render: function(data, type, row) {
                            return `
                                <div class="flex space-x-1 space-x-reverse">
                                    <button class="edit-payment text-blue-500 hover:text-blue-700" data-id="${row.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="delete-payment text-red-500 hover:text-red-700" data-id="${row.id}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            `;
                        }
                    }
                ]
            });
            
            // تهيئة جدول المستخدمين
            $('#users-table').DataTable({
                responsive: true,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json',
                },
                columns: [
                    { data: 'id' },
                    { data: 'name' },
                    { data: 'email' },
                    { data: 'role' },
                    { data: 'status' },
                    { 
                        data: null,
                        render: function(data, type, row) {
                            return `
                                <div class="flex space-x-1 space-x-reverse">
                                    <button class="edit-user text-blue-500 hover:text-blue-700" data-id="${row.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="delete-user text-red-500 hover:text-red-700" data-id="${row.id}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            `;
                        }
                    }
                ]
            });
            
            // تهيئة جدول تفاصيل الحساب
            $('#account-transactions-table').DataTable({
                responsive: true,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json',
                },
                order: [[0, 'desc']],
                columns: [
                    { data: 'date' },
                    { data: 'documentNumber' },
                    { data: 'type' },
                    { data: 'debit' },
                    { data: 'credit' },
                    { data: 'balance' },
                    { data: 'notes' }
                ]
            });
        }
        
        // تحميل بيانات لوحة التحكم
        async function loadDashboardData() {
            try {
                // إحصائيات إجمالي المبيعات
                const salesQuery = await db.collection('sales').get();
                let totalSales = 0;
                salesQuery.forEach(doc => {
                    const sale = doc.data();
                    totalSales += parseFloat(sale.total || 0);
                });
                document.getElementById('total-sales').textContent = formatCurrency(totalSales);
                
                // إحصائيات العملاء النشطين
                const customersQuery = await db.collection('customers').get();
                document.getElementById('active-customers').textContent = customersQuery.size;
                
                // إحصائيات إجمالي المرتجعات
                const returnsQuery = await db.collection('returns').get();
                let totalReturns = 0;
                returnsQuery.forEach(doc => {
                    const returnItem = doc.data();
                    totalReturns += parseFloat(returnItem.amount || 0);
                });
                document.getElementById('total-returns').textContent = formatCurrency(totalReturns);
                
                // بيانات الرسوم البيانية لآخر 7 أيام
                const last7Days = getLast7Days();
                const salesByDay = {};
                
                // تهيئة مصفوفة الأيام بقيم صفرية
                last7Days.forEach(day => {
                    salesByDay[day] = 0;
                });
                
                // جمع بيانات المبيعات حسب التاريخ
                salesQuery.forEach(doc => {
                    const sale = doc.data();
                    const saleDate = sale.date;
                    
                    if (saleDate && last7Days.includes(saleDate)) {
                        salesByDay[saleDate] += parseFloat(sale.total || 0);
                    }
                });
                
                // تحديث الرسم البياني للمبيعات
                renderSalesChart(salesByDay, last7Days);
                
                // بيانات أكثر المنتجات مبيعاً
                const productSales = {};
                
                // جمع بيانات مبيعات المنتجات
                for (const doc of salesQuery.docs) {
                    const sale = doc.data();
                    const items = sale.items || [];
                    
                    items.forEach(item => {
                        const productName = item.name;
                        const quantity = parseFloat(item.quantity || 0);
                        
                        if (productName) {
                            if (!productSales[productName]) {
                                productSales[productName] = 0;
                            }
                            productSales[productName] += quantity;
                        }
                    });
                }
                
                // تحويل إلى مصفوفة وترتيبها
                const sortedProducts = Object.entries(productSales)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                // تحديث الرسم البياني للمنتجات
                renderProductsChart(sortedProducts);
                
            } catch (error) {
                console.error("Error loading dashboard data:", error);
            }
        }
        
        // وظائف مساعدة للوحة التحكم
        function getLast7Days() {
            const dates = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                
                dates.push(`${year}-${month}-${day}`);
            }
            return dates;
        }
        
        function formatCurrency(amount) {
            return amount.toLocaleString('ar-EG', { style: 'currency', currency: 'EGP' })
                .replace('E£', '') + ' ج.م';
        }
        
        function renderSalesChart(salesByDay, dates) {
            const ctx = document.getElementById('sales-chart').getContext('2d');
            
            // تحويل التواريخ إلى صيغة أكثر ودية
            const formatDates = dates.map(date => {
                const parts = date.split('-');
                return `${parts[2]}/${parts[1]}`;
            });
            
            // ترتيب البيانات حسب التواريخ
            const salesData = dates.map(date => salesByDay[date]);
            
            // تحديد وضع الألوان بناءً على الوضع الداكن/الفاتح
            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#F9FAFB' : '#1F2937';
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            
            // إنشاء الرسم البياني
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: formatDates,
                    datasets: [{
                        label: 'المبيعات اليومية',
                        data: salesData,
                        backgroundColor: 'rgba(93, 92, 222, 0.2)',
                        borderColor: 'rgb(93, 92, 222)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: 'rgb(93, 92, 222)',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'end',
                            labels: {
                                color: textColor
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatCurrency(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderProductsChart(productsData) {
            const ctx = document.getElementById('products-chart').getContext('2d');
            
            // استخراج الأسماء والكميات
            const productNames = productsData.map(item => item[0]);
            const quantities = productsData.map(item => item[1]);
            
            // تحديد وضع الألوان بناءً على الوضع الداكن/الفاتح
            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#F9FAFB' : '#1F2937';
            
            // ألوان للرسم البياني
            const backgroundColors = [
                'rgba(93, 92, 222, 0.7)',
                'rgba(99, 102, 241, 0.7)',
                'rgba(79, 70, 229, 0.7)',
                'rgba(67, 56, 202, 0.7)',
                'rgba(55, 48, 163, 0.7)'
            ];
            
            // إنشاء الرسم البياني
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: productNames,
                    datasets: [{
                        label: 'عدد المبيعات',
                        data: quantities,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                color: textColor
                            }
                        },
                        y: {
                            ticks: {
                                color: textColor
                            }
                        }
                    }
                }
            });
        }
        
        // وظائف تحميل البيانات للوحدات المختلفة
        async function loadCustomersData() {
            try {
                const querySnapshot = await db.collection('customers').get();
                
                // تجهيز البيانات للجدول
                const customersData = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    customersData.push({
                        id: doc.id,
                        name: data.name || '',
                        phone: data.phone || '',
                        address: data.address || '',
                        type: data.type || '',
                        discount: data.discount ? `${data.discount}%` : '0%',
                        balance: formatCurrency(parseFloat(data.balance || 0))
                    });
                });
                
                // تحديث الجدول
                const table = $('#customers-table').DataTable();
                table.clear();
                table.rows.add(customersData);
                table.draw();
                
                // مستمعو الأحداث للإجراءات
                document.querySelectorAll('.edit-customer').forEach(btn => {
                    btn.addEventListener('click', () => editCustomer(btn.getAttribute('data-id')));
                });
                
                document.querySelectorAll('.delete-customer').forEach(btn => {
                    btn.addEventListener('click', () => showDeleteConfirmation('customers', btn.getAttribute('data-id')));
                });
                
            } catch (error) {
                console.error("Error loading customers data:", error);
            }
        }
        
        async function loadProductsData() {
            try {
                const querySnapshot = await db.collection('products').get();
                
                // تجهيز البيانات للجدول
                const productsData = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    productsData.push({
                        id: doc.id,
                        category: data.category || '',
                        name: data.name || '',
                        batch: data.batch || '',
                        price: formatCurrency(parseFloat(data.price || 0))
                    });
                });
                
                // تحديث الجدول
                const table = $('#products-table').DataTable();
                table.clear();
                table.rows.add(productsData);
                table.draw();
                
                // مستمعو الأحداث للإجراءات
                document.querySelectorAll('.edit-product').forEach(btn => {
                    btn.addEventListener('click', () => editProduct(btn.getAttribute('data-id')));
                });
                
                document.querySelectorAll('.delete-product').forEach(btn => {
                    btn.addEventListener('click', () => showDeleteConfirmation('products', btn.getAttribute('data-id')));
                });
                
            } catch (error) {
                console.error("Error loading products data:", error);
            }
        }
        
        async function loadSalesData() {
            try {
                const querySnapshot = await db.collection('sales').get();
                
                // تجهيز البيانات للجدول
                const salesData = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // تنسيق البيانات للعرض
                    const formattedDiscount = data.discount ? `${data.discount}%` : '0%';
                    const formattedDeposit = data.deposit ? formatCurrency(parseFloat(data.deposit)) : '-';
                    
                    salesData.push({
                        id: doc.id,
                        number: data.number || '',
                        date: data.date || '',
                        customer: data.customerName || '',
                        subtotal: formatCurrency(parseFloat(data.subtotal || 0)),
                        discount: formattedDiscount,
                        total: formatCurrency(parseFloat(data.total || 0)),
                        deposit: formattedDeposit,
                        paymentMethod: data.paymentMethod || ''
                    });
                });
                
                // تحديث الجدول
                const table = $('#sales-table').DataTable();
                table.clear();
                table.rows.add(salesData);
                table.draw();
                
                // مستمعو الأحداث للإجراءات
                document.querySelectorAll('.view-sale').forEach(btn => {
                    btn.addEventListener('click', () => viewSaleInvoice(btn.getAttribute('data-id')));
                });
                
                document.querySelectorAll('.edit-sale').forEach(btn => {
                    btn.addEventListener('click', () => editSale(btn.getAttribute('data-id')));
                });
                
                document.querySelectorAll('.delete-sale').forEach(btn => {
                    btn.addEventListener('click', () => showDeleteConfirmation('sales', btn.getAttribute('data-id')));
                });
                
            } catch (error) {
                console.error("Error loading sales data:", error);
            }
        }
        
        async function loadReturnsData() {
            try {
                const querySnapshot = await db.collection('returns').get();
                
                // تجهيز البيانات للجدول
                const returnsData = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    returnsData.push({
                        id: doc.id,
                        number: data.number || '',
                        date: data.date || '',
                        saleNumber: data.saleNumber || '',
                        customer: data.customerName || '',
                        amount: formatCurrency(parseFloat(data.amount || 0))
                    });
                });
                
                // تحديث الجدول
                const table = $('#returns-table').DataTable();
                table.clear();
                table.rows.add(returnsData);
                table.draw();
                
                // مستمعو الأحداث للإجراءات
                document.querySelectorAll('.view-return').forEach(btn => {
                    btn.addEventListener('click', () => viewReturnInvoice(btn.getAttribute('data-id')));
                });
                
                document.querySelectorAll('.delete-return').forEach(btn => {
                    btn.addEventListener('click', () => showDeleteConfirmation('returns', btn.getAttribute('data-id')));
                });
                
            } catch (error) {
                console.error("Error loading returns data:", error);
            }
        }
        
        async function loadAccountsData() {
            try {
                const querySnapshot = await db.collection('customers').get();
                
                // تجهيز البيانات للجدول
                const accountsData = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    accountsData.push({
                        id: doc.id,
                        customer: data.name || '',
                        balance: formatCurrency(parseFloat(data.balance || 0))
                    });
                });
                
                // تحديث الجدول
                const table = $('#accounts-table').DataTable();
                table.clear();
                table.rows.add(accountsData);
                table.draw();
                
                // مستمعو الأحداث للإجراءات
                document.querySelectorAll('.view-account').forEach(btn => {
                    btn.addEventListener('click', () => viewAccountDetails(btn.getAttribute('data-id')));
                });
                
            } catch (error) {
                console.error("Error loading accounts data:", error);
            }
        }
        
        async function loadPaymentsData() {
            try {
                const querySnapshot = await db.collection('payments').get();
                
                // تجهيز البيانات للجدول
                const paymentsData = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    paymentsData.push({
                        id: doc.id,
                        number: data.number || '',
                        date: data.date || '',
                        customer: data.customerName || '',
                        amount: formatCurrency(parseFloat(data.amount || 0)),
                        paymentMethod: data.paymentMethod || '',
                        notes: data.notes || ''
                    });
                });
                
                // تحديث الجدول
                const table = $('#payments-table').DataTable();
                table.clear();
                table.rows.add(paymentsData);
                table.draw();
                
                // مستمعو الأحداث للإجراءات
                document.querySelectorAll('.edit-payment').forEach(btn => {
                    btn.addEventListener('click', () => editPayment(btn.getAttribute('data-id')));
                });
                
                document.querySelectorAll('.delete-payment').forEach(btn => {
                    btn.addEventListener('click', () => showDeleteConfirmation('payments', btn.getAttribute('data-id')));
                });
                
            } catch (error) {
                console.error("Error loading payments data:", error);
            }
        }
        
        async function loadUsersData() {
            try {
                const querySnapshot = await db.collection('users').get();
                
                // تجهيز البيانات للجدول
                const usersData = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    usersData.push({
                        id: doc.id,
                        name: data.name || '',
                        email: data.email || '',
                        role: data.role === 'admin' ? 'مدير' : 'مستخدم',
                        status: data.status === 'active' ? 'نشط' : 'غير نشط'
                    });
                });
                
                // تحديث الجدول
                const table = $('#users-table').DataTable();
                table.clear();
                table.rows.add(usersData);
                table.draw();
                
                // مستمعو الأحداث للإجراءات
                document.querySelectorAll('.edit-user').forEach(btn => {
                    btn.addEventListener('click', () => editUser(btn.getAttribute('data-id')));
                });
                
                document.querySelectorAll('.delete-user').forEach(btn => {
                    btn.addEventListener('click', () => showDeleteConfirmation('users', btn.getAttribute('data-id')));
                });
                
            } catch (error) {
                console.error("Error loading users data:", error);
            }
        }
        
        // تهيئة النماذج وأزرار الإضافة
        function setupForms() {
            // نموذج العميل
            document.getElementById('add-customer-btn').addEventListener('click', () => showCustomerModal());
            document.getElementById('customer-form').addEventListener('submit', saveCustomer);
            document.getElementById('customer-modal-cancel').addEventListener('click', () => hideModal('customer-modal'));
            
            // نموذج المنتج
            document.getElementById('add-product-btn').addEventListener('click', () => showProductModal());
            document.getElementById('product-form').addEventListener('submit', saveProduct);
            document.getElementById('product-modal-cancel').addEventListener('click', () => hideModal('product-modal'));
            
            // نموذج المبيعات
            document.getElementById('add-sale-btn').addEventListener('click', () => showSaleModal());
            document.getElementById('sale-form').addEventListener('submit', saveSale);
            document.getElementById('sale-modal-cancel').addEventListener('click', () => hideModal('sale-modal'));
            document.getElementById('add-product-row-btn').addEventListener('click', addProductRow);
            document.getElementById('has-deposit').addEventListener('change', toggleDepositFields);
            
            // نموذج المرتجعات
            document.getElementById('add-return-btn').addEventListener('click', () => showReturnModal());
            document.getElementById('return-form').addEventListener('submit', saveReturn);
            document.getElementById('return-modal-cancel').addEventListener('click', () => hideModal('return-modal'));
            
            // نموذج المدفوعات
            document.getElementById('add-payment-btn').addEventListener('click', () => showPaymentModal());
            document.getElementById('payment-form').addEventListener('submit', savePayment);
            document.getElementById('payment-modal-cancel').addEventListener('click', () => hideModal('payment-modal'));
            
            // نموذج المستخدم
            document.getElementById('add-user-btn').addEventListener('click', () => showUserModal());
            document.getElementById('user-form').addEventListener('submit', saveUser);
            document.getElementById('user-modal-cancel').addEventListener('click', () => hideModal('user-modal'));
            document.getElementById('user-role').addEventListener('change', togglePermissionsContainer);
            
            // نموذج الحذف
            document.getElementById('delete-cancel').addEventListener('click', () => hideModal('delete-modal'));
            document.getElementById('delete-confirm').addEventListener('click', confirmDelete);
            
            // نموذج تفاصيل الحساب
            document.getElementById('account-details-close').addEventListener('click', () => hideModal('account-details-modal'));
            document.getElementById('print-account-btn').addEventListener('click', printAccountStatement);
            document.getElementById('export-account-btn').addEventListener('click', exportAccountToPDF);
            
            // نموذج تفاصيل الفاتورة
            document.getElementById('invoice-details-close').addEventListener('click', () => hideModal('invoice-details-modal'));
            document.getElementById('print-invoice-btn').addEventListener('click', printInvoice);
            document.getElementById('export-invoice-btn').addEventListener('click', exportInvoiceToPDF);
        }
        
        // وظائف النماذج
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
        
        // وظائف العملاء
        function showCustomerModal(customerId = null) {
            // إعادة تعيين النموذج
            document.getElementById('customer-form').reset();
            document.getElementById('customer-id').value = '';
            
            if (customerId) {
                document.getElementById('customer-modal-title').textContent = 'تعديل بيانات العميل';
                
                // جلب بيانات العميل
                db.collection('customers').doc(customerId).get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById('customer-id').value = customerId;
                        document.getElementById('customer-name').value = data.name || '';
                        document.getElementById('customer-phone').value = data.phone || '';
                        document.getElementById('customer-address').value = data.address || '';
                        document.getElementById('customer-type').value = data.type || 'هيئات/مشاريع';
                        document.getElementById('customer-discount').value = data.discount || '0';
                    }
                }).catch(error => {
                    console.error("Error fetching customer data:", error);
                });
            } else {
                document.getElementById('customer-modal-title').textContent = 'إضافة عميل جديد';
            }
            
            showModal('customer-modal');
        }
        
        function editCustomer(customerId) {
            showCustomerModal(customerId);
        }
        
        async function saveCustomer(e) {
            e.preventDefault();
            
            const customerId = document.getElementById('customer-id').value;
            const customerData = {
                name: document.getElementById('customer-name').value,
                phone: document.getElementById('customer-phone').value,
                address: document.getElementById('customer-address').value,
                type: document.getElementById('customer-type').value,
                discount: parseFloat(document.getElementById('customer-discount').value || 0)
            };
            
            try {
                if (customerId) {
                    // تحديث عميل موجود
                    await db.collection('customers').doc(customerId).update(customerData);
                } else {
                    // إضافة عميل جديد
                    customerData.balance = 0;
                    await db.collection('customers').add(customerData);
                }
                
                hideModal('customer-modal');
                loadCustomersData();
            } catch (error) {
                console.error("Error saving customer:", error);
                alert('حدث خطأ أثناء حفظ بيانات العميل.');
            }
        }
        
        // وظائف المنتجات
        function showProductModal(productId = null) {
            // إعادة تعيين النموذج
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            
            if (productId) {
                document.getElementById('product-modal-title').textContent = 'تعديل بيانات المنتج';
                
                // جلب بيانات المنتج
                db.collection('products').doc(productId).get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById('product-id').value = productId;
                        document.getElementById('product-category').value = data.category || 'انشائى';
                        document.getElementById('product-name').value = data.name || '';
                        document.getElementById('product-batch').value = data.batch || '';
                        document.getElementById('product-price').value = data.price || '0';
                    }
                }).catch(error => {
                    console.error("Error fetching product data:", error);
                });
            } else {
                document.getElementById('product-modal-title').textContent = 'إضافة منتج جديد';
            }
            
            showModal('product-modal');
        }
        
        function editProduct(productId) {
            showProductModal(productId);
        }
        
        async function saveProduct(e) {
            e.preventDefault();
            
            const productId = document.getElementById('product-id').value;
            const productData = {
                category: document.getElementById('product-category').value,
                name: document.getElementById('product-name').value,
                batch: document.getElementById('product-batch').value,
                price: parseFloat(document.getElementById('product-price').value || 0)
            };
            
            try {
                if (productId) {
                    // تحديث منتج موجود
                    await db.collection('products').doc(productId).update(productData);
                } else {
                    // إضافة منتج جديد
                    await db.collection('products').add(productData);
                }
                
                hideModal('product-modal');
                loadProductsData();
            } catch (error) {
                console.error("Error saving product:", error);
                alert('حدث خطأ أثناء حفظ بيانات المنتج.');
            }
        }
        
        // وظائف المبيعات
        async function showSaleModal(saleId = null) {
            // إعادة تعيين النموذج
            document.getElementById('sale-form').reset();
            document.getElementById('sale-id').value = '';
            
            // تحديد تاريخ اليوم كتاريخ افتراضي
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sale-date').value = today;
            
            // إعادة تعيين قسم المنتجات
            const productsContainer = document.getElementById('sale-products-container');
            productsContainer.innerHTML = '';
            addProductRow();
            
            // إخفاء حقول العربون
            document.getElementById('has-deposit').checked = false;
            document.getElementById('deposit-container').classList.add('hidden');
            
            // جلب قائمة العملاء
            await loadCustomersSelect('sale-customer');
            
            if (saleId) {
                document.getElementById('sale-modal-title').textContent = 'تعديل فاتورة المبيعات';
                
                // جلب بيانات الفاتورة
                try {
                    const doc = await db.collection('sales').doc(saleId).get();
                    
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById('sale-id').value = saleId;
                        document.getElementById('sale-number').value = data.number || '';
                        document.getElementById('sale-date').value = data.date || today;
                        document.getElementById('sale-customer').value = data.customerId || '';
                        document.getElementById('sale-subtotal').value = data.subtotal || '0';
                        document.getElementById('sale-discount').value = data.discount || '0';
                        document.getElementById('sale-payment-method').value = data.paymentMethod || 'نقدى';
                        document.getElementById('sale-notes').value = data.notes || '';
                        document.getElementById('sale-total').value = data.total || '0';
                        
                        // إعداد العربون إذا وجد
                        if (data.deposit) {
                            document.getElementById('has-deposit').checked = true;
                            document.getElementById('deposit-container').classList.remove('hidden');
                            document.getElementById('sale-deposit').value = data.deposit || '0';
                            document.getElementById('deposit-payment-method').value = data.depositPaymentMethod || 'نقدى';
                        }
                        
                        // إضافة المنتجات
                        productsContainer.innerHTML = '';
                        const items = data.items || [];
                        
                        if (items.length > 0) {
                            for (const item of items) {
                                addProductRow();
                                const rows = productsContainer.querySelectorAll('.product-item');
                                const lastRow = rows[rows.length - 1];
                                
                                // تعيين القيم
                                lastRow.querySelector('.product-category').value = item.category || '';
                                
                                // تحميل المنتجات بناءً على التصنيف
                                await loadProductsByCategory(lastRow.querySelector('.product-category'), lastRow.querySelector('.product-name'));
                                lastRow.querySelector('.product-name').value = item.productId || '';
                                
                                // تحميل الباتشات بناءً على المنتج
                                await loadBatchesByProduct(lastRow.querySelector('.product-name'), lastRow.querySelector('.product-batch'));
                                lastRow.querySelector('.product-batch').value = item.batchId || '';
                                
                                // تعيين الكمية والسعر والإجمالي
                                lastRow.querySelector('.product-quantity').value = item.quantity || '1';
                                lastRow.querySelector('.product-price').value = item.price || '0';
                                lastRow.querySelector('.product-total').value = item.total || '0';
                                
                                // تفعيل حقول الإدخال
                                lastRow.querySelector('.product-name').disabled = false;
                                lastRow.querySelector('.product-batch').disabled = false;
                                lastRow.querySelector('.product-quantity').disabled = false;
                            }
                        }
                    }
                } catch (error) {
                    console.error("Error fetching sale data:", error);
                }
            } else {
                document.getElementById('sale-modal-title').textContent = 'إنشاء فاتورة جديدة';
                
                // إنشاء رقم فاتورة جديد
                const newInvoiceNumber = await generateNewInvoiceNumber('sales');
                document.getElementById('sale-number').value = newInvoiceNumber;
            }
            
            showModal('sale-modal');
        }
        
        function editSale(saleId) {
            showSaleModal(saleId);
        }
        
        async function saveSale(e) {
            e.preventDefault();
            
            // جمع البيانات من النموذج
            const saleId = document.getElementById('sale-id').value;
            const saleNumber = document.getElementById('sale-number').value;
            const saleDate = document.getElementById('sale-date').value;
            const customerId = document.getElementById('sale-customer').value;
            const customerName = document.getElementById('sale-customer').options[document.getElementById('sale-customer').selectedIndex].text;
            const subtotal = parseFloat(document.getElementById('sale-subtotal').value || 0);
            const discount = parseFloat(document.getElementById('sale-discount').value || 0);
            const paymentMethod = document.getElementById('sale-payment-method').value;
            const notes = document.getElementById('sale-notes').value;
            const total = parseFloat(document.getElementById('sale-total').value || 0);
            
            // التحقق من حقول العربون
            let deposit = null;
            let depositPaymentMethod = null;
            
            if (document.getElementById('has-deposit').checked) {
                deposit = parseFloat(document.getElementById('sale-deposit').value || 0);
                depositPaymentMethod = document.getElementById('deposit-payment-method').value;
            }
            
            // جمع المنتجات
            const items = [];
            const productRows = document.querySelectorAll('.product-item');
            
            productRows.forEach(row => {
                const category = row.querySelector('.product-category').value;
                const productId = row.querySelector('.product-name').value;
                const productName = row.querySelector('.product-name').options[row.querySelector('.product-name').selectedIndex].text;
                const batchId = row.querySelector('.product-batch').value;
                const batchName = row.querySelector('.product-batch').options[row.querySelector('.product-batch').selectedIndex].text;
                const quantity = parseFloat(row.querySelector('.product-quantity').value || 0);
                const price = parseFloat(row.querySelector('.product-price').value || 0);
                const itemTotal = parseFloat(row.querySelector('.product-total').value || 0);
                
                if (productId && batchId && quantity > 0) {
                    items.push({
                        category,
                        productId,
                        name: productName,
                        batchId,
                        batch: batchName,
                        quantity,
                        price,
                        total: itemTotal
                    });
                }
            });
            
            // التحقق من وجود منتجات
            if (items.length === 0) {
                alert('يرجى إضافة منتج واحد على الأقل قبل حفظ الفاتورة.');
                return;
            }
            
            // بناء كائن البيانات
            const saleData = {
                number: saleNumber,
                date: saleDate,
                customerId,
                customerName,
                items,
                subtotal,
                discount,
                paymentMethod,
                notes,
                total,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // إضافة بيانات العربون إذا لزم الأمر
            if (deposit !== null) {
                saleData.deposit = deposit;
                saleData.depositPaymentMethod = depositPaymentMethod;
            }
            
            try {
                let docRef;
                
                if (saleId) {
                    // تحديث فاتورة موجودة
                    docRef = db.collection('sales').doc(saleId);
                    await docRef.update(saleData);
                } else {
                    // إضافة فاتورة جديدة
                    docRef = await db.collection('sales').add(saleData);
                    saleId = docRef.id;
                }
                
                // تحديث رصيد العميل
                await updateCustomerBalance(customerId);
                
                hideModal('sale-modal');
                loadSalesData();
            } catch (error) {
                console.error("Error saving sale:", error);
                alert('حدث خطأ أثناء حفظ الفاتورة.');
            }
        }
        
        function addProductRow() {
            const container = document.getElementById('sale-products-container');
            
            const newRow = document.createElement('div');
            newRow.className = 'product-item grid grid-cols-12 gap-2 mb-4';
            newRow.innerHTML = `
                <div class="col-span-3">
                    <select class="product-category w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white">
                        <option value="">-- التصنيف --</option>
                        <option value="انشائى">انشائى</option>
                        <option value="واجهات خارجية">واجهات خارجية</option>
                        <option value="ديكورى">ديكورى</option>
                    </select>
                </div>
                
                <div class="col-span-3">
                    <select class="product-name w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" disabled>
                        <option value="">-- المنتج --</option>
                    </select>
                </div>
                
                <div class="col-span-2">
                    <select class="product-batch w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" disabled>
                        <option value="">-- الباتش --</option>
                    </select>
                </div>
                
                <div class="col-span-1">
                    <input type="number" min="1" class="product-quantity w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" placeholder="الكمية" value="1" disabled>
                </div>
                
                <div class="col-span-1">
                    <input type="number" min="0" step="0.01" class="product-price w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" placeholder="السعر" readonly>
                </div>
                
                <div class="col-span-1">
                    <input type="number" min="0" step="0.01" class="product-total w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" placeholder="الإجمالي" readonly>
                </div>
                
                <div class="col-span-1 flex items-center justify-center">
                    <button type="button" class="delete-product-btn text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(newRow);
            
            // إضافة مستمعي الأحداث
            const categorySelect = newRow.querySelector('.product-category');
            const productSelect = newRow.querySelector('.product-name');
            const batchSelect = newRow.querySelector('.product-batch');
            const quantityInput = newRow.querySelector('.product-quantity');
            const priceInput = newRow.querySelector('.product-price');
            const totalInput = newRow.querySelector('.product-total');
            const deleteBtn = newRow.querySelector('.delete-product-btn');
            
            // مستمع تغيير التصنيف
            categorySelect.addEventListener('change', () => {
                const selectedCategory = categorySelect.value;
                
                if (selectedCategory) {
                    loadProductsByCategory(categorySelect, productSelect);
                    productSelect.disabled = false;
                    
                    // إعادة تعيين الحقول الأخرى
                    batchSelect.innerHTML = '<option value="">-- الباتش --</option>';
                    batchSelect.disabled = true;
                    quantityInput.disabled = true;
                    priceInput.value = '';
                    totalInput.value = '';
                } else {
                    productSelect.innerHTML = '<option value="">-- المنتج --</option>';
                    productSelect.disabled = true;
                    
                    batchSelect.innerHTML = '<option value="">-- الباتش --</option>';
                    batchSelect.disabled = true;
                    
                    quantityInput.disabled = true;
                    priceInput.value = '';
                    totalInput.value = '';
                }
                
                // إعادة حساب الإجماليات
                calculateSaleTotals();
            });
            
            // مستمع تغيير المنتج
            productSelect.addEventListener('change', () => {
                const selectedProduct = productSelect.value;
                
                if (selectedProduct) {
                    loadBatchesByProduct(productSelect, batchSelect);
                    batchSelect.disabled = false;
                    
                    // إعادة تعيين الحقول الأخرى
                    quantityInput.disabled = true;
                    priceInput.value = '';
                    totalInput.value = '';
                } else {
                    batchSelect.innerHTML = '<option value="">-- الباتش --</option>';
                    batchSelect.disabled = true;
                    
                    quantityInput.disabled = true;
                    priceInput.value = '';
                    totalInput.value = '';
                }
                
                // إعادة حساب الإجماليات
                calculateSaleTotals();
            });
            
            // مستمع تغيير الباتش
            batchSelect.addEventListener('change', () => {
                const selectedBatch = batchSelect.value;
                
                if (selectedBatch) {
                    // تفعيل حقل الكمية
                    quantityInput.disabled = false;
                    
                    // جلب سعر المنتج
                    db.collection('products').doc(selectedBatch).get().then(doc => {
                        if (doc.exists) {
                            const price = doc.data().price || 0;
                            priceInput.value = price;
                            
                            // حساب الإجمالي
                            const quantity = parseFloat(quantityInput.value || 1);
                            totalInput.value = (price * quantity).toFixed(2);
                            
                            // إعادة حساب إجماليات الفاتورة
                            calculateSaleTotals();
                        }
                    }).catch(error => {
                        console.error("Error fetching product price:", error);
                    });
                } else {
                    quantityInput.disabled = true;
                    priceInput.value = '';
                    totalInput.value = '';
                    
                    // إعادة حساب الإجماليات
                    calculateSaleTotals();
                }
            });
            
            // مستمع تغيير الكمية
            quantityInput.addEventListener('input', () => {
                const quantity = parseFloat(quantityInput.value || 0);
                const price = parseFloat(priceInput.value || 0);
                
                if (quantity > 0 && price > 0) {
                    totalInput.value = (price * quantity).toFixed(2);
                    
                    // إعادة حساب إجماليات الفاتورة
                    calculateSaleTotals();
                } else {
                    totalInput.value = '';
                }
            });
            
            // مستمع زر الحذف
            deleteBtn.addEventListener('click', () => {
                if (container.querySelectorAll('.product-item').length > 1) {
                    container.removeChild(newRow);
                    
                    // إعادة حساب إجماليات الفاتورة
                    calculateSaleTotals();
                } else {
                    alert('يجب أن يكون هناك صف واحد على الأقل من المنتجات.');
                }
            });
        }
        
        function toggleDepositFields() {
            const depositContainer = document.getElementById('deposit-container');
            
            if (document.getElementById('has-deposit').checked) {
                depositContainer.classList.remove('hidden');
            } else {
                depositContainer.classList.add('hidden');
                document.getElementById('sale-deposit').value = '0';
            }
            
            // إعادة حساب الإجمالي
            calculateSaleTotals();
        }
        
        async function loadProductsByCategory(categorySelect, productSelect) {
            const selectedCategory = categorySelect.value;
            
            // إعادة تعيين قائمة المنتجات
            productSelect.innerHTML = '<option value="">-- المنتج --</option>';
            
            if (!selectedCategory) return;
            
            try {
                // جلب المنتجات حسب التصنيف
                const querySnapshot = await db.collection('products')
                    .where('category', '==', selectedCategory)
                    .get();
                
                // إنشاء مجموعة فريدة من أسماء المنتجات
                const uniqueProducts = new Map();
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    // استخدام اسم المنتج كمفتاح فريد
                    uniqueProducts.set(data.name, {
                        id: doc.id,
                        name: data.name
                    });
                });
                
                // إضافة الخيارات الفريدة إلى القائمة
                uniqueProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.name;
                    option.textContent = product.name;
                    productSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error("Error loading products by category:", error);
            }
        }
        
        async function loadBatchesByProduct(productSelect, batchSelect) {
            const selectedProduct = productSelect.value;
            const selectedCategory = productSelect.closest('.product-item').querySelector('.product-category').value;
            
            // إعادة تعيين قائمة الباتشات
            batchSelect.innerHTML = '<option value="">-- الباتش --</option>';
            
            if (!selectedProduct || !selectedCategory) return;
            
            try {
                // جلب الباتشات حسب التصنيف واسم المنتج
                const querySnapshot = await db.collection('products')
                    .where('category', '==', selectedCategory)
                    .where('name', '==', selectedProduct)
                    .get();
                
                // إضافة الباتشات إلى القائمة
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = data.batch;
                    batchSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error("Error loading batches by product:", error);
            }
        }
        
        function calculateSaleTotals() {
            // حساب المجموع الفرعي
            let subtotal = 0;
            const productRows = document.querySelectorAll('.product-item');
            
            productRows.forEach(row => {
                const itemTotal = parseFloat(row.querySelector('.product-total').value || 0);
                subtotal += itemTotal;
            });
            
            // تحديث المجموع الفرعي
            document.getElementById('sale-subtotal').value = subtotal.toFixed(2);
            
            // حساب الخصم
            const discountPercentage = parseFloat(document.getElementById('sale-discount').value || 0);
            const discountAmount = subtotal * (discountPercentage / 100);
            
            // حساب المجموع بعد الخصم
            let finalTotal = subtotal - discountAmount;
            
            // حساب العربون إذا وجد
            if (document.getElementById('has-deposit').checked) {
                const deposit = parseFloat(document.getElementById('sale-deposit').value || 0);
                // لا نقوم بطرح العربون من الإجمالي لأنه جزء من الدفع وليس خصمًا
            }
            
            // تحديث المجموع النهائي
            document.getElementById('sale-total').value = finalTotal.toFixed(2);
        }
        
        // وظائف المرتجعات
        async function showReturnModal(returnId = null) {
            // إعادة تعيين النموذج
            document.getElementById('return-form').reset();
            document.getElementById('return-id').value = '';
            document.getElementById('return-products-container').innerHTML = '';
            document.getElementById('return-customer').value = '';
            
            // تحديد تاريخ اليوم كتاريخ افتراضي
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('return-date').value = today;
            
            // تحميل قائمة فواتير المبيعات
            await loadSalesSelect('return-sale');
            
            if (returnId) {
                document.getElementById('return-modal-title').textContent = 'تعديل فاتورة المرتجع';
                
                // جلب بيانات المرتجع
                try {
                    const doc = await db.collection('returns').doc(returnId).get();
                    
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById('return-id').value = returnId;
                        document.getElementById('return-number').value = data.number || '';
                        document.getElementById('return-date').value = data.date || today;
                        document.getElementById('return-sale').value = data.saleId || '';
                        document.getElementById('return-customer').value = data.customerName || '';
                        document.getElementById('return-amount').value = data.amount || '0';
                        document.getElementById('return-notes').value = data.notes || '';
                        
                        // تحميل بيانات المنتجات المرتجعة
                        await loadReturnItemsFromSale(data.saleId, data.items || []);
                    }
                } catch (error) {
                    console.error("Error fetching return data:", error);
                }
            } else {
                document.getElementById('return-modal-title').textContent = 'إنشاء فاتورة مرتجع';
                
                // إنشاء رقم فاتورة مرتجع جديد
                const newReturnNumber = await generateNewInvoiceNumber('returns');
                document.getElementById('return-number').value = newReturnNumber;
            }
            
            // مستمع تغيير فاتورة المبيعات
            document.getElementById('return-sale').addEventListener('change', async function() {
                const selectedSaleId = this.value;
                
                if (selectedSaleId) {
                    try {
                        // جلب بيانات فاتورة المبيعات
                        const saleDoc = await db.collection('sales').doc(selectedSaleId).get();
                        
                        if (saleDoc.exists) {
                            const saleData = saleDoc.data();
                            document.getElementById('return-customer').value = saleData.customerName || '';
                            
                            // تحميل المنتجات من فاتورة المبيعات
                            await loadReturnItemsFromSale(selectedSaleId, []);
                        }
                    } catch (error) {
                        console.error("Error loading sale data for return:", error);
                    }
                } else {
                    document.getElementById('return-customer').value = '';
                    document.getElementById('return-products-container').innerHTML = '';
                    document.getElementById('return-amount').value = '0';
                }
            });
            
            showModal('return-modal');
        }
        
        async function loadReturnItemsFromSale(saleId, selectedItems = []) {
            if (!saleId) return;
            
            try {
                // جلب بيانات فاتورة المبيعات
                const saleDoc = await db.collection('sales').doc(saleId).get();
                
                if (saleDoc.exists) {
                    const saleData = saleDoc.data();
                    const items = saleData.items || [];
                    const container = document.getElementById('return-products-container');
                    container.innerHTML = '';
                    
                    // إضافة المنتجات إلى واجهة المرتجعات
                    items.forEach(item => {
                        // التحقق مما إذا كان المنتج موجودًا في العناصر المحددة
                        const isSelected = selectedItems.some(
                            selectedItem => selectedItem.productId === item.productId && 
                                          selectedItem.batchId === item.batchId
                        );
                        
                        // إيجاد الكمية المرتجعة لهذا المنتج إذا كان محددًا
                        const returnedQuantity = isSelected 
                            ? selectedItems.find(
                                selectedItem => selectedItem.productId === item.productId && 
                                              selectedItem.batchId === item.batchId
                              ).returnedQuantity
                            : 0;
                        
                        const row = document.createElement('div');
                        row.className = 'return-item grid grid-cols-12 gap-2 mb-4';
                        row.innerHTML = `
                            <div class="col-span-4">
                                <p class="text-sm font-medium mb-1">المنتج</p>
                                <div class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">${item.name}</div>
                                <input type="hidden" class="product-id" value="${item.productId}">
                            </div>
                            
                            <div class="col-span-3">
                                <p class="text-sm font-medium mb-1">الباتش/اللون</p>
                                <div class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">${item.batch}</div>
                                <input type="hidden" class="batch-id" value="${item.batchId}">
                            </div>
                            
                            <div class="col-span-2">
                                <p class="text-sm font-medium mb-1">الكمية المشتراة</p>
                                <div class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">${item.quantity}</div>
                                <input type="hidden" class="original-quantity" value="${item.quantity}">
                                <input type="hidden" class="price" value="${item.price}">
                            </div>
                            
                            <div class="col-span-2">
                                <p class="text-sm font-medium mb-1">الكمية المرتجعة</p>
                                <input type="number" min="0" max="${item.quantity}" class="returned-quantity w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" value="${returnedQuantity}">
                            </div>
                            
                            <div class="col-span-1">
                                <p class="text-sm font-medium mb-1">المبلغ</p>
                                <input type="number" class="return-item-amount w-full px-3 py-2 text-base border rounded-md focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white" readonly value="${(returnedQuantity * item.price).toFixed(2)}">
                            </div>
                        `;
                        
                        container.appendChild(row);
                        
                        // إضافة مستمع لتغيير الكمية المرتجعة
                        const quantityInput = row.querySelector('.returned-quantity');
                        const amountInput = row.querySelector('.return-item-amount');
                        
                        quantityInput.addEventListener('input', () => {
                            const returnedQty = parseFloat(quantityInput.value || 0);
                            const originalQty = parseFloat(row.querySelector('.original-quantity').value || 0);
                            const price = parseFloat(row.querySelector('.price').value || 0);
                            
                            // التحقق من الكمية المدخلة
                            if (returnedQty > originalQty) {
                                quantityInput.value = originalQty;
                                alert('لا يمكن إرجاع كمية أكبر من الكمية المشتراة.');
                            }
                            
                            // حساب المبلغ المسترد لهذا المنتج
                            amountInput.value = (price * parseFloat(quantityInput.value || 0)).toFixed(2);
                            
                            // إعادة حساب إجمالي المرتجعات
                            calculateReturnTotal();
                        });
                    });
                    
                    // إعادة حساب إجمالي المرتجعات
                    calculateReturnTotal();
                }
            } catch (error) {
                console.error("Error loading sale items for return:", error);
            }
        }
        
        function calculateReturnTotal() {
            let totalAmount = 0;
            const returnItems = document.querySelectorAll('.return-item');
            
            returnItems.forEach(item => {
                totalAmount += parseFloat(item.querySelector('.return-item-amount').value || 0);
            });
            
            document.getElementById('return-amount').value = totalAmount.toFixed(2);
        }
        
        async function saveReturn(e) {
            e.preventDefault();
            
            // جمع البيانات من النموذج
            const returnId = document.getElementById('return-id').value;
            const returnNumber = document.getElementById('return-number').value;
            const returnDate = document.getElementById('return-date').value;
            const saleId = document.getElementById('return-sale').value;
            const saleNumber = document.getElementById('return-sale').options[document.getElementById('return-sale').selectedIndex].text;
            const customerName = document.getElementById('return-customer').value;
            const amount = parseFloat(document.getElementById('return-amount').value || 0);
            const notes = document.getElementById('return-notes').value;
            
            // جمع المنتجات المرتجعة
            const items = [];
            const returnItems = document.querySelectorAll('.return-item');
            
            returnItems.forEach(item => {
                const productId = item.querySelector('.product-id').value;
                const productName = item.querySelector('.col-span-4 div').textContent;
                const batchId = item.querySelector('.batch-id').value;
                const batchName = item.querySelector('.col-span-3 div').textContent;
                const originalQuantity = parseFloat(item.querySelector('.original-quantity').value || 0);
                const returnedQuantity = parseFloat(item.querySelector('.returned-quantity').value || 0);
                const price = parseFloat(item.querySelector('.price').value || 0);
                const itemAmount = parseFloat(item.querySelector('.return-item-amount').value || 0);
                
                if (returnedQuantity > 0) {
                    items.push({
                        productId,
                        name: productName,
                        batchId,
                        batch: batchName,
                        originalQuantity,
                        returnedQuantity,
                        price,
                        amount: itemAmount
                    });
                }
            });
            
            // التحقق من وجود منتجات مرتجعة
            if (items.length === 0) {
                alert('يرجى تحديد منتج واحد على الأقل لإرجاعه.');
                return;
            }
            
            // بناء كائن البيانات
            const returnData = {
                number: returnNumber,
                date: returnDate,
                saleId,
                saleNumber,
                customerName,
                items,
                amount,
                notes,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                // استخراج الـ customerId من فاتورة المبيعات
                const saleDoc = await db.collection('sales').doc(saleId).get();
                if (saleDoc.exists) {
                    returnData.customerId = saleDoc.data().customerId;
                }
                
                if (returnId) {
                    // تحديث فاتورة مرتجع موجودة
                    await db.collection('returns').doc(returnId).update(returnData);
                } else {
                    // إضافة فاتورة مرتجع جديدة
                    await db.collection('returns').add(returnData);
                }
                
                // تحديث رصيد العميل
                if (returnData.customerId) {
                    await updateCustomerBalance(returnData.customerId);
                }
                
                hideModal('return-modal');
                loadReturnsData();
            } catch (error) {
                console.error("Error saving return:", error);
                alert('حدث خطأ أثناء حفظ فاتورة المرتجع.');
            }
        }
        
        // وظائف المدفوعات
        async function showPaymentModal(paymentId = null) {
            // إعادة تعيين النموذج
            document.getElementById('payment-form').reset();
            document.getElementById('payment-id').value = '';
            
            // تحديد تاريخ اليوم كتاريخ افتراضي
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('payment-date').value = today;
            
            // تحميل قائمة العملاء
            await loadCustomersSelect('payment-customer');
            
            if (paymentId) {
                document.getElementById('payment-modal-title').textContent = 'تعديل سداد';
                
                // جلب بيانات السداد
                try {
                    const doc = await db.collection('payments').doc(paymentId).get();
                    
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById('payment-id').value = paymentId;
                        document.getElementById('payment-number').value = data.number || '';
                        document.getElementById('payment-date').value = data.date || today;
                        document.getElementById('payment-customer').value = data.customerId || '';
                        
                        // تحميل رصيد العميل
                        if (data.customerId) {
                            await loadCustomerBalance(data.customerId);
                        }
                        
                        document.getElementById('payment-amount').value = data.amount || '0';
                        document.getElementById('payment-method').value = data.paymentMethod || 'نقدى';
                        document.getElementById('payment-notes').value = data.notes || '';
                    }
                } catch (error) {
                    console.error("Error fetching payment data:", error);
                }
            } else {
                document.getElementById('payment-modal-title').textContent = 'إضافة سداد جديد';
                
                // إنشاء رقم سداد جديد
                const newPaymentNumber = await generateNewInvoiceNumber('payments');
                document.getElementById('payment-number').value = newPaymentNumber;
            }
            
            // مستمع تغيير العميل
            document.getElementById('payment-customer').addEventListener('change', function() {
                const selectedCustomerId = this.value;
                
                if (selectedCustomerId) {
                    loadCustomerBalance(selectedCustomerId);
                } else {
                    document.getElementById('customer-balance').value = '0';
                }
            });
            
            showModal('payment-modal');
        }
        
        function editPayment(paymentId) {
            showPaymentModal(paymentId);
        }
        
        async function loadCustomerBalance(customerId) {
            try {
                const customerDoc = await db.collection('customers').doc(customerId).get();
                
                if (customerDoc.exists) {
                    const balance = customerDoc.data().balance || 0;
                    document.getElementById('customer-balance').value = balance.toFixed(2);
                } else {
                    document.getElementById('customer-balance').value = '0';
                }
            } catch (error) {
                console.error("Error loading customer balance:", error);
                document.getElementById('customer-balance').value = '0';
            }
        }
        
        async function savePayment(e) {
            e.preventDefault();
            
            // جمع البيانات من النموذج
            const paymentId = document.getElementById('payment-id').value;
            const paymentNumber = document.getElementById('payment-number').value;
            const paymentDate = document.getElementById('payment-date').value;
            const customerId = document.getElementById('payment-customer').value;
            const customerName = document.getElementById('payment-customer').options[document.getElementById('payment-customer').selectedIndex].text;
            const amount = parseFloat(document.getElementById('payment-amount').value || 0);
            const paymentMethod = document.getElementById('payment-method').value;
            const notes = document.getElementById('payment-notes').value;
            
            // التحقق من البيانات
            if (!customerId) {
                alert('يرجى اختيار العميل.');
                return;
            }
            
            if (amount <= 0) {
                alert('يرجى إدخال مبلغ صحيح للسداد.');
                return;
            }
            
            // بناء كائن البيانات
            const paymentData = {
                number: paymentNumber,
                date: paymentDate,
                customerId,
                customerName,
                amount,
                paymentMethod,
                notes,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                if (paymentId) {
                    // تحديث سداد موجود
                    await db.collection('payments').doc(paymentId).update(paymentData);
                } else {
                    // إضافة سداد جديد
                    await db.collection('payments').add(paymentData);
                }
                
                // تحديث رصيد العميل
                await updateCustomerBalance(customerId);
                
                hideModal('payment-modal');
                loadPaymentsData();
            } catch (error) {
                console.error("Error saving payment:", error);
                alert('حدث خطأ أثناء حفظ بيانات السداد.');
            }
        }
        
        // وظائف المستخدمين
        function showUserModal(userId = null) {
            // إعادة تعيين النموذج
            document.getElementById('user-form').reset();
            document.getElementById('user-id').value = '';
            document.getElementById('password-container').classList.remove('hidden');
            document.getElementById('permissions-container').classList.add('hidden');
            
            // إعادة تعيين خانات الاختيار للصلاحيات
            document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            if (userId) {
                document.getElementById('user-modal-title').textContent = 'تعديل مستخدم';
                document.getElementById('password-container').classList.add('hidden');
                
                // جلب بيانات المستخدم
                db.collection('users').doc(userId).get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById('user-id').value = userId;
                        document.getElementById('user-name').value = data.name || '';
                        document.getElementById('user-email').value = data.email || '';
                        document.getElementById('user-role').value = data.role || 'user';
                        
                        // عرض/إخفاء قسم الصلاحيات بناءً على الدور
                        if (data.role === 'user') {
                            document.getElementById('permissions-container').classList.remove('hidden');
                            
                            // تحديد الصلاحيات المحددة مسبقًا
                            const permissions = data.permissions || {};
                            
                            for (const module in permissions) {
                                for (const permission in permissions[module]) {
                                    if (permissions[module][permission]) {
                                        const checkbox = document.querySelector(`.permission-checkbox[data-module="${module}"][data-permission="${permission}"]`);
                                        if (checkbox) {
                                            checkbox.checked = true;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }).catch(error => {
                    console.error("Error fetching user data:", error);
                });
            } else {
                document.getElementById('user-modal-title').textContent = 'إضافة مستخدم جديد';
            }
            
            showModal('user-modal');
        }
        
        function editUser(userId) {
            showUserModal(userId);
        }
        
        function togglePermissionsContainer() {
            const role = document.getElementById('user-role').value;
            const permissionsContainer = document.getElementById('permissions-container');
            
            if (role === 'user') {
                permissionsContainer.classList.remove('hidden');
            } else {
                permissionsContainer.classList.add('hidden');
            }
        }
        
        async function saveUser(e) {
            e.preventDefault();
            
            const userId = document.getElementById('user-id').value;
            const userData = {
                name: document.getElementById('user-name').value,
                email: document.getElementById('user-email').value,
                role: document.getElementById('user-role').value,
                status: 'active'
            };
            
            // إذا كان المستخدم من نوع "user"، قم بجمع الصلاحيات
            if (userData.role === 'user') {
                const permissions = {};
                
                // الحصول على جميع وحدات النظام
                const modules = ['customers', 'products', 'sales', 'returns', 'accounts', 'payments'];
                
                // لكل وحدة، قم بجمع صلاحيات العرض والإضافة والتعديل والحذف
                modules.forEach(module => {
                    permissions[module] = {
                        view: document.querySelector(`.permission-checkbox[data-module="${module}"][data-permission="view"]`)?.checked || false,
                        add: document.querySelector(`.permission-checkbox[data-module="${module}"][data-permission="add"]`)?.checked || false,
                        edit: document.querySelector(`.permission-checkbox[data-module="${module}"][data-permission="edit"]`)?.checked || false,
                        delete: document.querySelector(`.permission-checkbox[data-module="${module}"][data-permission="delete"]`)?.checked || false
                    };
                });
                
                userData.permissions = permissions;
            }
            
            try {
                if (userId) {
                    // تحديث مستخدم موجود
                    await db.collection('users').doc(userId).update(userData);
                } else {
                    // التحقق من وجود كلمة مرور
                    const password = document.getElementById('user-password').value;
                    
                    if (!password) {
                        alert('يرجى إدخال كلمة مرور.');
                        return;
                    }
                    
                    // إنشاء مستخدم جديد
                    try {
                        // إنشاء المستخدم في Firebase Authentication
                        const userCredential = await auth.createUserWithEmailAndPassword(userData.email, password);
                        const user = userCredential.user;
                        
                        // حفظ بيانات المستخدم في Firestore
                        await db.collection('users').doc(user.uid).set(userData);
                        
                        // تعيين اسم العرض للمستخدم
                        await user.updateProfile({
                            displayName: userData.name
                        });
                    } catch (authError) {
                        console.error("Error creating user in Auth:", authError);
                        alert(getAuthErrorMessage(authError.code) || 'حدث خطأ أثناء إنشاء المستخدم.');
                        return;
                    }
                }
                
                hideModal('user-modal');
                loadUsersData();
            } catch (error) {
                console.error("Error saving user:", error);
                alert('حدث خطأ أثناء حفظ بيانات المستخدم.');
            }
        }
        
        // وظائف عرض وطباعة الحسابات والفواتير
        async function viewAccountDetails(customerId) {
            try {
                // جلب بيانات العميل
                const customerDoc = await db.collection('customers').doc(customerId).get();
                
                if (customerDoc.exists) {
                    const customerData = customerDoc.data();
                    document.getElementById('account-customer-name').textContent = customerData.name || '';
                    document.getElementById('account-balance').textContent = formatCurrency(customerData.balance || 0);
                    
                    // حساب عدد الفواتير المستحقة
                    const salesQuery = await db.collection('sales')
                        .where('customerId', '==', customerId)
                        .get();
                    
                    const dueInvoices = salesQuery.docs.filter(doc => {
                        const saleData = doc.data();
                        const total = parseFloat(saleData.total || 0);
                        const deposit = parseFloat(saleData.deposit || 0);
                        return total > deposit;
                    });
                    
                    document.getElementById('account-due-invoices').textContent = dueInvoices.length;
                    
                    // جلب معاملات العميل
                    await loadCustomerTransactions(customerId);
                    
                    showModal('account-details-modal');
                }
            } catch (error) {
                console.error("Error loading account details:", error);
            }
        }
        
        async function loadCustomerTransactions(customerId) {
            try {
                const transactions = [];
                let currentBalance = 0;
                
                // جلب معاملات المبيعات
                const salesQuery = await db.collection('sales')
                    .where('customerId', '==', customerId)
                    .get();
                
                salesQuery.forEach(doc => {
                    const saleData = doc.data();
                    const amount = parseFloat(saleData.total || 0);
                    
                    // إضافة قيمة الفاتورة إلى الرصيد
                    currentBalance += amount;
                    
                    transactions.push({
                        date: saleData.date,
                        documentNumber: saleData.number,
                        type: 'فاتورة مبيعات',
                        debit: formatCurrency(amount),
                        credit: '-',
                        balance: formatCurrency(currentBalance),
                        notes: saleData.notes || ''
                    });
                    
                    // إذا كان هناك عربون، أضف معاملة منفصلة
                    if (saleData.deposit && parseFloat(saleData.deposit) > 0) {
                        const deposit = parseFloat(saleData.deposit);
                        currentBalance -= deposit;
                        
                        transactions.push({
                            date: saleData.date,
                            documentNumber: `عربون ${saleData.number}`,
                            type: `دفعة عربون (${saleData.depositPaymentMethod})`,
                            debit: '-',
                            credit: formatCurrency(deposit),
                            balance: formatCurrency(currentBalance),
                            notes: saleData.notes || ''
                        });
                    }
                });
                
                // جلب معاملات المدفوعات
                const paymentsQuery = await db.collection('payments')
                    .where('customerId', '==', customerId)
                    .get();
                
                paymentsQuery.forEach(doc => {
                    const paymentData = doc.data();
                    const amount = parseFloat(paymentData.amount || 0);
                    
                    // خصم قيمة السداد من الرصيد
                    currentBalance -= amount;
                    
                    transactions.push({
                        date: paymentData.date,
                        documentNumber: paymentData.number,
                        type: `دفعة سداد (${paymentData.paymentMethod})`,
                        debit: '-',
                        credit: formatCurrency(amount),
                        balance: formatCurrency(currentBalance),
                        notes: paymentData.notes || ''
                    });
                });
                
                // جلب معاملات المرتجعات
                const returnsQuery = await db.collection('returns')
                    .where('customerId', '==', customerId)
                    .get();
                
                returnsQuery.forEach(doc => {
                    const returnData = doc.data();
                    const amount = parseFloat(returnData.amount || 0);
                    
                    // خصم قيمة المرتجع من الرصيد
                    currentBalance -= amount;
                    
                    transactions.push({
                        date: returnData.date,
                        documentNumber: returnData.number,
                        type: 'فاتورة مرتجع',
                        debit: '-',
                        credit: formatCurrency(amount),
                        balance: formatCurrency(currentBalance),
                        notes: returnData.notes || ''
                    });
                });
                
                // ترتيب المعاملات حسب التاريخ
                transactions.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return dateA - dateB;
                });
                
                // تحديث الجدول
                const table = $('#account-transactions-table').DataTable();
                table.clear();
                table.rows.add(transactions);
                table.draw();
                
            } catch (error) {
                console.error("Error loading customer transactions:", error);
            }
        }
        
        function printAccountStatement() {
            // فتح نافذة الطباعة
            window.print();
        }
        
        function exportAccountToPDF() {
            const { jsPDF } = window.jspdf;
            const { autoTable } = window.jspdf.autoTable;
            
            // إنشاء مستند PDF جديد
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // إضافة عنوان الصفحة
            doc.setFont("Helvetica", "bold");
            doc.setFontSize(18);
            doc.text("كشف حساب عميل", 105, 15, { align: "center" });
            
            // إضافة بيانات العميل
            doc.setFontSize(14);
            doc.text(`اسم العميل: ${document.getElementById('account-customer-name').textContent}`, 190, 25, { align: "right" });
            doc.text(`الرصيد: ${document.getElementById('account-balance').textContent}`, 190, 32, { align: "right" });
            
            // إضافة الجدول
            const tableData = [];
            const table = $('#account-transactions-table').DataTable();
            
            table.rows().every(function() {
                const rowData = this.data();
                tableData.push([
                    rowData.notes,
                    rowData.balance,
                    rowData.credit,
                    rowData.debit,
                    rowData.type,
                    rowData.documentNumber,
                    rowData.date
                ]);
            });
            
            autoTable(doc, {
                head: [['ملاحظات', 'الرصيد', 'دائن', 'مدين', 'نوع المعاملة', 'رقم المستند', 'التاريخ']],
                body: tableData,
                startY: 40,
                styles: { font: "Helvetica", halign: "right" },
                headStyles: { fillColor: [93, 92, 222] },
                theme: 'grid',
                pageBreak: 'auto',
                margin: { right: 10, left: 10 }
            });
            
            // حفظ المستند
            doc.save(`كشف_حساب_${document.getElementById('account-customer-name').textContent}.pdf`);
        }
        
        async function viewSaleInvoice(saleId) {
            try {
                // جلب بيانات الفاتورة
                const doc = await db.collection('sales').doc(saleId).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    
                    document.getElementById('invoice-number-display').textContent = data.number || '';
                    document.getElementById('invoice-date-display').textContent = data.date || '';
                    document.getElementById('invoice-customer-display').textContent = data.customerName || '';
                    document.getElementById('invoice-payment-method-display').textContent = data.paymentMethod || '';
                    document.getElementById('invoice-notes-display').textContent = data.notes || '';
                    document.getElementById('invoice-subtotal-display').textContent = formatCurrency(parseFloat(data.subtotal || 0));
                    document.getElementById('invoice-discount-display').textContent = `${data.discount || 0}%`;
                    document.getElementById('invoice-total-display').textContent = formatCurrency(parseFloat(data.total || 0));
                    
                    // عرض العربون إذا وجد
                    if (data.deposit && parseFloat(data.deposit) > 0) {
                        document.getElementById('invoice-deposit-container').classList.remove('hidden');
                        document.getElementById('invoice-deposit-method-display').textContent = data.depositPaymentMethod || '';
                        document.getElementById('invoice-deposit-display').textContent = formatCurrency(parseFloat(data.deposit || 0));
                    } else {
                        document.getElementById('invoice-deposit-container').classList.add('hidden');
                    }
                    
                    // إضافة عناصر الفاتورة
                    const itemsContainer = document.getElementById('invoice-items');
                    itemsContainer.innerHTML = '';
                    
                    const items = data.items || [];
                    items.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-4 py-2 border-b dark:border-gray-700">${item.name}</td>
                            <td class="px-4 py-2 border-b dark:border-gray-700">${item.batch}</td>
                            <td class="px-4 py-2 border-b dark:border-gray-700">${item.quantity}</td>
                            <td class="px-4 py-2 border-b dark:border-gray-700">${formatCurrency(parseFloat(item.price || 0))}</td>
                            <td class="px-4 py-2 border-b dark:border-gray-700">${formatCurrency(parseFloat(item.total || 0))}</td>
                        `;
                        itemsContainer.appendChild(row);
                    });
                    
                    showModal('invoice-details-modal');
                }
            } catch (error) {
                console.error("Error loading invoice details:", error);
            }
        }
        
        async function viewReturnInvoice(returnId) {
            try {
                // جلب بيانات فاتورة المرتجع
                const doc = await db.collection('returns').doc(returnId).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    
                    document.getElementById('invoice-number-display').textContent = data.number || '';
                    document.getElementById('invoice-date-display').textContent = data.date || '';
                    document.getElementById('invoice-customer-display').textContent = data.customerName || '';
                    document.getElementById('invoice-payment-method-display').textContent = 'مرتجع';
                    document.getElementById('invoice-notes-display').textContent = data.notes || '';
                    document.getElementById('invoice-subtotal-display').textContent = formatCurrency(parseFloat(data.amount || 0));
                    document.getElementById('invoice-discount-display').textContent = '0%';
                    document.getElementById('invoice-total-display').textContent = formatCurrency(parseFloat(data.amount || 0));
                    
                    // إخفاء قسم العربون
                    document.getElementById('invoice-deposit-container').classList.add('hidden');
                    
                    // إضافة عناصر المرتجع
                    const itemsContainer = document.getElementById('invoice-items');
                    itemsContainer.innerHTML = '';
                    
                    const items = data.items || [];
                    items.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-4 py-2 border-b dark:border-gray-700">${item.name}</td>
                            <td class="px-4 py-2 border-b dark:border-gray-700">${item.batch}</td>
                            <td class="px-4 py-2 border-b dark:border-gray-700">${item.returnedQuantity}</td>
                            <td class="px-4 py-2 border-b dark:border-gray-700">${formatCurrency(parseFloat(item.price || 0))}</td>
                            <td class="px-4 py-2 border-b dark:border-gray-700">${formatCurrency(parseFloat(item.amount || 0))}</td>
                        `;
                        itemsContainer.appendChild(row);
                    });
                    
                    showModal('invoice-details-modal');
                }
            } catch (error) {
                console.error("Error loading return invoice details:", error);
            }
        }
        
        function printInvoice() {
            // فتح نافذة الطباعة
            window.print();
        }
        
        function exportInvoiceToPDF() {
            const { jsPDF } = window.jspdf;
            const { autoTable } = window.jspdf.autoTable;
            
            // إنشاء مستند PDF جديد
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // إضافة عنوان الصفحة
            doc.setFont("Helvetica", "bold");
            doc.setFontSize(18);
            doc.text("فاتورة", 105, 15, { align: "center" });
            
            // إضافة بيانات الفاتورة
            doc.setFontSize(12);
            doc.text(`رقم الفاتورة: ${document.getElementById('invoice-number-display').textContent}`, 190, 25, { align: "right" });
            doc.text(`التاريخ: ${document.getElementById('invoice-date-display').textContent}`, 190, 32, { align: "right" });
            doc.text(`العميل: ${document.getElementById('invoice-customer-display').textContent}`, 190, 39, { align: "right" });
            doc.text(`طريقة الدفع: ${document.getElementById('invoice-payment-method-display').textContent}`, 190, 46, { align: "right" });
            
            // إضافة جدول العناصر
            const tableData = [];
            const rows = document.querySelectorAll('#invoice-items tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                tableData.push([
                    cells[4].textContent,
                    cells[3].textContent,
                    cells[2].textContent,
                    cells[1].textContent,
                    cells[0].textContent
                ]);
            });
            
            autoTable(doc, {
                head: [['الإجمالي', 'السعر', 'الكمية', 'الباتش/اللون', 'المنتج']],
                body: tableData,
                startY: 55,
                styles: { font: "Helvetica", halign: "right" },
                headStyles: { fillColor: [93, 92, 222] },
                theme: 'grid',
                margin: { right: 10, left: 10 }
            });
            
            // إضافة ملخص الفاتورة
            const finalY = doc.lastAutoTable.finalY || 150;
            
            doc.text(`المبلغ قبل الخصم: ${document.getElementById('invoice-subtotal-display').textContent}`, 190, finalY + 10, { align: "right" });
            doc.text(`الخصم: ${document.getElementById('invoice-discount-display').textContent}`, 190, finalY + 17, { align: "right" });
            
            // إضافة معلومات العربون إذا وجد
            if (!document.getElementById('invoice-deposit-container').classList.contains('hidden')) {
                doc.text(`العربون (${document.getElementById('invoice-deposit-method-display').textContent}): ${document.getElementById('invoice-deposit-display').textContent}`, 190, finalY + 24, { align: "right" });
                doc.text(`المبلغ النهائي: ${document.getElementById('invoice-total-display').textContent}`, 190, finalY + 31, { align: "right" });
            } else {
                doc.text(`المبلغ النهائي: ${document.getElementById('invoice-total-display').textContent}`, 190, finalY + 24, { align: "right" });
            }
            
            // إضافة التوقيع
            doc.text("توقيع المستلم: ________________", 50, finalY + 40, { align: "left" });
            doc.text("توقيع المسؤول: ________________", 190, finalY + 40, { align: "right" });
            
            // حفظ المستند
            doc.save(`فاتورة_${document.getElementById('invoice-number-display').textContent}.pdf`);
        }
        
        // وظائف مساعدة عامة
        function showDeleteConfirmation(collection, id) {
            const deleteMessage = document.getElementById('delete-message');
            const deleteConfirmBtn = document.getElementById('delete-confirm');
            
            // تعيين رسالة التأكيد حسب نوع العنصر
            switch(collection) {
                case 'customers':
                    deleteMessage.textContent = 'هل أنت متأكد من أنك تريد حذف هذا العميل؟ سيتم حذف جميع المعاملات المرتبطة به.';
                    break;
                case 'products':
                    deleteMessage.textContent = 'هل أنت متأكد من أنك تريد حذف هذا المنتج؟ قد يؤثر ذلك على الفواتير الموجودة.';
                    break;
                case 'sales':
                    deleteMessage.textContent = 'هل أنت متأكد من أنك تريد حذف هذه الفاتورة؟ سيتم تحديث رصيد العميل.';
                    break;
                case 'returns':
                    deleteMessage.textContent = 'هل أنت متأكد من أنك تريد حذف فاتورة المرتجع هذه؟ سيتم تحديث رصيد العميل.';
                    break;
                case 'payments':
                    deleteMessage.textContent = 'هل أنت متأكد من أنك تريد حذف هذا السداد؟ سيتم تحديث رصيد العميل.';
                    break;
                case 'users':
                    deleteMessage.textContent = 'هل أنت متأكد من أنك تريد حذف هذا المستخدم؟ لن يتمكن من الوصول إلى النظام بعد الحذف.';
                    break;
                default:
                    deleteMessage.textContent = 'هل أنت متأكد من أنك تريد حذف هذا العنصر؟';
            }
            
            // تخزين المعلومات للاستخدام في تأكيد الحذف
            deleteConfirmBtn.setAttribute('data-collection', collection);
            deleteConfirmBtn.setAttribute('data-id', id);
            
            showModal('delete-modal');
        }
        
        async function confirmDelete() {
            const deleteConfirmBtn = document.getElementById('delete-confirm');
            const collection = deleteConfirmBtn.getAttribute('data-collection');
            const id = deleteConfirmBtn.getAttribute('data-id');
            
            try {
                // حفظ معرف العميل قبل الحذف للوحدات التي تحتاج إلى تحديث رصيد العميل
                let customerId = null;
                
                if (collection === 'sales' || collection === 'returns' || collection === 'payments') {
                    const docRef = await db.collection(collection).doc(id).get();
                    if (docRef.exists) {
                        customerId = docRef.data().customerId;
                    }
                }
                
                // حذف العنصر
                await db.collection(collection).doc(id).delete();
                
                // في حالة حذف المستخدم، يجب حذفه من Firebase Authentication أيضًا
                if (collection === 'users' && id !== auth.currentUser.uid) {
                    // لا يمكن حذف المستخدم من Auth مباشرة من الواجهة الأمامية
                    // يمكن تنفيذ ذلك من خلال Cloud Function
                    console.log("تم حذف المستخدم من Firestore، ويجب حذفه من Auth أيضًا من لوحة تحكم Firebase.");
                }
                
                // تحديث رصيد العميل إذا لزم الأمر
                if (customerId) {
                    await updateCustomerBalance(customerId);
                }
                
                hideModal('delete-modal');
                
                // تحديث البيانات في الواجهة حسب نوع العنصر المحذوف
                switch(collection) {
                    case 'customers':
                        loadCustomersData();
                        break;
                    case 'products':
                        loadProductsData();
                        break;
                    case 'sales':
                        loadSalesData();
                        break;
                    case 'returns':
                        loadReturnsData();
                        break;
                    case 'payments':
                        loadPaymentsData();
                        break;
                    case 'users':
                        loadUsersData();
                        break;
                }
            } catch (error) {
                console.error(`Error deleting ${collection} item:`, error);
                alert(`حدث خطأ أثناء حذف العنصر: ${error.message}`);
            }
        }
        
        async function updateCustomerBalance(customerId) {
            try {
                let balance = 0;
                
                // حساب رصيد المبيعات
                const salesQuery = await db.collection('sales')
                    .where('customerId', '==', customerId)
                    .get();
                
                salesQuery.forEach(doc => {
                    const sale = doc.data();
                    
                    // إضافة إجمالي الفاتورة
                    balance += parseFloat(sale.total || 0);
                    
                    // خصم العربون إذا وجد
                    if (sale.deposit) {
                        balance -= parseFloat(sale.deposit || 0);
                    }
                });
                
                // خصم المدفوعات
                const paymentsQuery = await db.collection('payments')
                    .where('customerId', '==', customerId)
                    .get();
                
                paymentsQuery.forEach(doc => {
                    const payment = doc.data();
                    balance -= parseFloat(payment.amount || 0);
                });
                
                // خصم المرتجعات
                const returnsQuery = await db.collection('returns')
                    .where('customerId', '==', customerId)
                    .get();
                
                returnsQuery.forEach(doc => {
                    const returnItem = doc.data();
                    balance -= parseFloat(returnItem.amount || 0);
                });
                
                // تحديث رصيد العميل
                await db.collection('customers').doc(customerId).update({
                    balance: balance
                });
                
                return balance;
            } catch (error) {
                console.error("Error updating customer balance:", error);
                throw error;
            }
        }
        
        async function loadCustomersSelect(selectId) {
            try {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">-- اختر العميل --</option>';
                
                const querySnapshot = await db.collection('customers').get();
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = data.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error(`Error loading customers select (${selectId}):`, error);
            }
        }
        
        async function loadSalesSelect(selectId) {
            try {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">-- اختر فاتورة --</option>';
                
                const querySnapshot = await db.collection('sales').get();
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = data.number || '';
                    select.appendChild(option);
                });
            } catch (error) {
                console.error(`Error loading sales select (${selectId}):`, error);
            }
        }
        
        async function generateNewInvoiceNumber(collection) {
            try {
                const querySnapshot = await db.collection(collection).orderBy('number', 'desc').limit(1).get();
                
                let lastNumber = 0;
                
                if (!querySnapshot.empty) {
                    const lastInvoice = querySnapshot.docs[0].data();
                    const lastInvoiceNumber = lastInvoice.number || '';
                    
                    // استخراج الرقم من رقم الفاتورة
                    const match = lastInvoiceNumber.match(/(\d+)$/);
                    if (match) {
                        lastNumber = parseInt(match[1], 10);
                    }
                }
                
                // إنشاء رقم فاتورة جديد
                const prefix = collection === 'sales' ? 'INV-' : 
                              collection === 'returns' ? 'RET-' : 
                              collection === 'payments' ? 'PAY-' : '';
                
                const newNumber = lastNumber + 1;
                const paddedNumber = newNumber.toString().padStart(5, '0');
                
                return `${prefix}${paddedNumber}`;
            } catch (error) {
                console.error(`Error generating new invoice number for ${collection}:`, error);
                
                // إرجاع رقم افتراضي في حالة الخطأ
                const prefix = collection === 'sales' ? 'INV-' : 
                              collection === 'returns' ? 'RET-' : 
                              collection === 'payments' ? 'PAY-' : '';
                
                const timestamp = new Date().getTime().toString().slice(-5);
                return `${prefix}${timestamp}`;
            }
        }
        
        // بدء التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            setupAuth();
            setupNavigation();
            initializeDataTables();
            setupForms();
        });
    </script>
</body>
</html>

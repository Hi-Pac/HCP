<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة شركة الدهانات</title>
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#4CAF50',
                        danger: '#f44336',
                        warning: '#ff9800',
                        info: '#2196F3',
                    },
                },
            },
            darkMode: 'class',
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap');
        
        * {
            font-family: 'Tajawal', sans-serif;
        }
        
        body.dark {
            background-color: #181818;
            color: #e5e5e5;
        }
        
        body.dark .bg-white {
            background-color: #2a2a2a !important;
        }
        
        body.dark .border-gray-200 {
            border-color: #3a3a3a !important;
        }
        
        body.dark .text-gray-700 {
            color: #e5e5e5 !important;
        }
        
        body.dark .bg-gray-50 {
            background-color: #3a3a3a !important;
        }
        
        body.dark .shadow {
            box-shadow: 0 1px 3px 0 rgba(255, 255, 255, 0.1), 0 1px 2px 0 rgba(255, 255, 255, 0.06) !important;
        }
        
        /* تحسين الأداء للحركات والتحولات */
        .sidebar {
            transition: all 0.3s ease;
        }
        
        .inactive-view {
            display: none !important;
        }
        
        /* أنماط خاصة بالنماذج */
        .form-input {
            @apply block w-full px-4 py-2 mt-2 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary;
        }
        
        .form-label {
            @apply block mb-2 text-sm font-medium text-gray-700;
        }
        
        .btn {
            @apply px-4 py-2 text-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        
        .btn-primary {
            @apply bg-primary hover:bg-opacity-90 focus:ring-primary;
        }
        
        .btn-secondary {
            @apply bg-secondary hover:bg-opacity-90 focus:ring-secondary;
        }
        
        .btn-danger {
            @apply bg-danger hover:bg-opacity-90 focus:ring-danger;
        }
        
        /* أنماط خاصة بالجداول */
        .data-table {
            @apply min-w-full divide-y divide-gray-200;
        }
        
        .data-table th {
            @apply px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider;
        }
        
        .data-table td {
            @apply px-6 py-4 whitespace-nowrap text-sm text-gray-500;
        }
        
        /* تأثيرات الحركة */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* تخصيص الموديلات */
        .modal {
            @apply fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50;
        }
        
        .modal-content {
            @apply bg-white w-full max-w-md md:max-w-xl rounded-lg shadow-lg p-6 m-4;
        }
        
        body.dark .modal-content {
            @apply bg-gray-800;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- حاوية الصفحة الرئيسية -->
    <div id="app" class="min-h-screen flex flex-col">
    
        <!-- صفحة تسجيل الدخول -->
        <div id="loginPage" class="flex items-center justify-center min-h-screen p-6">
            <div class="w-full max-w-md">
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-primary">نظام إدارة شركة الدهانات</h2>
                        <p class="text-gray-600 mt-2">يرجى تسجيل الدخول للمتابعة</p>
                    </div>
                    
                    <form id="loginForm" class="space-y-6">
                        <div>
                            <label for="email" class="form-label">البريد الإلكتروني</label>
                            <input type="email" id="email" name="email" required class="form-input text-base" placeholder="أدخل البريد الإلكتروني">
                        </div>
                        
                        <div>
                            <label for="password" class="form-label">كلمة المرور</label>
                            <input type="password" id="password" name="password" required class="form-input text-base" placeholder="أدخل كلمة المرور">
                        </div>
                        
                        <div>
                            <button type="submit" class="w-full btn btn-primary">تسجيل الدخول</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- الهيكل الرئيسي للتطبيق (يظهر بعد تسجيل الدخول) -->
        <div id="mainApp" class="hidden flex-grow flex flex-col md:flex-row">
            <!-- الشريط الجانبي -->
            <div id="sidebar" class="sidebar bg-white shadow-md w-full md:w-64 md:min-h-screen md:fixed z-10">
                <div class="p-6 border-b border-gray-200">
                    <h1 class="text-2xl font-bold text-primary">شركة الدهانات</h1>
                    <p id="userRoleDisplay" class="text-sm text-gray-600 mt-1">مرحباً، <span id="userNameDisplay"></span></p>
                </div>
                
                <nav class="p-4">
                    <ul class="space-y-2">
                        <li>
                            <a href="#" class="nav-link flex items-center p-3 text-gray-700 rounded-md hover:bg-gray-100" data-view="dashboard">
                                <i class="fas fa-tachometer-alt w-6"></i>
                                <span>لوحة التحكم</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="nav-link flex items-center p-3 text-gray-700 rounded-md hover:bg-gray-100" data-view="products">
                                <i class="fas fa-paint-roller w-6"></i>
                                <span>إدارة المنتجات</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="nav-link flex items-center p-3 text-gray-700 rounded-md hover:bg-gray-100" data-view="clients">
                                <i class="fas fa-users w-6"></i>
                                <span>إدارة العملاء</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="nav-link flex items-center p-3 text-gray-700 rounded-md hover:bg-gray-100" data-view="orders">
                                <i class="fas fa-shopping-cart w-6"></i>
                                <span>الطلبات</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="nav-link flex items-center p-3 text-gray-700 rounded-md hover:bg-gray-100" data-view="invoices">
                                <i class="fas fa-file-invoice w-6"></i>
                                <span>الفواتير</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="nav-link flex items-center p-3 text-gray-700 rounded-md hover:bg-gray-100" data-view="payments">
                                <i class="fas fa-money-bill-wave w-6"></i>
                                <span>سداد العملاء</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="nav-link flex items-center p-3 text-gray-700 rounded-md hover:bg-gray-100" data-view="statements">
                                <i class="fas fa-file-alt w-6"></i>
                                <span>كشف حساب العملاء</span>
                            </a>
                        </li>
                        <li id="adminUserSection" class="hidden">
                            <a href="#" class="nav-link flex items-center p-3 text-gray-700 rounded-md hover:bg-gray-100" data-view="users">
                                <i class="fas fa-user-cog w-6"></i>
                                <span>إدارة المستخدمين</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="nav-link flex items-center p-3 text-gray-700 rounded-md hover:bg-gray-100" data-view="returns">
                                <i class="fas fa-undo-alt w-6"></i>
                                <span>مرتجعات العملاء</span>
                            </a>
                        </li>
                        <li class="pt-4 border-t border-gray-200 mt-4">
                            <a href="#" id="logoutBtn" class="flex items-center p-3 text-red-600 rounded-md hover:bg-red-50">
                                <i class="fas fa-sign-out-alt w-6"></i>
                                <span>تسجيل الخروج</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
            
            <!-- المحتوى الرئيسي -->
            <div id="content" class="flex-grow p-6 md:mr-64">
                <!-- رأس الصفحة -->
                <div class="flex flex-wrap items-center justify-between mb-6">
                    <button id="menuToggle" class="md:hidden p-2 mr-2 bg-white rounded-md shadow">
                        <i class="fas fa-bars text-gray-700"></i>
                    </button>
                    
                    <div class="flex items-center space-x-2 ml-4">
                        <button id="darkModeToggle" class="p-2 bg-white rounded-full shadow">
                            <i class="fas fa-moon text-gray-700"></i>
                        </button>
                    </div>
                </div>
                
                <!-- صفحات التطبيق المختلفة -->
                
                <!-- 1. لوحة التحكم -->
                <div id="dashboard-view" class="app-view">
                    <h2 class="text-2xl font-bold mb-6">لوحة التحكم</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <!-- إحصائية 1 -->
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-full">
                                    <i class="fas fa-shopping-cart text-blue-500"></i>
                                </div>
                                <div class="mr-4">
                                    <h3 class="text-lg font-medium text-gray-700">إجمالي الطلبات</h3>
                                    <p id="totalOrdersCount" class="text-2xl font-bold">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- إحصائية 2 -->
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-full">
                                    <i class="fas fa-money-bill-wave text-green-500"></i>
                                </div>
                                <div class="mr-4">
                                    <h3 class="text-lg font-medium text-gray-700">إجمالي المبيعات</h3>
                                    <p id="totalSalesAmount" class="text-2xl font-bold">0 ج.م</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- إحصائية 3 -->
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-full">
                                    <i class="fas fa-users text-yellow-500"></i>
                                </div>
                                <div class="mr-4">
                                    <h3 class="text-lg font-medium text-gray-700">العملاء النشطين</h3>
                                    <p id="activeClientsCount" class="text-2xl font-bold">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- إحصائية 4 -->
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="flex items-center">
                                <div class="p-3 bg-red-100 rounded-full">
                                    <i class="fas fa-exclamation-triangle text-red-500"></i>
                                </div>
                                <div class="mr-4">
                                    <h3 class="text-lg font-medium text-gray-700">طلبات معلقة</h3>
                                    <p id="pendingOrdersCount" class="text-2xl font-bold">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- الرسوم البيانية -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-medium text-gray-700 mb-4">المبيعات الشهرية</h3>
                            <div class="h-64">
                                <canvas id="monthlySalesChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-medium text-gray-700 mb-4">المنتجات الأكثر مبيعًا</h3>
                            <div class="h-64">
                                <canvas id="topProductsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 2. إدارة المنتجات -->
                <div id="products-view" class="app-view inactive-view">
                    <div class="flex flex-wrap items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold">إدارة المنتجات</h2>
                        <button id="addProductBtn" class="btn btn-primary flex items-center">
                            <i class="fas fa-plus mr-2"></i> إضافة منتج جديد
                        </button>
                    </div>
                    
                    <!-- فلتر البحث -->
                    <div class="bg-white p-4 rounded-lg shadow mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="productCategoryFilter" class="form-label">تصنيف المنتج</label>
                                <select id="productCategoryFilter" class="form-input text-base">
                                    <option value="">الكل</option>
                                    <option value="construction">إنشائي</option>
                                    <option value="exterior">واجهات خارجية</option>
                                    <option value="decorative">ديكوري</option>
                                </select>
                            </div>
                            <div>
                                <label for="productNameFilter" class="form-label">اسم المنتج</label>
                                <input type="text" id="productNameFilter" class="form-input text-base" placeholder="ابحث عن منتج...">
                            </div>
                            <div class="flex items-end">
                                <button id="filterProductsBtn" class="btn btn-primary w-full">تطبيق الفلتر</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- جدول المنتجات -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto">
                            <table id="productsTable" class="data-table">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col">التصنيف</th>
                                        <th scope="col">اسم المنتج</th>
                                        <th scope="col">الباتش/اللون</th>
                                        <th scope="col">السعر</th>
                                        <th scope="col">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <!-- سيتم ملء البيانات هنا ديناميكيًا -->
                                    <tr class="text-center">
                                        <td colspan="5" class="py-4">جاري تحميل البيانات...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- 3. إدارة العملاء -->
                <div id="clients-view" class="app-view inactive-view">
                    <div class="flex flex-wrap items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold">إدارة العملاء</h2>
                        <button id="addClientBtn" class="btn btn-primary flex items-center">
                            <i class="fas fa-plus mr-2"></i> إضافة عميل جديد
                        </button>
                    </div>
                    
                    <!-- فلتر البحث -->
                    <div class="bg-white p-4 rounded-lg shadow mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="clientTypeFilter" class="form-label">تصنيف العميل</label>
                                <select id="clientTypeFilter" class="form-input text-base">
                                    <option value="">الكل</option>
                                    <option value="organization">هيئات/مشاريع</option>
                                    <option value="shop">محلات</option>
                                    <option value="individual">أهالي</option>
                                </select>
                            </div>
                            <div>
                                <label for="clientNameFilter" class="form-label">اسم العميل</label>
                                <input type="text" id="clientNameFilter" class="form-input text-base" placeholder="ابحث عن عميل...">
                            </div>
                            <div class="flex items-end">
                                <button id="filterClientsBtn" class="btn btn-primary w-full">تطبيق الفلتر</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- جدول العملاء -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto">
                            <table id="clientsTable" class="data-table">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col">الاسم</th>
                                        <th scope="col">رقم الهاتف</th>
                                        <th scope="col">العنوان</th>
                                        <th scope="col">التصنيف</th>
                                        <th scope="col">نسبة الخصم</th>
                                        <th scope="col">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <!-- سيتم ملء البيانات هنا ديناميكيًا -->
                                    <tr class="text-center">
                                        <td colspan="6" class="py-4">جاري تحميل البيانات...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- 4. الطلبات -->
                <div id="orders-view" class="app-view inactive-view">
                    <div class="flex flex-wrap items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold">إدارة الطلبات</h2>
                        <button id="addOrderBtn" class="btn btn-primary flex items-center">
                            <i class="fas fa-plus mr-2"></i> إنشاء طلب جديد
                        </button>
                    </div>
                    
                    <!-- فلتر البحث -->
                    <div class="bg-white p-4 rounded-lg shadow mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="orderStatusFilter" class="form-label">حالة الطلب</label>
                                <select id="orderStatusFilter" class="form-input text-base">
                                    <option value="">الكل</option>
                                    <option value="pending">معلق</option>
                                    <option value="completed">مكتمل</option>
                                    <option value="cancelled">ملغي</option>
                                </select>
                            </div>
                            <div>
                                <label for="orderClientFilter" class="form-label">اسم العميل</label>
                                <input type="text" id="orderClientFilter" class="form-input text-base" placeholder="ابحث عن عميل...">
                            </div>
                            <div class="flex items-end">
                                <button id="filterOrdersBtn" class="btn btn-primary w-full">تطبيق الفلتر</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- جدول الطلبات -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto">
                            <table id="ordersTable" class="data-table">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col">رقم الطلب</th>
                                        <th scope="col">التاريخ</th>
                                        <th scope="col">العميل</th>
                                        <th scope="col">المبلغ الإجمالي</th>
                                        <th scope="col">طريقة الدفع</th>
                                        <th scope="col">الحالة</th>
                                        <th scope="col">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <!-- سيتم ملء البيانات هنا ديناميكيًا -->
                                    <tr class="text-center">
                                        <td colspan="7" class="py-4">جاري تحميل البيانات...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- 5. الفواتير -->
                <div id="invoices-view" class="app-view inactive-view">
                    <h2 class="text-2xl font-bold mb-6">عرض الفواتير</h2>
                    
                    <!-- فلتر البحث -->
                    <div class="bg-white p-4 rounded-lg shadow mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label for="invoiceOrderIdFilter" class="form-label">رقم الطلب</label>
                                <input type="text" id="invoiceOrderIdFilter" class="form-input text-base" placeholder="رقم الطلب...">
                            </div>
                            <div>
                                <label for="invoiceClientFilter" class="form-label">اسم العميل</label>
                                <input type="text" id="invoiceClientFilter" class="form-input text-base" placeholder="اسم العميل...">
                            </div>
                            <div>
                                <label for="invoiceDateFilter" class="form-label">تاريخ الفاتورة</label>
                                <input type="date" id="invoiceDateFilter" class="form-input text-base">
                            </div>
                            <div class="flex items-end">
                                <button id="filterInvoicesBtn" class="btn btn-primary w-full">تطبيق الفلتر</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- جدول الفواتير -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto">
                            <table id="invoicesTable" class="data-table">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col">رقم الفاتورة</th>
                                        <th scope="col">رقم الطلب</th>
                                        <th scope="col">التاريخ</th>
                                        <th scope="col">العميل</th>
                                        <th scope="col">المبلغ الإجمالي</th>
                                        <th scope="col">حالة الدفع</th>
                                        <th scope="col">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <!-- سيتم ملء البيانات هنا ديناميكيًا -->
                                    <tr class="text-center">
                                        <td colspan="7" class="py-4">جاري تحميل البيانات...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- 6. سداد العملاء -->
                <div id="payments-view" class="app-view inactive-view">
                    <div class="flex flex-wrap items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold">سداد العملاء</h2>
                        <button id="addPaymentBtn" class="btn btn-primary flex items-center">
                            <i class="fas fa-plus mr-2"></i> تسجيل سداد جديد
                        </button>
                    </div>
                    
                    <!-- فلتر البحث -->
                    <div class="bg-white p-4 rounded-lg shadow mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="paymentClientFilter" class="form-label">اسم العميل</label>
                                <input type="text" id="paymentClientFilter" class="form-input text-base" placeholder="ابحث عن عميل...">
                            </div>
                            <div>
                                <label for="paymentDateFilter" class="form-label">تاريخ السداد</label>
                                <input type="date" id="paymentDateFilter" class="form-input text-base">
                            </div>
                            <div class="flex items-end">
                                <button id="filterPaymentsBtn" class="btn btn-primary w-full">تطبيق الفلتر</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- جدول المدفوعات -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto">
                            <table id="paymentsTable" class="data-table">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col">رقم السداد</th>
                                        <th scope="col">التاريخ</th>
                                        <th scope="col">العميل</th>
                                        <th scope="col">المبلغ المدفوع</th>
                                        <th scope="col">طريقة الدفع</th>
                                        <th scope="col">ملاحظات</th>
                                        <th scope="col">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <!-- سيتم ملء البيانات هنا ديناميكيًا -->
                                    <tr class="text-center">
                                        <td colspan="7" class="py-4">جاري تحميل البيانات...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- 7. كشف حساب العملاء -->
                <div id="statements-view" class="app-view inactive-view">
                    <h2 class="text-2xl font-bold mb-6">كشف حساب العملاء</h2>
                    
                    <!-- فلتر البحث -->
                    <div class="bg-white p-4 rounded-lg shadow mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label for="statementClientFilter" class="form-label">اختر العميل</label>
                                <select id="statementClientFilter" class="form-input text-base">
                                    <option value="">-- اختر العميل --</option>
                                    <!-- سيتم ملء الخيارات ديناميكيًا -->
                                </select>
                            </div>
                            <div>
                                <label for="statementStartDate" class="form-label">من تاريخ</label>
                                <input type="date" id="statementStartDate" class="form-input text-base">
                            </div>
                            <div>
                                <label for="statementEndDate" class="form-label">إلى تاريخ</label>
                                <input type="date" id="statementEndDate" class="form-input text-base">
                            </div>
                            <div class="flex items-end">
                                <button id="generateStatementBtn" class="btn btn-primary w-full">عرض كشف الحساب</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- كشف الحساب -->
                    <div id="statementResult" class="hidden">
                        <div class="bg-white p-6 rounded-lg shadow mb-6">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h3 class="text-xl font-bold" id="statementClientName">اسم العميل: </h3>
                                    <p class="text-gray-600" id="statementDateRange">الفترة: </p>
                                </div>
                                <button id="printStatementBtn" class="btn btn-primary">
                                    <i class="fas fa-print mr-2"></i> طباعة
                                </button>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="data-table" id="statementTable">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col">التاريخ</th>
                                            <th scope="col">البيان</th>
                                            <th scope="col">مدين</th>
                                            <th scope="col">دائن</th>
                                            <th scope="col">الرصيد</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        <!-- سيتم ملء البيانات هنا ديناميكيًا -->
                                    </tbody>
                                    <tfoot>
                                        <tr class="font-bold">
                                            <td colspan="2" class="px-6 py-4 text-left">الإجمالي</td>
                                            <td id="statementTotalDebit" class="px-6 py-4">0</td>
                                            <td id="statementTotalCredit" class="px-6 py-4">0</td>
                                            <td id="statementBalance" class="px-6 py-4">0</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 8. إدارة المستخدمين (للمسؤول فقط) -->
                <div id="users-view" class="app-view inactive-view">
                    <div class="flex flex-wrap items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold">إدارة المستخدمين</h2>
                        <button id="addUserBtn" class="btn btn-primary flex items-center">
                            <i class="fas fa-plus mr-2"></i> إضافة مستخدم جديد
                        </button>
                    </div>
                    
                    <!-- جدول المستخدمين -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto">
                            <table id="usersTable" class="data-table">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col">اسم المستخدم</th>
                                        <th scope="col">البريد الإلكتروني</th>
                                        <th scope="col">الدور</th>
                                        <th scope="col">تاريخ الإنشاء</th>
                                        <th scope="col">الحالة</th>
                                        <th scope="col">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <!-- سيتم ملء البيانات هنا ديناميكيًا -->
                                    <tr class="text-center">
                                        <td colspan="6" class="py-4">جاري تحميل البيانات...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- 9. مرتجعات العملاء -->
                <div id="returns-view" class="app-view inactive-view">
                    <div class="flex flex-wrap items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold">مرتجعات العملاء</h2>
                        <button id="addReturnBtn" class="btn btn-primary flex items-center">
                            <i class="fas fa-plus mr-2"></i> إضافة مرتجع جديد
                        </button>
                    </div>
                    
                    <!-- فلتر البحث -->
                    <div class="bg-white p-4 rounded-lg shadow mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="returnClientFilter" class="form-label">اسم العميل</label>
                                <input type="text" id="returnClientFilter" class="form-input text-base" placeholder="ابحث عن عميل...">
                            </div>
                            <div>
                                <label for="returnDateFilter" class="form-label">تاريخ المرتجع</label>
                                <input type="date" id="returnDateFilter" class="form-input text-base">
                            </div>
                            <div class="flex items-end">
                                <button id="filterReturnsBtn" class="btn btn-primary w-full">تطبيق الفلتر</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- جدول المرتجعات -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto">
                            <table id="returnsTable" class="data-table">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col">رقم المرتجع</th>
                                        <th scope="col">تاريخ المرتجع</th>
                                        <th scope="col">رقم الطلب</th>
                                        <th scope="col">العميل</th>
                                        <th scope="col">المنتج</th>
                                        <th scope="col">الكمية</th>
                                        <th scope="col">المبلغ</th>
                                        <th scope="col">السبب</th>
                                        <th scope="col">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <!-- سيتم ملء البيانات هنا ديناميكيًا -->
                                    <tr class="text-center">
                                        <td colspan="9" class="py-4">جاري تحميل البيانات...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- نماذج النوافذ المنبثقة (Modals) -->
    
    <!-- 1. نموذج إضافة/تعديل منتج -->
    <div id="productModal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="productModalTitle" class="text-lg font-bold">إضافة منتج جديد</h3>
                <button id="closeProductModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="productForm" class="space-y-4">
                <input type="hidden" id="productId">
                
                <div>
                    <label for="productCategory" class="form-label">تصنيف المنتج <span class="text-red-500">*</span></label>
                    <select id="productCategory" class="form-input text-base" required>
                        <option value="">-- اختر التصنيف --</option>
                        <option value="construction">إنشائي</option>
                        <option value="exterior">واجهات خارجية</option>
                        <option value="decorative">ديكوري</option>
                    </select>
                </div>
                
                <div>
                    <label for="productName" class="form-label">اسم المنتج <span class="text-red-500">*</span></label>
                    <input type="text" id="productName" class="form-input text-base" required>
                </div>
                
                <div>
                    <label for="productBatch" class="form-label">الباتش/اللون <span class="text-red-500">*</span></label>
                    <input type="text" id="productBatch" class="form-input text-base" required>
                </div>
                
                <div>
                    <label for="productPrice" class="form-label">السعر <span class="text-red-500">*</span></label>
                    <input type="number" id="productPrice" min="0" step="0.01" class="form-input text-base" required>
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelProductBtn" class="btn bg-gray-300 text-gray-800 hover:bg-gray-400">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 2. نموذج إضافة/تعديل عميل -->
    <div id="clientModal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="clientModalTitle" class="text-lg font-bold">إضافة عميل جديد</h3>
                <button id="closeClientModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="clientForm" class="space-y-4">
                <input type="hidden" id="clientId">
                
                <div>
                    <label for="clientName" class="form-label">اسم العميل <span class="text-red-500">*</span></label>
                    <input type="text" id="clientName" class="form-input text-base" required>
                </div>
                
                <div>
                    <label for="clientPhone" class="form-label">رقم الهاتف <span class="text-red-500">*</span></label>
                    <input type="text" id="clientPhone" class="form-input text-base" required>
                </div>
                
                <div>
                    <label for="clientAddress" class="form-label">العنوان</label>
                    <input type="text" id="clientAddress" class="form-input text-base">
                </div>
                
                <div>
                    <label for="clientType" class="form-label">تصنيف العميل <span class="text-red-500">*</span></label>
                    <select id="clientType" class="form-input text-base" required>
                        <option value="">-- اختر التصنيف --</option>
                        <option value="organization">هيئات/مشاريع</option>
                        <option value="shop">محلات</option>
                        <option value="individual">أهالي</option>
                    </select>
                </div>
                
                <div>
                    <label for="clientDiscount" class="form-label">نسبة الخصم (%)</label>
                    <input type="number" id="clientDiscount" min="0" max="100" class="form-input text-base" value="0">
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelClientBtn" class="btn bg-gray-300 text-gray-800 hover:bg-gray-400">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 3. نموذج إنشاء طلب جديد -->
    <div id="orderModal" class="modal hidden">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="orderModalTitle" class="text-lg font-bold">إنشاء طلب جديد</h3>
                <button id="closeOrderModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="orderForm" class="space-y-4">
                <input type="hidden" id="orderId">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="orderClient" class="form-label">العميل <span class="text-red-500">*</span></label>
                        <select id="orderClient" class="form-input text-base" required>
                            <option value="">-- اختر العميل --</option>
                            <!-- سيتم ملء الخيارات ديناميكيًا -->
                        </select>
                    </div>
                    
                    <div>
                        <label for="orderDate" class="form-label">تاريخ الطلب <span class="text-red-500">*</span></label>
                        <input type="date" id="orderDate" class="form-input text-base" required>
                    </div>
                    
                    <div>
                        <label for="orderPaymentMethod" class="form-label">طريقة الدفع <span class="text-red-500">*</span></label>
                        <select id="orderPaymentMethod" class="form-input text-base" required>
                            <option value="">-- اختر طريقة الدفع --</option>
                            <option value="cash">نقدي</option>
                            <option value="credit">آجل</option>
                            <option value="bank_transfer">تحويل بنكي</option>
                            <option value="vodafone_cash">فودافون كاش</option>
                            <option value="check">شيك</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="orderStatus" class="form-label">حالة الطلب <span class="text-red-500">*</span></label>
                        <select id="orderStatus" class="form-input text-base" required>
                            <option value="pending">معلق</option>
                            <option value="completed">مكتمل</option>
                            <option value="cancelled">ملغي</option>
                        </select>
                    </div>
                </div>
                
                <div class="border-t border-gray-300 pt-4">
                    <h4 class="text-md font-bold mb-2">بنود الطلب</h4>
                    
                    <div class="mb-2 flex justify-end">
                        <button type="button" id="addOrderItemBtn" class="btn btn-primary">
                            <i class="fas fa-plus ml-1"></i> إضافة بند
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table id="orderItemsTable" class="data-table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col">المنتج</th>
                                    <th scope="col">الباتش/اللون</th>
                                    <th scope="col">الكمية</th>
                                    <th scope="col">السعر</th>
                                    <th scope="col">الإجمالي</th>
                                    <th scope="col"></th>
                                </tr>
                            </thead>
                            <tbody id="orderItemsList">
                                <!-- سيتم ملء البنود ديناميكيًا -->
                                <tr class="text-center">
                                    <td colspan="6" class="py-4">لم يتم إضافة منتجات بعد</td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" class="text-left font-bold">المجموع</td>
                                    <td id="orderSubtotal" class="font-bold">0</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="text-left">الخصم (%)</td>
                                    <td>
                                        <input type="number" id="orderDiscount" class="form-input text-base w-full" min="0" max="100" value="0">
                                    </td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="text-left font-bold">المبلغ بعد الخصم</td>
                                    <td id="orderTotal" class="font-bold">0</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                <div>
                    <label for="orderNotes" class="form-label">ملاحظات</label>
                    <textarea id="orderNotes" class="form-input text-base" rows="3"></textarea>
                </div>
                
                <div class="flex items-center space-x-2 mb-4">
                    <input type="checkbox" id="orderDepositCheck" class="form-checkbox h-5 w-5 text-primary">
                    <label for="orderDepositCheck">تسجيل دفعة مقدمة (عربون)</label>
                </div>
                
                <div id="depositSection" class="hidden space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="depositAmount" class="form-label">قيمة العربون</label>
                            <input type="number" id="depositAmount" min="0" step="0.01" class="form-input text-base">
                        </div>
                        
                        <div>
                            <label for="depositMethod" class="form-label">طريقة دفع العربون</label>
                            <select id="depositMethod" class="form-input text-base">
                                <option value="cash">نقدي</option>
                                <option value="vodafone_cash">فودافون كاش</option>
                                <option value="bank_transfer">تحويل بنك</option>
                                <option value="check">شيك</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelOrderBtn" class="btn bg-gray-300 text-gray-800 hover:bg-gray-400">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ الطلب</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 4. نموذج إضافة بند للطلب -->
    <div id="orderItemModal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">إضافة منتج للطلب</h3>
                <button id="closeOrderItemModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="orderItemForm" class="space-y-4">
                <div>
                    <label for="itemProductCategory" class="form-label">تصنيف المنتج <span class="text-red-500">*</span></label>
                    <select id="itemProductCategory" class="form-input text-base" required>
                        <option value="">-- اختر التصنيف --</option>
                        <option value="construction">إنشائي</option>
                        <option value="exterior">واجهات خارجية</option>
                        <option value="decorative">ديكوري</option>
                    </select>
                </div>
                
                <div>
                    <label for="itemProductName" class="form-label">اسم المنتج <span class="text-red-500">*</span></label>
                    <select id="itemProductName" class="form-input text-base" required disabled>
                        <option value="">-- اختر المنتج --</option>
                    </select>
                </div>
                
                <div>
                    <label for="itemProductBatch" class="form-label">الباتش/اللون <span class="text-red-500">*</span></label>
                    <select id="itemProductBatch" class="form-input text-base" required disabled>
                        <option value="">-- اختر الباتش/اللون --</option>
                    </select>
                </div>
                
                <div>
                    <label for="itemQuantity" class="form-label">الكمية <span class="text-red-500">*</span></label>
                    <input type="number" id="itemQuantity" min="1" class="form-input text-base" required>
                </div>
                
                <div>
                    <label for="itemPrice" class="form-label">السعر للوحدة <span class="text-red-500">*</span></label>
                    <input type="number" id="itemPrice" min="0" step="0.01" class="form-input text-base" required readonly>
                </div>
                
                <div>
                    <label for="itemTotal" class="form-label">الإجمالي</label>
                    <input type="number" id="itemTotal" class="form-input text-base" readonly>
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelOrderItemBtn" class="btn bg-gray-300 text-gray-800 hover:bg-gray-400">إلغاء</button>
                    <button type="submit" class="btn btn-primary">إضافة البند</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 5. نموذج تسجيل سداد -->
    <div id="paymentModal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="paymentModalTitle" class="text-lg font-bold">تسجيل سداد جديد</h3>
                <button id="closePaymentModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="paymentForm" class="space-y-4">
                <input type="hidden" id="paymentId">
                
                <div>
                    <label for="paymentClient" class="form-label">العميل <span class="text-red-500">*</span></label>
                    <select id="paymentClient" class="form-input text-base" required>
                        <option value="">-- اختر العميل --</option>
                        <!-- سيتم ملء الخيارات ديناميكيًا -->
                    </select>
                </div>
                
                <div>
                    <label for="paymentDate" class="form-label">تاريخ السداد <span class="text-red-500">*</span></label>
                    <input type="date" id="paymentDate" class="form-input text-base" required>
                </div>
                
                <div>
                    <label for="paymentAmount" class="form-label">المبلغ المدفوع <span class="text-red-500">*</span></label>
                    <input type="number" id="paymentAmount" min="0" step="0.01" class="form-input text-base" required>
                </div>
                
                <div>
                    <label for="paymentMethod" class="form-label">طريقة الدفع <span class="text-red-500">*</span></label>
                    <select id="paymentMethod" class="form-input text-base" required>
                        <option value="cash">نقدي</option>
                        <option value="vodafone_cash">فودافون كاش</option>
                        <option value="bank_transfer">تحويل بنك</option>
                        <option value="check">شيك</option>
                    </select>
                </div>
                
                <div id="clientOrdersSection">
                    <label class="form-label">تطبيق الدفعة على فاتورة محددة (اختياري)</label>
                    <div id="clientOrdersList" class="max-h-48 overflow-y-auto bg-gray-50 p-2 rounded-md border border-gray-200">
                        <!-- سيتم ملء الفواتير ديناميكيًا -->
                        <p class="text-gray-500 p-2">اختر العميل أولاً لعرض الفواتير</p>
                    </div>
                </div>
                
                <div>
                    <label for="paymentNotes" class="form-label">ملاحظات</label>
                    <textarea id="paymentNotes" class="form-input text-base" rows="2"></textarea>
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelPaymentBtn" class="btn bg-gray-300 text-gray-800 hover:bg-gray-400">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ السداد</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 6. نموذج إضافة مرتجع -->
    <div id="returnModal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="returnModalTitle" class="text-lg font-bold">إضافة مرتجع جديد</h3>
                <button id="closeReturnModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="returnForm" class="space-y-4">
                <input type="hidden" id="returnId">
                
                <div>
                    <label for="returnClient" class="form-label">العميل <span class="text-red-500">*</span></label>
                    <select id="returnClient" class="form-input text-base" required>
                        <option value="">-- اختر العميل --</option>
                        <!-- سيتم ملء الخيارات ديناميكيًا -->
                    </select>
                </div>
                
                <div>
                    <label for="returnOrder" class="form-label">رقم الطلب <span class="text-red-500">*</span></label>
                    <select id="returnOrder" class="form-input text-base" required disabled>
                        <option value="">-- اختر الطلب --</option>
                    </select>
                </div>
                
                <div>
                    <label for="returnProduct" class="form-label">المنتج <span class="text-red-500">*</span></label>
                    <select id="returnProduct" class="form-input text-base" required disabled>
                        <option value="">-- اختر المنتج --</option>
                    </select>
                </div>
                
                <div>
                    <label for="returnQuantity" class="form-label">الكمية المرتجعة <span class="text-red-500">*</span></label>
                    <input type="number" id="returnQuantity" min="1" class="form-input text-base" required>
                </div>
                
                <div>
                    <label for="returnDate" class="form-label">تاريخ المرتجع <span class="text-red-500">*</span></label>
                    <input type="date" id="returnDate" class="form-input text-base" required>
                </div>
                
                <div>
                    <label for="returnReason" class="form-label">سبب الإرجاع</label>
                    <textarea id="returnReason" class="form-input text-base" rows="2"></textarea>
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelReturnBtn" class="btn bg-gray-300 text-gray-800 hover:bg-gray-400">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ المرتجع</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 7. نموذج إدارة المستخدمين -->
    <div id="userModal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="userModalTitle" class="text-lg font-bold">إضافة مستخدم جديد</h3>
                <button id="closeUserModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="userForm" class="space-y-4">
                <input type="hidden" id="userId">
                
                <div>
                    <label for="userName" class="form-label">اسم المستخدم <span class="text-red-500">*</span></label>
                    <input type="text" id="userName" class="form-input text-base" required>
                </div>
                
                <div>
                    <label for="userEmail" class="form-label">البريد الإلكتروني <span class="text-red-500">*</span></label>
                    <input type="email" id="userEmail" class="form-input text-base" required>
                </div>
                
                <div>
                    <label for="userPassword" class="form-label">كلمة المرور <span class="text-red-500">*</span></label>
                    <input type="password" id="userPassword" class="form-input text-base" minlength="6">
                    <p class="text-gray-500 text-xs mt-1">* مطلوب لإضافة مستخدم جديد، اتركه فارغًا عند التعديل</p>
                </div>
                
                <div>
                    <label for="userRole" class="form-label">الدور <span class="text-red-500">*</span></label>
                    <select id="userRole" class="form-input text-base" required>
                        <option value="admin">مدير</option>
                        <option value="supervisor">مشرف</option>
                        <option value="user">مستخدم</option>
                    </select>
                </div>
                
                <div>
                    <label for="userStatus" class="form-label">الحالة <span class="text-red-500">*</span></label>
                    <select id="userStatus" class="form-input text-base" required>
                        <option value="active">نشط</option>
                        <option value="inactive">غير نشط</option>
                    </select>
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelUserBtn" class="btn bg-gray-300 text-gray-800 hover:bg-gray-400">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCpTjPsfaWTuNjpUupteqALjmb0qLUAzg8",
            authDomain: "delta-hcp.firebaseapp.com",
            projectId: "delta-hcp",
            storageBucket: "delta-hcp.firebasestorage.app",
            messagingSenderId: "956838180358",
            appId: "1:956838180358:web:af6abd7a430a8e17c83587",
            measurementId: "G-NJT5FCNJK3"
        };
        
        // تهيئة Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // متغيرات عامة
        let currentUser = null;
        let lastActivity = Date.now();
        let currentView = 'dashboard';
        let inactivityTimer = null;
        let orderItems = [];
        let productsList = [];
        let clientsList = [];
        
        // التحقق من وضع الضوء/الظلام
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add('dark');
            document.getElementById('darkModeToggle').innerHTML = '<i class="fas fa-sun text-yellow-400"></i>';
        }
        
        // مراقبة تغيير وضع الضوء/الظلام
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.body.classList.add('dark');
                document.getElementById('darkModeToggle').innerHTML = '<i class="fas fa-sun text-yellow-400"></i>';
            } else {
                document.body.classList.remove('dark');
                document.getElementById('darkModeToggle').innerHTML = '<i class="fas fa-moon text-gray-700"></i>';
            }
        });
        
        // مراقبة حالة المصادقة
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                
                // الحصول على معلومات المستخدم من Firestore
                db.collection('users').doc(user.uid).get()
                    .then(doc => {
                        if (doc.exists) {
                            const userData = doc.data();
                            
                            // عرض اسم المستخدم ودوره
                            document.getElementById('userNameDisplay').textContent = userData.name || user.email;
                            document.getElementById('userRoleDisplay').innerHTML = `مرحباً، <span id="userNameDisplay">${userData.name || user.email}</span> (${getUserRoleText(userData.role)})`;
                            
                            // إظهار قسم إدارة المستخدمين للمسؤول فقط
                            if (userData.role === 'admin') {
                                document.getElementById('adminUserSection').classList.remove('hidden');
                            }
                        }
                    })
                    .catch(error => {
                        console.error("خطأ في الحصول على بيانات المستخدم:", error);
                    });
                
                // إخفاء صفحة تسجيل الدخول وإظهار التطبيق الرئيسي
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                // تحميل البيانات الأساسية
                loadDashboardData();
                loadAllProducts();
                loadAllClients();
                
                // بدء مؤقت الخروج التلقائي
                startInactivityTimer();
                
                // عرض العرض الأول (لوحة التحكم)
                showView('dashboard');
            } else {
                // إظهار صفحة تسجيل الدخول وإخفاء التطبيق الرئيسي
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });
        
        // دالة تحويل دور المستخدم إلى نص
        function getUserRoleText(role) {
            switch (role) {
                case 'admin': return 'مدير';
                case 'supervisor': return 'مشرف';
                case 'user': return 'مستخدم';
                default: return role;
            }
        }
        
        // تسجيل الدخول
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    console.error("خطأ في تسجيل الدخول:", error);
                    
                    let errorMessage = "حدث خطأ أثناء تسجيل الدخول. يرجى المحاولة مرة أخرى.";
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage = "البريد الإلكتروني أو كلمة المرور غير صحيحة.";
                    }
                    
                    Swal.fire({
                        icon: 'error',
                        title: 'خطأ في تسجيل الدخول',
                        text: errorMessage,
                        confirmButtonText: 'حسناً'
                    });
                });
        });
        
        // تسجيل الخروج
        document.getElementById('logoutBtn').addEventListener('click', () => {
            auth.signOut().catch(error => {
                console.error("خطأ في تسجيل الخروج:", error);
            });
        });
        
        // بدء مؤقت الخروج التلقائي
        function startInactivityTimer() {
            // إعادة ضبط المؤقت
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
            }
            
            // إعداد مؤقت جديد - الخروج بعد 10 دقائق من عدم النشاط
            inactivityTimer = setTimeout(() => {
                if (Date.now() - lastActivity >= 10 * 60 * 1000) {
                    Swal.fire({
                        title: 'تسجيل الخروج التلقائي',
                        text: 'تم تسجيل خروجك تلقائياً بسبب عدم النشاط',
                        icon: 'info',
                        confirmButtonText: 'حسناً'
                    }).then(() => {
                        auth.signOut();
                    });
                }
            }, 10 * 60 * 1000); // 10 دقائق
        }
        
        // تحديث وقت آخر نشاط للمستخدم
        document.addEventListener('click', () => {
            lastActivity = Date.now();
            startInactivityTimer();
        });
        
        document.addEventListener('keypress', () => {
            lastActivity = Date.now();
            startInactivityTimer();
        });
        
        // التبديل بين وضع الضوء/الظلام
        document.getElementById('darkModeToggle').addEventListener('click', () => {
            document.body.classList.toggle('dark');
            
            if (document.body.classList.contains('dark')) {
                document.getElementById('darkModeToggle').innerHTML = '<i class="fas fa-sun text-yellow-400"></i>';
            } else {
                document.getElementById('darkModeToggle').innerHTML = '<i class="fas fa-moon text-gray-700"></i>';
            }
        });
        
        // فتح/إغلاق القائمة الجانبية في الأجهزة المحمولة
        document.getElementById('menuToggle').addEventListener('click', () => {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('fixed');
            sidebar.classList.toggle('inset-0');
            sidebar.classList.toggle('z-50');
        });
        
        // عرض العرض المحدد وإخفاء البقية
        function showView(viewName) {
            // إعادة تعيين جميع العروض كغير نشطة
            document.querySelectorAll('.app-view').forEach(view => {
                view.classList.add('inactive-view');
            });
            
            // إزالة تنشيط جميع روابط التنقل
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-primary', 'text-white');
            });
            
            // تحديد العرض المطلوب كنشط
            const targetView = document.getElementById(`${viewName}-view`);
            if (targetView) {
                targetView.classList.remove('inactive-view');
                
                // تنشيط رابط التنقل المقابل
                const navLink = document.querySelector(`.nav-link[data-view="${viewName}"]`);
                if (navLink) {
                    navLink.classList.add('bg-primary', 'text-white');
                }
                
                // تحديث العرض الحالي
                currentView = viewName;
                
                // تحميل البيانات اللازمة للعرض
                if (viewName === 'dashboard') {
                    loadDashboardData();
                } else if (viewName === 'products') {
                    loadProductsData();
                } else if (viewName === 'clients') {
                    loadClientsData();
                } else if (viewName === 'orders') {
                    loadOrdersData();
                } else if (viewName === 'invoices') {
                    loadInvoicesData();
                } else if (viewName === 'payments') {
                    loadPaymentsData();
                } else if (viewName === 'returns') {
                    loadReturnsData();
                } else if (viewName === 'users') {
                    loadUsersData();
                }
            }
        }
        
        // إعداد مستمعي أحداث التنقل
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const viewName = link.getAttribute('data-view');
                showView(viewName);
                
                // إغلاق القائمة الجانبية في الأجهزة المحمولة بعد النقر
                if (window.innerWidth < 768) {
                    document.getElementById('sidebar').classList.add('hidden');
                }
            });
        });
        
        // تحميل بيانات لوحة التحكم
        function loadDashboardData() {
            // إحصائيات سريعة
            db.collection('orders').get().then(snapshot => {
                document.getElementById('totalOrdersCount').textContent = snapshot.size;
                
                let totalSales = 0;
                let pendingOrders = 0;
                
                snapshot.forEach(doc => {
                    const order = doc.data();
                    totalSales += order.totalAmount || 0;
                    
                    if (order.status === 'pending') {
                        pendingOrders++;
                    }
                });
                
                document.getElementById('totalSalesAmount').textContent = totalSales.toLocaleString() + ' ج.م';
                document.getElementById('pendingOrdersCount').textContent = pendingOrders;
            });
            
            db.collection('clients').get().then(snapshot => {
                document.getElementById('activeClientsCount').textContent = snapshot.size;
            });
            
            // إنشاء الرسوم البيانية
            createMonthlySalesChart();
            createTopProductsChart();
        }
        
        // إنشاء مخطط المبيعات الشهرية
        function createMonthlySalesChart() {
            // استرداد المبيعات مجمعة حسب الشهر
            const currentYear = new Date().getFullYear();
            const monthlyData = Array(12).fill(0);
            const monthNames = ['يناير', 'فبراير', 'مارس', 'إبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
            
            db.collection('orders')
                .where('createdAt', '>=', new Date(currentYear, 0, 1))
                .where('createdAt', '<=', new Date(currentYear, 11, 31))
                .get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        if (order.totalAmount && order.createdAt) {
                            const orderDate = order.createdAt.toDate ? order.createdAt.toDate() : new Date(order.createdAt);
                            const month = orderDate.getMonth();
                            monthlyData[month] += order.totalAmount;
                        }
                    });
                    
                    // إنشاء الرسم البياني
                    const ctx = document.getElementById('monthlySalesChart').getContext('2d');
                    
                    // تدمير الرسم البياني الحالي إذا كان موجودًا
                    if (window.monthlySalesChart) {
                        window.monthlySalesChart.destroy();
                    }
                    
                    window.monthlySalesChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: monthNames,
                            datasets: [{
                                label: 'المبيعات الشهرية (ج.م)',
                                data: monthlyData,
                                backgroundColor: 'rgba(93, 92, 222, 0.6)',
                                borderColor: 'rgba(93, 92, 222, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                });
        }
        
        // إنشاء مخطط المنتجات الأكثر مبيعًا
        function createTopProductsChart() {
            const productSales = {};
            
            // استرداد جميع بنود الطلبات لحساب المبيعات لكل منتج
            db.collection('orderItems')
                .get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const item = doc.data();
                        const productName = item.productName;
                        
                        if (!productSales[productName]) {
                            productSales[productName] = 0;
                        }
                        
                        productSales[productName] += item.quantity || 0;
                    });
                    
                    // ترتيب المنتجات وأخذ أعلى 5
                    const sortedProducts = Object.entries(productSales)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5);
                    
                    const productNames = sortedProducts.map(p => p[0]);
                    const productQuantities = sortedProducts.map(p => p[1]);
                    
                    // إنشاء الرسم البياني
                    const ctx = document.getElementById('topProductsChart').getContext('2d');
                    
                    // تدمير الرسم البياني الحالي إذا كان موجودًا
                    if (window.topProductsChart) {
                        window.topProductsChart.destroy();
                    }
                    
                    window.topProductsChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: productNames,
                            datasets: [{
                                data: productQuantities,
                                backgroundColor: [
                                    'rgba(93, 92, 222, 0.8)',
                                    'rgba(76, 175, 80, 0.8)',
                                    'rgba(244, 67, 54, 0.8)',
                                    'rgba(255, 152, 0, 0.8)',
                                    'rgba(33, 150, 243, 0.8)'
                                ],
                                borderColor: '#fff',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right'
                                }
                            }
                        }
                    });
                });
        }
        
        // تحميل جميع المنتجات
        function loadAllProducts() {
            db.collection('products').get()
                .then(snapshot => {
                    productsList = [];
                    snapshot.forEach(doc => {
                        productsList.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                })
                .catch(error => {
                    console.error("خطأ في تحميل المنتجات:", error);
                });
        }
        
        // تحميل جميع العملاء
        function loadAllClients() {
            db.collection('clients').get()
                .then(snapshot => {
                    clientsList = [];
                    snapshot.forEach(doc => {
                        clientsList.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // تعبئة قوائم العملاء في النماذج المختلفة
                    populateClientSelect('orderClient');
                    populateClientSelect('paymentClient');
                    populateClientSelect('returnClient');
                    populateClientSelect('statementClientFilter');
                })
                .catch(error => {
                    console.error("خطأ في تحميل العملاء:", error);
                });
        }
        
        // تعبئة قائمة العملاء المنسدلة
        function populateClientSelect(selectId) {
            const select = document.getElementById(selectId);
            
            // حفظ القيمة المحددة حاليًا
            const currentValue = select.value;
            
            // إزالة جميع الخيارات الحالية ما عدا الخيار الافتراضي
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // إضافة خيارات العملاء
            clientsList.sort((a, b) => a.name.localeCompare(b.name)).forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                select.appendChild(option);
            });
            
            // استعادة القيمة المحددة سابقًا إذا كانت موجودة
            if (currentValue) {
                select.value = currentValue;
            }
        }
        
        // تحميل بيانات المنتجات
        function loadProductsData() {
            const tableBody = document.querySelector('#productsTable tbody');
            tableBody.innerHTML = '<tr class="text-center"><td colspan="5" class="py-4">جاري تحميل البيانات...</td></tr>';
            
            db.collection('products').get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        tableBody.innerHTML = '<tr class="text-center"><td colspan="5" class="py-4">لا توجد منتجات حاليًا</td></tr>';
                        return;
                    }
                    
                    let productRows = '';
                    
                    snapshot.forEach(doc => {
                        const product = doc.data();
                        const categoryName = getCategoryNameArabic(product.category);
                        
                        productRows += `
                        <tr class="bg-white hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${categoryName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${product.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${product.batch}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${product.price} ج.م</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                <button class="edit-product-btn text-blue-600 hover:text-blue-900 mx-1" data-id="${doc.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-product-btn text-red-600 hover:text-red-900 mx-1" data-id="${doc.id}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                        `;
                    });
                    
                    tableBody.innerHTML = productRows;
                    
                    // إضافة أحداث للأزرار
                    document.querySelectorAll('.edit-product-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const productId = this.getAttribute('data-id');
                            editProduct(productId);
                        });
                    });
                    
                    document.querySelectorAll('.delete-product-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const productId = this.getAttribute('data-id');
                            deleteProduct(productId);
                        });
                    });
                })
                .catch(error => {
                    console.error("خطأ في تحميل المنتجات:", error);
                    tableBody.innerHTML = '<tr class="text-center"><td colspan="5" class="py-4 text-red-500">حدث خطأ أثناء تحميل البيانات</td></tr>';
                });
        }
        
        // تحميل بيانات العملاء
        function loadClientsData() {
            const tableBody = document.querySelector('#clientsTable tbody');
            tableBody.innerHTML = '<tr class="text-center"><td colspan="6" class="py-4">جاري تحميل البيانات...</td></tr>';
            
            db.collection('clients').get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        tableBody.innerHTML = '<tr class="text-center"><td colspan="6" class="py-4">لا يوجد عملاء حاليًا</td></tr>';
                        return;
                    }
                    
                    let clientRows = '';
                    
                    snapshot.forEach(doc => {
                        const client = doc.data();
                        const typeName = getClientTypeNameArabic(client.type);
                        
                        clientRows += `
                        <tr class="bg-white hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${client.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${client.phone || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${client.address || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${typeName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${client.discount || 0}%</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                <button class="edit-client-btn text-blue-600 hover:text-blue-900 mx-1" data-id="${doc.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="view-client-statement-btn text-green-600 hover:text-green-900 mx-1" data-id="${doc.id}">
                                    <i class="fas fa-file-alt"></i>
                                </button>
                                <button class="delete-client-btn text-red-600 hover:text-red-900 mx-1" data-id="${doc.id}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                        `;
                    });
                    
                    tableBody.innerHTML = clientRows;
                    
                    // إضافة أحداث للأزرار
                    document.querySelectorAll('.edit-client-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const clientId = this.getAttribute('data-id');
                            editClient(clientId);
                        });
                    });
                    
                    document.querySelectorAll('.view-client-statement-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const clientId = this.getAttribute('data-id');
                            // التبديل إلى صفحة كشف الحساب وتعيين العميل
                            showView('statements');
                            document.getElementById('statementClientFilter').value = clientId;
                        });
                    });
                    
                    document.querySelectorAll('.delete-client-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const clientId = this.getAttribute('data-id');
                            deleteClient(clientId);
                        });
                    });
                })
                .catch(error => {
                    console.error("خطأ في تحميل العملاء:", error);
                    tableBody.innerHTML = '<tr class="text-center"><td colspan="6" class="py-4 text-red-500">حدث خطأ أثناء تحميل البيانات</td></tr>';
                });
        }
        
        // تحميل بيانات الطلبات
        function loadOrdersData() {
            const tableBody = document.querySelector('#ordersTable tbody');
            tableBody.innerHTML = '<tr class="text-center"><td colspan="7" class="py-4">جاري تحميل البيانات...</td></tr>';
            
            db.collection('orders').get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        tableBody.innerHTML = '<tr class="text-center"><td colspan="7" class="py-4">لا توجد طلبات حاليًا</td></tr>';
                        return;
                    }
                    
                    // تحويل المستندات إلى مصفوفة للترتيب
                    const orders = [];
                    snapshot.forEach(doc => {
                        orders.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // ترتيب الطلبات بحسب التاريخ (الأحدث أولاً)
                    orders.sort((a, b) => {
                        const dateA = a.createdAt ? a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt) : new Date(0);
                        const dateB = b.createdAt ? b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt) : new Date(0);
                        return dateB - dateA;
                    });
                    
                    let orderRows = '';
                    
                    for (const order of orders) {
                        // الحصول على اسم العميل
                        const client = clientsList.find(c => c.id === order.clientId);
                        const clientName = client ? client.name : 'عميل غير معروف';
                        
                        // تنسيق التاريخ
                        const orderDate = order.createdAt ? 
                            new Date(order.createdAt.seconds ? order.createdAt.seconds * 1000 : order.createdAt).toLocaleDateString('ar') : 
                            '-';
                        
                        // حالة الطلب
                        const statusClass = getOrderStatusClass(order.status);
                        const statusText = getOrderStatusText(order.status);
                        
                        // طريقة الدفع
                        const paymentMethodText = getPaymentMethodText(order.paymentMethod);
                        
                        orderRows += `
                        <tr class="bg-white hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${order.orderNumber || order.id.substr(0, 8)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${orderDate}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${clientName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${order.totalAmount ? order.totalAmount.toLocaleString() + ' ج.م' : '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${paymentMethodText}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                    ${statusText}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                <button class="view-order-btn text-green-600 hover:text-green-900 mx-1" data-id="${order.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="edit-order-btn text-blue-600 hover:text-blue-900 mx-1" data-id="${order.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="print-order-btn text-purple-600 hover:text-purple-900 mx-1" data-id="${order.id}">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button class="delete-order-btn text-red-600 hover:text-red-900 mx-1" data-id="${order.id}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                        `;
                    }
                    
                    tableBody.innerHTML = orderRows;
                    
                    // إضافة أحداث للأزرار
                    document.querySelectorAll('.view-order-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const orderId = this.getAttribute('data-id');
                            viewOrder(orderId);
                        });
                    });
                    
                    document.querySelectorAll('.edit-order-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const orderId = this.getAttribute('data-id');
                            editOrder(orderId);
                        });
                    });
                    
                    document.querySelectorAll('.print-order-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const orderId = this.getAttribute('data-id');
                            printOrderInvoice(orderId);
                        });
                    });
                    
                    document.querySelectorAll('.delete-order-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const orderId = this.getAttribute('data-id');
                            deleteOrder(orderId);
                        });
                    });
                })
                .catch(error => {
                    console.error("خطأ في تحميل الطلبات:", error);
                    tableBody.innerHTML = '<tr class="text-center"><td colspan="7" class="py-4 text-red-500">حدث خطأ أثناء تحميل البيانات</td></tr>';
                });
        }
        
        // تحميل بيانات الفواتير
        function loadInvoicesData() {
            const tableBody = document.querySelector('#invoicesTable tbody');
            tableBody.innerHTML = '<tr class="text-center"><td colspan="7" class="py-4">جاري تحميل البيانات...</td></tr>';
            
            // في هذا التطبيق، الفواتير هي نفسها الطلبات المكتملة
            db.collection('orders')
                .where('status', '==', 'completed')
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        tableBody.innerHTML = '<tr class="text-center"><td colspan="7" class="py-4">لا توجد فواتير حاليًا</td></tr>';
                        return;
                    }
                    
                    // تحويل المستندات إلى مصفوفة للترتيب
                    const invoices = [];
                    snapshot.forEach(doc => {
                        invoices.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // ترتيب الفواتير بحسب التاريخ (الأحدث أولاً)
                    invoices.sort((a, b) => {
                        const dateA = a.createdAt ? a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt) : new Date(0);
                        const dateB = b.createdAt ? b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt) : new Date(0);
                        return dateB - dateA;
                    });
                    
                    let invoiceRows = '';
                    
                    for (const invoice of invoices) {
                        // الحصول على اسم العميل
                        const client = clientsList.find(c => c.id === invoice.clientId);
                        const clientName = client ? client.name : 'عميل غير معروف';
                        
                        // تنسيق التاريخ
                        const invoiceDate = invoice.createdAt ? 
                            new Date(invoice.createdAt.seconds ? invoice.createdAt.seconds * 1000 : invoice.createdAt).toLocaleDateString('ar') : 
                            '-';
                        
                        // حالة الدفع
                        const paymentStatus = invoice.paymentMethod === 'credit' ? 'غير مدفوع' : 'مدفوع';
                        const paymentStatusClass = invoice.paymentMethod === 'credit' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
                        
                        invoiceRows += `
                        <tr class="bg-white hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm">INV-${invoice.id.substr(0, 8)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${invoice.orderNumber || invoice.id.substr(0, 8)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${invoiceDate}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${clientName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${invoice.totalAmount ? invoice.totalAmount.toLocaleString() + ' ج.م' : '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${paymentStatusClass}">
                                    ${paymentStatus}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                <button class="view-invoice-btn text-green-600 hover:text-green-900 mx-1" data-id="${invoice.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="print-invoice-btn text-purple-600 hover:text-purple-900 mx-1" data-id="${invoice.id}">
                                    <i class="fas fa-print"></i>
                                </button>
                            </td>
                        </tr>
                        `;
                    }
                    
                    tableBody.innerHTML = invoiceRows;
                    
                    // إضافة أحداث للأزرار
                    document.querySelectorAll('.view-invoice-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const invoiceId = this.getAttribute('data-id');
                            viewInvoice(invoiceId);
                        });
                    });
                    
                    document.querySelectorAll('.print-invoice-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const invoiceId = this.getAttribute('data-id');
                            printInvoice(invoiceId);
                        });
                    });
                })
                .catch(error => {
                    console.error("خطأ في تحميل الفواتير:", error);
                    tableBody.innerHTML = '<tr class="text-center"><td colspan="7" class="py-4 text-red-500">حدث خطأ أثناء تحميل البيانات</td></tr>';
                });
        }
        
        // تحميل بيانات المدفوعات
        function loadPaymentsData() {
            const tableBody = document.querySelector('#paymentsTable tbody');
            tableBody.innerHTML = '<tr class="text-center"><td colspan="7" class="py-4">جاري تحميل البيانات...</td></tr>';
            
            db.collection('payments').get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        tableBody.innerHTML = '<tr class="text-center"><td colspan="7" class="py-4">لا توجد مدفوعات حاليًا</td></tr>';
                        return;
                    }
                    
                    // تحويل المستندات إلى مصفوفة للترتيب
                    const payments = [];
                    snapshot.forEach(doc => {
                        payments.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // ترتيب المدفوعات بحسب التاريخ (الأحدث أولاً)
                    payments.sort((a, b) => {
                        const dateA = a.date ? a.date.toDate ? a.date.toDate() : new Date(a.date) : new Date(0);
                        const dateB = b.date ? b.date.toDate ? b.date.toDate() : new Date(b.date) : new Date(0);
                        return dateB - dateA;
                    });
                    
                    let paymentRows = '';
                    
                    for (const payment of payments) {
                        // الحصول على اسم العميل
                        const client = clientsList.find(c => c.id === payment.clientId);
                        const clientName = client ? client.name : 'عميل غير معروف';
                        
                        // تنسيق التاريخ
                        const paymentDate = payment.date ? 
                            new Date(payment.date.seconds ? payment.date.seconds * 1000 : payment.date).toLocaleDateString('ar') : 
                            '-';
                        
                        // طريقة الدفع
                        const paymentMethodText = getPaymentMethodText(payment.method);
                        
                        paymentRows += `
                        <tr class="bg-white hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm">PMT-${payment.id.substr(0, 8)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${paymentDate}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${clientName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${payment.amount ? payment.amount.toLocaleString() + ' ج.م' : '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${paymentMethodText}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${payment.notes || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                <button class="edit-payment-btn text-blue-600 hover:text-blue-900 mx-1" data-id="${payment.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="print-payment-receipt-btn text-purple-600 hover:text-purple-900 mx-1" data-id="${payment.id}">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button class="delete-payment-btn text-red-600 hover:text-red-900 mx-1" data-id="${payment.id}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                        `;
                    }
                    
                    tableBody.innerHTML = paymentRows;
                    
                    // إضافة أحداث للأزرار
                    document.querySelectorAll('.edit-payment-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const paymentId = this.getAttribute('data-id');
                            editPayment(paymentId);
                        });
                    });
                    
                    document.querySelectorAll('.print-payment-receipt-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const paymentId = this.getAttribute('data-id');
                            printPaymentReceipt(paymentId);
                        });
                    });
                    
                    document.querySelectorAll('.delete-payment-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const paymentId = this.getAttribute('data-id');
                            deletePayment(paymentId);
                        });
                    });
                })
                .catch(error => {
                    console.error("خطأ في تحميل المدفوعات:", error);
                    tableBody.innerHTML = '<tr class="text-center"><td colspan="7" class="py-4 text-red-500">حدث خطأ أثناء تحميل البيانات</td></tr>';
                });
        }
        
        // تحميل بيانات المرتجعات
        function loadReturnsData() {
            const tableBody = document.querySelector('#returnsTable tbody');
            tableBody.innerHTML = '<tr class="text-center"><td colspan="9" class="py-4">جاري تحميل البيانات...</td></tr>';
            
            db.collection('returns').get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        tableBody.innerHTML = '<tr class="text-center"><td colspan="9" class="py-4">لا توجد مرتجعات حاليًا</td></tr>';
                        return;
                    }
                    
                    // تحويل المستندات إلى مصفوفة للترتيب
                    const returns = [];
                    snapshot.forEach(doc => {
                        returns.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // ترتيب المرتجعات بحسب التاريخ (الأحدث أولاً)
                    returns.sort((a, b) => {
                        const dateA = a.date ? a.date.toDate ? a.date.toDate() : new Date(a.date) : new Date(0);
                        const dateB = b.date ? b.date.toDate ? b.date.toDate() : new Date(b.date) : new Date(0);
                        return dateB - dateA;
                    });
                    
                    const promisesList = [];
                    
                    for (const returnItem of returns) {
                        // الحصول على اسم العميل
                        const client = clientsList.find(c => c.id === returnItem.clientId);
                        
                        // الحصول على معلومات الطلب والمنتج
                        promisesList.push(
                            db.collection('orders').doc(returnItem.orderId).get()
                                .then(orderDoc => {
                                    const orderData = orderDoc.exists ? orderDoc.data() : { orderNumber: 'غير متاح' };
                                    
                                    return db.collection('products').doc(returnItem.productId).get()
                                        .then(productDoc => {
                                            const productData = productDoc.exists ? productDoc.data() : { name: 'غير متاح' };
                                            
                                            // تنسيق التاريخ
                                            const returnDate = returnItem.date ? 
                                                new Date(returnItem.date.seconds ? returnItem.date.seconds * 1000 : returnItem.date).toLocaleDateString('ar') : 
                                                '-';
                                            
                                            return `
                                            <tr class="bg-white hover:bg-gray-50">
                                                <td class="px-6 py-4 whitespace-nowrap text-sm">RTN-${returnItem.id.substr(0, 8)}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm">${returnDate}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm">${orderData.orderNumber || returnItem.orderId.substr(0, 8)}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm">${client ? client.name : 'عميل غير معروف'}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm">${productData.name}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm">${returnItem.quantity}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm">${returnItem.amount ? returnItem.amount.toLocaleString() + ' ج.م' : '-'}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm">${returnItem.reason || '-'}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                                    <button class="edit-return-btn text-blue-600 hover:text-blue-900 mx-1" data-id="${returnItem.id}">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="delete-return-btn text-red-600 hover:text-red-900 mx-1" data-id="${returnItem.id}">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            `;
                                        });
                                })
                        );
                    }
                    
                    Promise.all(promisesList)
                        .then(rows => {
                            tableBody.innerHTML = rows.join('');
                            
                            // إضافة أحداث للأزرار
                            document.querySelectorAll('.edit-return-btn').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const returnId = this.getAttribute('data-id');
                                    editReturn(returnId);
                                });
                            });
                            
                            document.querySelectorAll('.delete-return-btn').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const returnId = this.getAttribute('data-id');
                                    deleteReturn(returnId);
                                });
                            });
                        })
                        .catch(error => {
                            console.error("خطأ في جلب بيانات المرتجعات المفصلة:", error);
                            tableBody.innerHTML = '<tr class="text-center"><td colspan="9" class="py-4 text-red-500">حدث خطأ أثناء تحميل البيانات</td></tr>';
                        });
                })
                .catch(error => {
                    console.error("خطأ في تحميل المرتجعات:", error);
                    tableBody.innerHTML = '<tr class="text-center"><td colspan="9" class="py-4 text-red-500">حدث خطأ أثناء تحميل البيانات</td></tr>';
                });
        }
        
        // تحميل بيانات المستخدمين (للمسؤول فقط)
        function loadUsersData() {
            const tableBody = document.querySelector('#usersTable tbody');
            tableBody.innerHTML = '<tr class="text-center"><td colspan="6" class="py-4">جاري تحميل البيانات...</td></tr>';
            
            db.collection('users').get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        tableBody.innerHTML = '<tr class="text-center"><td colspan="6" class="py-4">لا يوجد مستخدمين حاليًا</td></tr>';
                        return;
                    }
                    
                    let userRows = '';
                    
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        
                        // تنسيق التاريخ
                        const createdDate = user.createdAt ? 
                            new Date(user.createdAt.seconds ? user.createdAt.seconds * 1000 : user.createdAt).toLocaleDateString('ar') : 
                            '-';
                        
                        // ترجمة الدور والحالة
                        const roleText = getUserRoleText(user.role);
                        const statusText = user.status === 'active' ? 'نشط' : 'غير نشط';
                        const statusClass = user.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        
                        userRows += `
                        <tr class="bg-white hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${user.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${user.email}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${roleText}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${createdDate}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                    ${statusText}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                <button class="edit-user-btn text-blue-600 hover:text-blue-900 mx-1" data-id="${doc.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-user-btn text-red-600 hover:text-red-900 mx-1" data-id="${doc.id}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                        `;
                    });
                    
                    tableBody.innerHTML = userRows;
                    
                    // إضافة أحداث للأزرار
                    document.querySelectorAll('.edit-user-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const userId = this.getAttribute('data-id');
                            editUser(userId);
                        });
                    });
                    
                    document.querySelectorAll('.delete-user-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const userId = this.getAttribute('data-id');
                            deleteUser(userId);
                        });
                    });
                })
                .catch(error => {
                    console.error("خطأ في تحميل المستخدمين:", error);
                    tableBody.innerHTML = '<tr class="text-center"><td colspan="6" class="py-4 text-red-500">حدث خطأ أثناء تحميل البيانات</td></tr>';
                });
        }
        
        // إضافة منتج جديد / تعديل منتج
        document.getElementById('addProductBtn').addEventListener('click', () => {
            // إعادة تعيين النموذج
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('productModalTitle').textContent = 'إضافة منتج جديد';
            
            // إظهار النموذج
            document.getElementById('productModal').classList.remove('hidden');
        });
        
        // إغلاق نموذج المنتج
        document.getElementById('closeProductModal').addEventListener('click', () => {
            document.getElementById('productModal').classList.add('hidden');
        });
        
        document.getElementById('cancelProductBtn').addEventListener('click', () => {
            document.getElementById('productModal').classList.add('hidden');
        });
        
        // حفظ المنتج
        document.getElementById('productForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const productId = document.getElementById('productId').value;
            const isEditing = !!productId;
            
            const productData = {
                category: document.getElementById('productCategory').value,
                name: document.getElementById('productName').value,
                batch: document.getElementById('productBatch').value,
                price: parseFloat(document.getElementById('productPrice').value),
                updatedAt: new Date()
            };
            
            if (!isEditing) {
                productData.createdAt = new Date();
            }
            
            let savePromise;
            
            if (isEditing) {
                savePromise = db.collection('products').doc(productId).update(productData);
            } else {
                savePromise = db.collection('products').add(productData);
            }
            
            savePromise
                .then(() => {
                    Swal.fire({
                        icon: 'success',
                        title: isEditing ? 'تم تعديل المنتج بنجاح' : 'تم إضافة المنتج بنجاح',
                        showConfirmButton: false,
                        timer: 1500
                    });
                    
                    // إغلاق النموذج وتحديث البيانات
                    document.getElementById('productModal').classList.add('hidden');
                    loadProductsData();
                    loadAllProducts();
                })
                .catch(error => {
                    console.error("خطأ في حفظ المنتج:", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'خطأ',
                        text: 'حدث خطأ أثناء حفظ المنتج',
                        confirmButtonText: 'حسناً'
                    });
                });
        });
        
        // تعديل منتج
        function editProduct(productId) {
            db.collection('products').doc(productId).get()
                .then(doc => {
                    if (doc.exists) {
                        const product = doc.data();
                        
                        // ملء النموذج بالبيانات
                        document.getElementById('productId').value = productId;
                        document.getElementById('productCategory').value = product.category;
                        document.getElementById('productName').value = product.name;
                        document.getElementById('productBatch').value = product.batch;
                        document.getElementById('productPrice').value = product.price;
                        
                        // تحديث العنوان وإظهار النموذج
                        document.getElementById('productModalTitle').textContent = 'تعديل المنتج';
                        document.getElementById('productModal').classList.remove('hidden');
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'خطأ',
                            text: 'لم يتم العثور على المنتج',
                            confirmButtonText: 'حسناً'
                        });
                    }
                })
                .catch(error => {
                    console.error("خطأ في تحميل بيانات المنتج:", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'خطأ',
                        text: 'حدث خطأ أثناء تحميل بيانات المنتج',
                        confirmButtonText: 'حسناً'
                    });
                });
        }
        
        // حذف منتج
        function deleteProduct(productId) {
            Swal.fire({
                title: 'هل أنت متأكد؟',
                text: "سيتم حذف المنتج نهائيًا!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'نعم، حذف',
                cancelButtonText: 'إلغاء'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.collection('products').doc(productId).delete()
                        .then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'تم الحذف',
                                text: 'تم حذف المنتج بنجاح',
                                showConfirmButton: false,
                                timer: 1500
                            });
                            
                            // تحديث البيانات
                            loadProductsData();
                            loadAllProducts();
                        })
                        .catch(error => {
                            console.error("خطأ في حذف المنتج:", error);
                            Swal.fire({
                                icon: 'error',
                                title: 'خطأ',
                                text: 'حدث خطأ أثناء حذف المنتج',
                                confirmButtonText: 'حسناً'
                            });
                        });
                }
            });
        }
        
        // إضافة عميل جديد / تعديل عميل
        document.getElementById('addClientBtn').addEventListener('click', () => {
            // إعادة تعيين النموذج
            document.getElementById('clientForm').reset();
            document.getElementById('clientId').value = '';
            document.getElementById('clientModalTitle').textContent = 'إضافة عميل جديد';
            
            // إظهار النموذج
            document.getElementById('clientModal').classList.remove('hidden');
        });
        
        // إغلاق نموذج العميل
        document.getElementById('closeClientModal').addEventListener('click', () => {
            document.getElementById('clientModal').classList.add('hidden');
        });
        
        document.getElementById('cancelClientBtn').addEventListener('click', () => {
            document.getElementById('clientModal').classList.add('hidden');
        });
        
        // حفظ العميل
        document.getElementById('clientForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const clientId = document.getElementById('clientId').value;
            const isEditing = !!clientId;
            
            const clientData = {
                name: document.getElementById('clientName').value,
                phone: document.getElementById('clientPhone').value,
                address: document.getElementById('clientAddress').value,
                type: document.getElementById('clientType').value,
                discount: parseInt(document.getElementById('clientDiscount').value) || 0,
                updatedAt: new Date()
            };
            
            if (!isEditing) {
                clientData.createdAt = new Date();
            }
            
            let savePromise;
            
            if (isEditing) {
                savePromise = db.collection('clients').doc(clientId).update(clientData);
            } else {
                savePromise = db.collection('clients').add(clientData);
            }
            
            savePromise
                .then(() => {
                    Swal.fire({
                        icon: 'success',
                        title: isEditing ? 'تم تعديل العميل بنجاح' : 'تم إضافة العميل بنجاح',
                        showConfirmButton: false,
                        timer: 1500
                    });
                    
                    // إغلاق النموذج وتحديث البيانات
                    document.getElementById('clientModal').classList.add('hidden');
                    loadClientsData();
                    loadAllClients();
                })
                .catch(error => {
                    console.error("خطأ في حفظ العميل:", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'خطأ',
                        text: 'حدث خطأ أثناء حفظ العميل',
                        confirmButtonText: 'حسناً'
                    });
                });
        });
        
        // تعديل عميل
        function editClient(clientId) {
            db.collection('clients').doc(clientId).get()
                .then(doc => {
                    if (doc.exists) {
                        const client = doc.data();
                        
                        // ملء النموذج بالبيانات
                        document.getElementById('clientId').value = clientId;
                        document.getElementById('clientName').value = client.name;
                        document.getElementById('clientPhone').value = client.phone || '';
                        document.getElementById('clientAddress').value = client.address || '';
                        document.getElementById('clientType').value = client.type;
                        document.getElementById('clientDiscount').value = client.discount || 0;
                        
                        // تحديث العنوان وإظهار النموذج
                        document.getElementById('clientModalTitle').textContent = 'تعديل العميل';
                        document.getElementById('clientModal').classList.remove('hidden');
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'خطأ',
                            text: 'لم يتم العثور على العميل',
                            confirmButtonText: 'حسناً'
                        });
                    }
                })
                .catch(error => {
                    console.error("خطأ في تحميل بيانات العميل:", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'خطأ',
                        text: 'حدث خطأ أثناء تحميل بيانات العميل',
                        confirmButtonText: 'حسناً'
                    });
                });
        }
        
        // حذف عميل
        function deleteClient(clientId) {
            Swal.fire({
                title: 'هل أنت متأكد؟',
                text: "سيتم حذف العميل نهائيًا!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'نعم، حذف',
                cancelButtonText: 'إلغاء'
            }).then((result) => {
                if (result.isConfirmed) {
                    // التحقق من وجود طلبات أو مدفوعات مرتبطة بالعميل
                    db.collection('orders').where('clientId', '==', clientId).limit(1).get()
                        .then(orderSnapshot => {
                            if (!orderSnapshot.empty) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'لا يمكن الحذف',
                                    text: 'لا يمكن حذف العميل لوجود طلبات مرتبطة به',
                                    confirmButtonText: 'حسناً'
                                });
                                return;
                            }
                            
                            db.collection('payments').where('clientId', '==', clientId).limit(1).get()
                                .then(paymentSnapshot => {
                                    if (!paymentSnapshot.empty) {
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'لا يمكن الحذف',
                                            text: 'لا يمكن حذف العميل لوجود مدفوعات مرتبطة به',
                                            confirmButtonText: 'حسناً'
                                        });
                                        return;
                                    }
                                    
                                    // إذا لم توجد طلبات أو مدفوعات، يمكن حذف العميل
                                    db.collection('clients').doc(clientId).delete()
                                        .then(() => {
                                            Swal.fire({
                                                icon: 'success',
                                                title: 'تم الحذف',
                                                text: 'تم حذف العميل بنجاح',
                                                showConfirmButton: false,
                                                timer: 1500
                                            });
                                            
                                            // تحديث البيانات
                                            loadClientsData();
                                            loadAllClients();
                                        })
                                        .catch(error => {
                                            console.error("خطأ في حذف العميل:", error);
                                            Swal.fire({
                                                icon: 'error',
                                                title: 'خطأ',
                                                text: 'حدث خطأ أثناء حذف العميل',
                                                confirmButtonText: 'حسناً'
                                            });
                                        });
                                });
                        })
                        .catch(error => {
                            console.error("خطأ في التحقق من الطلبات:", error);
                            Swal.fire({
                                icon: 'error',
                                title: 'خطأ',
                                text: 'حدث خطأ أثناء التحقق من البيانات',
                                confirmButtonText: 'حسناً'
                            });
                        });
                }
            });
        }
        
        // ترجمة تصنيف المنتج إلى اللغة العربية
        function getCategoryNameArabic(category) {
            switch (category) {
                case 'construction': return 'إنشائي';
                case 'exterior': return 'واجهات خارجية';
                case 'decorative': return 'ديكوري';
                default: return category;
            }
        }
        
        // ترجمة تصنيف العميل إلى اللغة العربية
        function getClientTypeNameArabic(type) {
            switch (type) {
                case 'organization': return 'هيئات/مشاريع';
                case 'shop': return 'محلات';
                case 'individual': return 'أهالي';
                default: return type;
            }
        }
        
        // ترجمة حالة الطلب إلى اللغة العربية
        function getOrderStatusText(status) {
            switch (status) {
                case 'pending': return 'معلق';
                case 'completed': return 'مكتمل';
                case 'cancelled': return 'ملغي';
                default: return status;
            }
        }
        
        // صنف CSS لحالة الطلب
        function getOrderStatusClass(status) {
            switch (status) {
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'completed': return 'bg-green-100 text-green-800';
                case 'cancelled': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        // ترجمة طريقة الدفع إلى اللغة العربية
        function getPaymentMethodText(method) {
            switch (method) {
                case 'cash': return 'نقدي';
                case 'credit': return 'آجل';
                case 'bank_transfer': return 'تحويل بنكي';
                case 'vodafone_cash': return 'فودافون كاش';
                case 'check': return 'شيك';
                default: return method;
            }
        }
        
        // دالة توليد ID فريد
        function generateUniqueId() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }
        
        // تولد رقم طلب فريد
        function generateOrderNumber() {
            const now = new Date();
            const year = now.getFullYear().toString().substr(-2);
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            
            return `ORD-${year}${month}${day}-${random}`;
        }
        
        // دوال خاصة بالطلبات
        
        // إضافة طلب جديد
        document.getElementById('addOrderBtn').addEventListener('click', () => {
            // إعادة تعيين النموذج وبنود الطلب
            document.getElementById('orderForm').reset();
            document.getElementById('orderId').value = '';
            document.getElementById('orderModalTitle').textContent = 'إنشاء طلب جديد';
            document.getElementById('orderDate').valueAsDate = new Date();
            
            // تعيين قائمة بنود الطلب فارغة
            orderItems = [];
            updateOrderItemsTable();
            
            // إظهار النموذج
            document.getElementById('orderModal').classList.remove('hidden');
        });
        
        // إغلاق نموذج الطلب
        document.getElementById('closeOrderModal').addEventListener('click', () => {
            document.getElementById('orderModal').classList.add('hidden');
        });
        
        document.getElementById('cancelOrderBtn').addEventListener('click', () => {
            document.getElementById('orderModal').classList.add('hidden');
        });
        
        // عرض/إخفاء قسم دفعة العربون
        document.getElementById('orderDepositCheck').addEventListener('change', function() {
            const depositSection = document.getElementById('depositSection');
            
            if (this.checked) {
                depositSection.classList.remove('hidden');
            } else {
                depositSection.classList.add('hidden');
            }
        });
        
        // حساب المبلغ بعد الخصم
        document.getElementById('orderDiscount').addEventListener('input', updateOrderTotal);
        
        function updateOrderTotal() {
            const subtotal = orderItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            const discount = parseFloat(document.getElementById('orderDiscount').value) || 0;
            const total = subtotal * (1 - discount / 100);
            
            document.getElementById('orderSubtotal').textContent = subtotal.toLocaleString() + ' ج.م';
            document.getElementById('orderTotal').textContent = total.toLocaleString() + ' ج.م';
        }
        
        // إضافة بند للطلب
        document.getElementById('addOrderItemBtn').addEventListener('click', () => {
            // إعادة تعيين نموذج البند
            document.getElementById('orderItemForm').reset();
            
            // إظهار النموذج
            document.getElementById('orderItemModal').classList.remove('hidden');
        });
        
        // إغلاق نموذج بند الطلب
        document.getElementById('closeOrderItemModal').addEventListener('click', () => {
            document.getElementById('orderItemModal').classList.add('hidden');
        });
        
        document.getElementById('cancelOrderItemBtn').addEventListener('click', () => {
            document.getElementById('orderItemModal').classList.add('hidden');
        });
        
        // حدث تغيير تصنيف المنتج لتحميل المنتجات المناسبة
        document.getElementById('itemProductCategory').addEventListener('change', function() {
            const category = this.value;
            const nameSelect = document.getElementById('itemProductName');
            
            // إعادة تعيين قوائم المنتج والباتش
            nameSelect.innerHTML = '<option value="">-- اختر المنتج --</option>';
            document.getElementById('itemProductBatch').innerHTML = '<option value="">-- اختر الباتش/اللون --</option>';
            
            // تعطيل الحقول إذا لم يتم اختيار تصنيف
            if (!category) {
                nameSelect.disabled = true;
                document.getElementById('itemProductBatch').disabled = true;
                return;
            }
            
            // تمكين حقل اسم المنتج
            nameSelect.disabled = false;
            
            // الحصول على المنتجات المناسبة لهذا التصنيف
            const categoryProducts = productsList.filter(p => p.category === category);
            
            // إنشاء مجموعة فريدة من أسماء المنتجات
            const uniqueProductNames = [...new Set(categoryProducts.map(p => p.name))];
            
            // إضافة خيارات أسماء المنتجات
            uniqueProductNames.sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                nameSelect.appendChild(option);
            });
        });
        
        // حدث تغيير اسم المنتج لتحميل ألوان/باتشات المنتج
        document.getElementById('itemProductName').addEventListener('change', function() {
            const category = document.getElementById('itemProductCategory').value;
            const productName = this.value;
            const batchSelect = document.getElementById('itemProductBatch');
            
            // إعادة تعيين قائمة الباتش
            batchSelect.innerHTML = '<option value="">-- اختر الباتش/اللون --</option>';
            
            // تعطيل الحقل إذا لم يتم اختيار منتج
            if (!productName) {
                batchSelect.disabled = true;
                return;
            }
            
            // تمكين حقل الباتش/اللون
            batchSelect.disabled = false;
            
            // الحصول على باتشات/ألوان المنتج المحدد
            const productBatches = productsList.filter(p => p.category === category && p.name === productName);
            
            // إضافة خيارات الباتشات/الألوان
            productBatches.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = product.batch;
                option.dataset.price = product.price;
                batchSelect.appendChild(option);
            });
        });
        
        // حدث تغيير باتش/لون المنتج لتحديث السعر
        document.getElementById('itemProductBatch').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            
            if (selectedOption && selectedOption.dataset.price) {
                document.getElementById('itemPrice').value = selectedOption.dataset.price;
                
                // حساب الإجمالي
                calculateItemTotal();
            } else {
                document.getElementById('itemPrice').value = '';
                document.getElementById('itemTotal').value = '';
            }
        });
        
        // حدث تغيير الكمية لإعادة حساب الإجمالي
        document.getElementById('itemQuantity').addEventListener('input', calculateItemTotal);
        
        // حساب إجمالي البند
        function calculateItemTotal() {
            const quantity = parseInt(document.getElementById('itemQuantity').value) || 0;
            const price = parseFloat(document.getElementById('itemPrice').value) || 0;
            
            const total = quantity * price;
            document.getElementById('itemTotal').value = total.toFixed(2);
        }
        
        // إضافة البند إلى الطلب
        document.getElementById('orderItemForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productBatchId = document.getElementById('itemProductBatch').value;
            const quantity = parseInt(document.getElementById('itemQuantity').value) || 0;
            
            if (!productBatchId || quantity <= 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'يرجى ملء جميع الحقول المطلوبة',
                    confirmButtonText: 'حسناً'
                });
                return;
            }
            
            // الحصول على بيانات المنتج المحدد
            const product = productsList.find(p => p.id === productBatchId);
            
            if (!product) {
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'لم يتم العثور على المنتج',
                    confirmButtonText: 'حسناً'
                });
                return;
            }
            
            // إضافة البند إلى قائمة البنود
            const newItem = {
                id: generateUniqueId(),
                productId: product.id,
                categoryName: getCategoryNameArabic(product.category),
                productName: product.name,
                batch: product.batch,
                quantity: quantity,
                price: product.price,
                total: quantity * product.price
            };
            
            orderItems.push(newItem);
            
            // تحديث جدول البنود
            updateOrderItemsTable();
            
            // إعادة حساب إجمالي الطلب
            updateOrderTotal();
            
            // إغلاق النموذج
            document.getElementById('orderItemModal').classList.add('hidden');
        });
        
        // تحديث جدول بنود الطلب
        function updateOrderItemsTable() {
            const tableBody = document.getElementById('orderItemsList');
            
            if (orderItems.length === 0) {
                tableBody.innerHTML = '<tr class="text-center"><td colspan="6" class="py-4">لم يتم إضافة منتجات بعد</td></tr>';
                return;
            }
            
            let rows = '';
            
            orderItems.forEach(item => {
                rows += `
                <tr class="bg-white hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${item.productName} (${item.categoryName})</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${item.batch}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${item.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${item.price} ج.م</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${item.total.toLocaleString()} ج.م</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                        <button type="button" class="text-red-600 hover:text-red-900" onclick="removeOrderItem('${item.id}')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
                `;
            });
            
            tableBody.innerHTML = rows;
        }
        
        // حذف بند من الطلب
        window.removeOrderItem = function(itemId) {
            orderItems = orderItems.filter(item => item.id !== itemId);
            updateOrderItemsTable();
            updateOrderTotal();
        };
        
        // حفظ الطلب
        document.getElementById('orderForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const orderId = document.getElementById('orderId').value;
            const isEditing = !!orderId;
            
            // التحقق من وجود بنود في الطلب
            if (orderItems.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'يجب إضافة منتج واحد على الأقل للطلب',
                    confirmButtonText: 'حسناً'
                });
                return;
            }
            
            // حساب إجمالي المبلغ
            const subtotal = orderItems.reduce((sum, item) => sum + item.total, 0);
            const discount = parseFloat(document.getElementById('orderDiscount').value) || 0;
            const totalAmount = subtotal * (1 - discount / 100);
            
            // إعداد بيانات الطلب
            const orderData = {
                clientId: document.getElementById('orderClient').value,
                orderDate: new Date(document.getElementById('orderDate').value),
                paymentMethod: document.getElementById('orderPaymentMethod').value,
                status: document.getElementById('orderStatus').value,
                subtotal: subtotal,
                discount: discount,
                totalAmount: totalAmount,
                notes: document.getElementById('orderNotes').value,
                updatedAt: new Date()
            };
            
            // إضافة بيانات العربون إذا تم تحديده
            if (document.getElementById('orderDepositCheck').checked) {
                orderData.deposit = {
                    amount: parseFloat(document.getElementById('depositAmount').value) || 0,
                    method: document.getElementById('depositMethod').value
                };
            }
            
            // إضافة توقيت الإنشاء للطلبات الجديدة
            if (!isEditing) {
                orderData.createdAt = new Date();
                orderData.orderNumber = generateOrderNumber();
            }
            
            // البدء في عملية الحفظ باستخدام المعاملات
            db.runTransaction(transaction => {
                // حفظ الطلب
                const orderRef = isEditing ? 
                    db.collection('orders').doc(orderId) : 
                    db.collection('orders').doc();
                
                if (isEditing) {
                    transaction.update(orderRef, orderData);
                    
                    // حذف بنود الطلب القديمة
                    return db.collection('orderItems')
                        .where('orderId', '==', orderId)
                        .get()
                        .then(snapshot => {
                            snapshot.forEach(doc => {
                                transaction.delete(doc.ref);
                            });
                            
                            return orderRef;
                        });
                } else {
                    transaction.set(orderRef, orderData);
                    return Promise.resolve(orderRef);
                }
            })
            .then(orderRef => {
                // حفظ بنود الطلب
                const itemPromises = orderItems.map(item => {
                    const itemData = {
                        orderId: orderRef.id,
                        productId: item.productId,
                        productName: item.productName,
                        batch: item.batch,
                        quantity: item.quantity,
                        unitPrice: item.price,
                        total: item.total,
                        createdAt: new Date()
                    };
                    
                    return db.collection('orderItems').add(itemData);
                });
                
                return Promise.all(itemPromises).then(() => {
                    Swal.fire({
                        icon: 'success',
                        title: isEditing ? 'تم تعديل الطلب بنجاح' : 'تم إنشاء الطلب بنجاح',
                        showConfirmButton: false,
                        timer: 1500
                    });
                    
                    // إغلاق النموذج وتحديث البيانات
                    document.getElementById('orderModal').classList.add('hidden');
                    loadOrdersData();
                    
                    // إذا كان لدينا دفعة عربون، نضيف دفعة
                    if (document.getElementById('orderDepositCheck').checked) {
                        const depositAmount = parseFloat(document.getElementById('depositAmount').value) || 0;
                        
                        if (depositAmount > 0) {
                            const paymentData = {
                                clientId: document.getElementById('orderClient').value,
                                orderId: orderRef.id,
                                amount: depositAmount,
                                method: document.getElementById('depositMethod').value,
                                date: new Date(),
                                notes: 'دفعة عربون للطلب رقم ' + (orderData.orderNumber || orderRef.id.substr(0, 8)),
                                createdAt: new Date()
                            };
                            
                            db.collection('payments').add(paymentData)
                                .then(() => {
                                    console.log('تم تسجيل دفعة العربون بنجاح');
                                    loadPaymentsData();
                                })
                                .catch(error => {
                                    console.error('خطأ في تسجيل دفعة العربون:', error);
                                });
                        }
                    }
                });
            })
            .catch(error => {
                console.error('خطأ في حفظ الطلب:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'حدث خطأ أثناء حفظ الطلب',
                    confirmButtonText: 'حسناً'
                });
            });
        });
        
        // تعديل طلب
        function editOrder(orderId) {
            // إعادة تعيين النموذج وبنود الطلب
            document.getElementById('orderForm').reset();
            document.getElementById('orderId').value = orderId;
            document.getElementById('orderModalTitle').textContent = 'تعديل الطلب';
            
            // إعادة تعيين قائمة البنود
            orderItems = [];
            
            // تحميل بيانات الطلب
            db.collection('orders').doc(orderId).get()
                .then(doc => {
                    if (doc.exists) {
                        const order = doc.data();
                        
                        // ملء النموذج بالبيانات
                        document.getElementById('orderClient').value = order.clientId;
                        
                        // تنسيق التاريخ
                        if (order.orderDate) {
                            const orderDate = order.orderDate.toDate ? order.orderDate.toDate() : new Date(order.orderDate);
                            document.getElementById('orderDate').valueAsDate = orderDate;
                        }
                        
                        document.getElementById('orderPaymentMethod').value = order.paymentMethod;
                        document.getElementById('orderStatus').value = order.status;
                        document.getElementById('orderDiscount').value = order.discount || 0;
                        document.getElementById('orderNotes').value = order.notes || '';
                        
                        // إعداد قسم العربون
                        if (order.deposit) {
                            document.getElementById('orderDepositCheck').checked = true;
                            document.getElementById('depositSection').classList.remove('hidden');
                            document.getElementById('depositAmount').value = order.deposit.amount || 0;
                            document.getElementById('depositMethod').value = order.deposit.method || 'cash';
                        } else {
                            document.getElementById('orderDepositCheck').checked = false;
                            document.getElementById('depositSection').classList.add('hidden');
                        }
                        
                        // تحميل بنود الطلب
                        return db.collection('orderItems').where('orderId', '==', orderId).get();
                    } else {
                        throw new Error('لم يتم العثور على الطلب');
                    }
                })
                .then(snapshot => {
                    // جمع البنود من Firestore وإضافتها إلى قائمة البنود المحلية
                    const itemPromises = [];
                    
                    snapshot.forEach(doc => {
                        const item = doc.data();
                        
                        // الحصول على تفاصيل المنتج
                        itemPromises.push(
                            db.collection('products').doc(item.productId).get()
                                .then(productDoc => {
                                    if (productDoc.exists) {
                                        const product = productDoc.data();
                                        
                                        orderItems.push({
                                            id: doc.id,
                                            productId: item.productId,
                                            categoryName: getCategoryNameArabic(product.category),
                                            productName: item.productName,
                                            batch: item.batch,
                                            quantity: item.quantity,
                                            price: item.unitPrice,
                                            total: item.total
                                        });
                                    }
                                })
                        );
                    });
                    
                    return Promise.all(itemPromises);
                })
                .then(() => {
                    // تحديث جدول البنود وإجمالي الطلب
                    updateOrderItemsTable();
                    updateOrderTotal();
                    
                    // إظهار النموذج
                    document.getElementById('orderModal').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('خطأ في تحميل بيانات الطلب:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'خطأ',
                        text: 'حدث خطأ أثناء تحميل بيانات الطلب: ' + error.message,
                        confirmButtonText: 'حسناً'
                    });
                });
        }
        
        // عرض تفاصيل الطلب
        function viewOrder(orderId) {
            // تحميل بيانات الطلب
            db.collection('orders').doc(orderId).get()
                .then(doc => {
                    if (doc.exists) {
                        const order = doc.data();
                        
                        // الحصول على بيانات العميل
                        return db.collection('clients').doc(order.clientId).get()
                            .then(clientDoc => {
                                const client = clientDoc.exists ? clientDoc.data() : { name: 'عميل غير معروف' };
                                
                                // الحصول على بنود الطلب
                                return db.collection('orderItems').where('orderId', '==', orderId).get()
                                    .then(itemsSnapshot => {
                                        const items = [];
                                        itemsSnapshot.forEach(itemDoc => {
                                            items.push(itemDoc.data());
                                        });
                                        
                                        // تنسيق التاريخ
                                        const orderDate = order.orderDate ? 
                                            new Date(order.orderDate.seconds ? order.orderDate.seconds * 1000 : order.orderDate).toLocaleDateString('ar') : 
                                            '-';
                                        
                                        // إنشاء محتوى العرض
                                        let itemsHtml = '';
                                        items.forEach(item => {
                                            itemsHtml += `
                                            <tr>
                                                <td>${item.productName}</td>
                                                <td>${item.batch}</td>
                                                <td>${item.quantity}</td>
                                                <td>${item.unitPrice} ج.م</td>
                                                <td>${item.total.toLocaleString()} ج.م</td>
                                            </tr>
                                            `;
                                        });
                                        
                                        // إظهار تفاصيل الطلب في نافذة منبثقة
                                        Swal.fire({
                                            title: `تفاصيل الطلب رقم ${order.orderNumber || orderId.substr(0, 8)}`,
                                            html: `
                                            <div class="text-right p-4">
                                                <div class="grid grid-cols-2 gap-4 mb-4">
                                                    <div>
                                                        <p><strong>العميل:</strong> ${client.name}</p>
                                                        <p><strong>التاريخ:</strong> ${orderDate}</p>
                                                    </div>
                                                    <div>
                                                        <p><strong>حالة الطلب:</strong> ${getOrderStatusText(order.status)}</p>
                                                        <p><strong>طريقة الدفع:</strong> ${getPaymentMethodText(order.paymentMethod)}</p>
                                                    </div>
                                                </div>
                                                
                                                <div class="overflow-x-auto">
                                                    <table class="min-w-full divide-y divide-gray-200">
                                                        <thead>
                                                            <tr>
                                                                <th class="px-4 py-2 text-right">المنتج</th>
                                                                <th class="px-4 py-2 text-right">الباتش/اللون</th>
                                                                <th class="px-4 py-2 text-right">الكمية</th>
                                                                <th class="px-4 py-2 text-right">السعر</th>
                                                                <th class="px-4 py-2 text-right">الإجمالي</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody class="divide-y divide-gray-200">
                                                            ${itemsHtml}
                                                        </tbody>
                                                        <tfoot>
                                                            <tr>
                                                                <td colspan="4" class="text-left font-bold px-4 py-2">المجموع</td>
                                                                <td class="px-4 py-2">${order.subtotal.toLocaleString()} ج.م</td>
                                                            </tr>
                                                            <tr>
                                                                <td colspan="4" class="text-left px-4 py-2">الخصم</td>
                                                                <td class="px-4 py-2">${order.discount || 0}%</td>
                                                            </tr>
                                                            <tr>
                                                                <td colspan="4" class="text-left font-bold px-4 py-2">المبلغ بعد الخصم</td>
                                                                <td class="px-4 py-2 font-bold">${order.totalAmount.toLocaleString()} ج.م</td>
                                                            </tr>
                                                        </tfoot>
                                                    </table>
                                                </div>
                                                
                                                ${order.notes ? `<div class="mt-4"><strong>ملاحظات:</strong> ${order.notes}</div>` : ''}
                                                
                                                ${order.deposit ? `
                                                <div class="mt-4 p-2 bg-blue-50 rounded">
                                                    <strong>دفعة عربون:</strong> ${order.deposit.amount.toLocaleString()} ج.م
                                                    (${getPaymentMethodText(order.deposit.method)})
                                                </div>
                                                ` : ''}
                                            </div>
                                            `,
                                            width: '800px',
                                            confirmButtonText: 'إغلاق'
                                        });
                                    });
                            });
                    } else {
                        throw new Error('لم يتم العثور على الطلب');
                    }
                })
                .catch(error => {
                    console.error('خطأ في تحميل تفاصيل الطلب:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'خطأ',
                        text: 'حدث خطأ أثناء تحميل تفاصيل الطلب: ' + error.message,
                        confirmButtonText: 'حسناً'
                    });
                });
        }
        
        // طباعة فاتورة الطلب
        function printOrderInvoice(orderId) {
            // تحميل بيانات الطلب
            db.collection('orders').doc(orderId).get()
                .then(doc => {
                    if (doc.exists) {
                        const order = doc.data();
                        
                        // الحصول على بيانات العميل
                        return db.collection('clients').doc(order.clientId).get()
                            .then(clientDoc => {
                                const client = clientDoc.exists ? clientDoc.data() : { name: 'عميل غير معروف' };
                                
                                // الحصول على بنود الطلب
                                return db.collection('orderItems').where('orderId', '==', orderId).get()
                                    .then(itemsSnapshot => {
                                        const items = [];
                                        itemsSnapshot.forEach(itemDoc => {
                                            items.push(itemDoc.data());
                                        });
                                        
                                        // تنسيق التاريخ
                                        const orderDate = order.orderDate ? 
                                            new Date(order.orderDate.seconds ? order.orderDate.seconds * 1000 : order.orderDate).toLocaleDateString('ar') : 
                                            new Date().toLocaleDateString('ar');
                                        
                                        // إنشاء PDF
                                        const { jsPDF } = window.jspdf;
                                        const doc = new jsPDF({
                                            orientation: 'portrait',
                                            unit: 'mm',
                                            format: 'a4'
                                        });
                                        
                                        // إضافة دعم الخط العربي
                                        doc.setFont('Arial', 'normal');
                                        
                                        // إضافة ترويسة
                                        doc.setFontSize(22);
                                        doc.text('شركة الدهانات', 105, 20, { align: 'center' });
                                        
                                        doc.setFontSize(16);
                                        doc.text('فاتورة مبيعات', 105, 30, { align: 'center' });
                                        
                                        // معلومات الفاتورة
                                        doc.setFontSize(12);
                                        doc.text(`رقم الفاتورة: ${order.orderNumber || orderId.substr(0, 8)}`, 200, 40, { align: 'right' });
                                        doc.text(`التاريخ: ${orderDate}`, 200, 50, { align: 'right' });
                                        
                                        // معلومات العميل
                                        doc.text(`العميل: ${client.name}`, 200, 60, { align: 'right' });
                                        doc.text(`الهاتف: ${client.phone || '-'}`, 200, 70, { align: 'right' });
                                        doc.text(`العنوان: ${client.address || '-'}`, 200, 80, { align: 'right' });
                                        
                                        // جدول المنتجات
                                        const tableColumn = ['الإجمالي', 'السعر', 'الكمية', 'الباتش/اللون', 'المنتج'];
                                        const tableRows = [];
                                        
                                        items.forEach(item => {
                                            const itemData = [
                                                item.total.toLocaleString() + ' ج.م',
                                                item.unitPrice + ' ج.م',
                                                item.quantity,
                                                item.batch,
                                                item.productName
                                            ];
                                            tableRows.push(itemData);
                                        });
                                        
                                        doc.autoTable({
                                            head: [tableColumn],
                                            body: tableRows,
                                            startY: 90,
                                            styles: { font: 'Arial', halign: 'right' },
                                            headStyles: { fillColor: [93, 92, 222], textColor: 255 },
                                            alternateRowStyles: { fillColor: [240, 240, 255] },
                                            columnStyles: {
                                                0: { halign: 'center' },
                                                1: { halign: 'center' },
                                                2: { halign: 'center' }
                                            },
                                            margin: { right: 15, left: 15 }
                                        });
                                        
                                        // الملخص
                                        const finalY = doc.lastAutoTable.finalY + 10;
                                        
                                        doc.text(`المجموع: ${order.subtotal.toLocaleString()} ج.م`, 200, finalY, { align: 'right' });
                                        doc.text(`الخصم: ${order.discount || 0}%`, 200, finalY + 10, { align: 'right' });
                                        doc.text(`المبلغ بعد الخصم: ${order.totalAmount.toLocaleString()} ج.م`, 200, finalY + 20, { align: 'right' });
                                        
                                        if (order.deposit) {
                                            doc.text(`دفعة عربون: ${order.deposit.amount.toLocaleString()} ج.م (${getPaymentMethodText(order.deposit.method)})`, 200, finalY + 30, { align: 'right' });
                                        }
                                        
                                        // الملاحظات
                                        if (order.notes) {
                                            doc.text(`ملاحظات: ${order.notes}`, 200, finalY + (order.deposit ? 40 : 30), { align: 'right' });
                                        }
                                        
                                        // التذييل
                                        const pageCount = doc.internal.getNumberOfPages();
                                        for (let i = 1; i <= pageCount; i++) {
                                            doc.setPage(i);
                                            doc.setFontSize(10);
                                            doc.text('شركة الدهانات - جميع الحقوق محفوظة © ' + new Date().getFullYear(), 105, 287, { align: 'center' });
                                            doc.text(`صفحة ${i} من ${pageCount}`, 200, 287, { align: 'right' });
                                        }
                                        
                                        // فتح الفاتورة في نافذة جديدة للطباعة
                                        doc.output('dataurlnewwindow');
                                    });
                            });
                    } else {
                        throw new Error('لم يتم العثور على الطلب');
                    }
                })
                .catch(error => {
                    console.error('خطأ في طباعة الفاتورة:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'خطأ',
                        text: 'حدث خطأ أثناء طباعة الفاتورة: ' + error.message,
                        confirmButtonText: 'حسناً'
                    });
                });
        }
        
        // حذف طلب
        function deleteOrder(orderId) {
            Swal.fire({
                title: 'هل أنت متأكد؟',
                text: "سيتم حذف الطلب وجميع بنوده نهائيًا!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'نعم، حذف',
                cancelButtonText: 'إلغاء'
            }).then((result) => {
                if (result.isConfirmed) {
                    // التحقق من وجود مدفوعات مرتبطة بالطلب
                    db.collection('payments').where('orderId', '==', orderId).limit(1).get()
                        .then(paymentSnapshot => {
                            if (!paymentSnapshot.empty) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'لا يمكن الحذف',
                                    text: 'لا يمكن حذف الطلب لوجود مدفوعات مرتبطة به',
                                    confirmButtonText: 'حسناً'
                                });
                                return;
                            }
                            
                            // التحقق من وجود مرتجعات مرتبطة بالطلب
                            db.collection('returns').where('orderId', '==', orderId).limit(1).get()
                                .then(returnSnapshot => {
                                    if (!returnSnapshot.empty) {
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'لا يمكن الحذف',
                                            text: 'لا يمكن حذف الطلب لوجود مرتجعات مرتبطة به',
                                            confirmButtonText: 'حسناً'
                                        });
                                        return;
                                    }
                                    
                                    // حذف بنود الطلب أولاً
                                    db.collection('orderItems').where('orderId', '==', orderId).get()
                                        .then
